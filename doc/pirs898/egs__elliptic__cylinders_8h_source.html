<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>EGSnrc C++ class library: /home/ftessier/EGSnrc/github/EGSnrc-doc/HEN_HOUSE/egs++/geometry/egs_elliptic_cylinders/egs_elliptic_cylinders.h Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.3 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">EGSnrc C++ class library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>/home/ftessier/EGSnrc/github/EGSnrc-doc/HEN_HOUSE/egs++/geometry/egs_elliptic_cylinders/egs_elliptic_cylinders.h</h1>  </div>
</div>
<div class="contents">
<div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment">###############################################################################</span>
<a name="l00003"></a>00003 <span class="comment">#</span>
<a name="l00004"></a>00004 <span class="comment">#  EGSnrc egs++ elliptic cylinders geometry headers</span>
<a name="l00005"></a>00005 <span class="comment">#  Copyright (C) 2015 National Research Council Canada</span>
<a name="l00006"></a>00006 <span class="comment">#</span>
<a name="l00007"></a>00007 <span class="comment">#  This file is part of EGSnrc.</span>
<a name="l00008"></a>00008 <span class="comment">#</span>
<a name="l00009"></a>00009 <span class="comment">#  EGSnrc is free software: you can redistribute it and/or modify it under</span>
<a name="l00010"></a>00010 <span class="comment">#  the terms of the GNU Affero General Public License as published by the</span>
<a name="l00011"></a>00011 <span class="comment">#  Free Software Foundation, either version 3 of the License, or (at your</span>
<a name="l00012"></a>00012 <span class="comment">#  option) any later version.</span>
<a name="l00013"></a>00013 <span class="comment">#</span>
<a name="l00014"></a>00014 <span class="comment">#  EGSnrc is distributed in the hope that it will be useful, but WITHOUT ANY</span>
<a name="l00015"></a>00015 <span class="comment">#  WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</span>
<a name="l00016"></a>00016 <span class="comment">#  FOR A PARTICULAR PURPOSE.  See the GNU Affero General Public License for</span>
<a name="l00017"></a>00017 <span class="comment">#  more details.</span>
<a name="l00018"></a>00018 <span class="comment">#</span>
<a name="l00019"></a>00019 <span class="comment">#  You should have received a copy of the GNU Affero General Public License</span>
<a name="l00020"></a>00020 <span class="comment">#  along with EGSnrc. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<a name="l00021"></a>00021 <span class="comment">#</span>
<a name="l00022"></a>00022 <span class="comment">###############################################################################</span>
<a name="l00023"></a>00023 <span class="comment">#</span>
<a name="l00024"></a>00024 <span class="comment">#  Author:          Iwan Kawrakow, 2006</span>
<a name="l00025"></a>00025 <span class="comment">#</span>
<a name="l00026"></a>00026 <span class="comment">#  Contributors:</span>
<a name="l00027"></a>00027 <span class="comment">#</span>
<a name="l00028"></a>00028 <span class="comment">###############################################################################</span>
<a name="l00029"></a>00029 <span class="comment">#</span>
<a name="l00030"></a>00030 <span class="comment">#  A first version of a set of elliptic cylinders. Already works in the</span>
<a name="l00031"></a>00031 <span class="comment">#  geometry viewer, but still need to run it through the geometry tester. The</span>
<a name="l00032"></a>00032 <span class="comment">#  hard part for that type of geometry is hownear() (requires to solve a 4&#39;th</span>
<a name="l00033"></a>00033 <span class="comment">#  order equation).</span>
<a name="l00034"></a>00034 <span class="comment">#</span>
<a name="l00035"></a>00035 <span class="comment">###############################################################################</span>
<a name="l00036"></a>00036 <span class="comment">*/</span>
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 
<a name="l00044"></a>00044 <span class="preprocessor">#ifndef EGS_CYLINDERS_</span>
<a name="l00045"></a>00045 <span class="preprocessor"></span><span class="preprocessor">#define EGS_CYLINDERS_</span>
<a name="l00046"></a>00046 <span class="preprocessor"></span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;egs_base_geometry.h&quot;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;egs_math.h&quot;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;egs_functions.h&quot;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;egs_projectors.h&quot;</span>
<a name="l00051"></a>00051 
<a name="l00052"></a>00052 <span class="preprocessor">#include &lt;vector&gt;</span>
<a name="l00053"></a>00053 <span class="keyword">using namespace </span>std;
<a name="l00054"></a>00054 
<a name="l00055"></a>00055 <span class="preprocessor">#ifdef WIN32</span>
<a name="l00056"></a>00056 <span class="preprocessor"></span>
<a name="l00057"></a>00057 <span class="preprocessor">#ifdef BUILD_ELLIPTIC_CYLINDERS_DLL</span>
<a name="l00058"></a>00058 <span class="preprocessor"></span><span class="preprocessor">#define EGS_ELLIPTIC_CYLINDERS_EXPORT __declspec(dllexport)</span>
<a name="l00059"></a>00059 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00060"></a>00060 <span class="preprocessor"></span><span class="preprocessor">#define EGS_ELLIPTIC_CYLINDERS_EXPORT __declspec(dllimport)</span>
<a name="l00061"></a>00061 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00062"></a>00062 <span class="preprocessor"></span><span class="preprocessor">#define EGS_ELLIPTIC_CYLINDERS_LOCAL</span>
<a name="l00063"></a>00063 <span class="preprocessor"></span>
<a name="l00064"></a>00064 <span class="preprocessor">#else</span>
<a name="l00065"></a>00065 <span class="preprocessor"></span>
<a name="l00066"></a>00066 <span class="preprocessor">#ifdef HAVE_VISIBILITY</span>
<a name="l00067"></a>00067 <span class="preprocessor"></span><span class="preprocessor">#define EGS_ELLIPTIC_CYLINDERS_EXPORT __attribute__ ((visibility (&quot;default&quot;)))</span>
<a name="l00068"></a>00068 <span class="preprocessor"></span><span class="preprocessor">#define EGS_ELLIPTIC_CYLINDERS_LOCAL  __attribute__ ((visibility (&quot;hidden&quot;)))</span>
<a name="l00069"></a>00069 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00070"></a>00070 <span class="preprocessor"></span><span class="preprocessor">#define EGS_ELLIPTIC_CYLINDERS_EXPORT</span>
<a name="l00071"></a>00071 <span class="preprocessor"></span><span class="preprocessor">#define EGS_ELLIPTIC_CYLINDERS_LOCAL</span>
<a name="l00072"></a>00072 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00073"></a>00073 <span class="preprocessor"></span>
<a name="l00074"></a>00074 <span class="preprocessor">#endif</span>
<a name="l00075"></a>00075 <span class="preprocessor"></span>
<a name="l00118"></a>00118 <span class="keyword">template</span> &lt;<span class="keyword">class</span> Tx, <span class="keyword">class</span> Ty&gt;
<a name="l00119"></a><a class="code" href="classEGS__EllipticCylindersT.html">00119</a> <span class="keyword">class </span>EGS_ELLIPTIC_CYLINDERS_EXPORT <a class="code" href="classEGS__EllipticCylindersT.html" title="A set of concentric elliptic cylinders.">EGS_EllipticCylindersT</a> :
<a name="l00120"></a>00120       <span class="keyword">public</span> <a class="code" href="classEGS__BaseGeometry.html">EGS_BaseGeometry</a> {
<a name="l00121"></a>00121 
<a name="l00122"></a>00122 <span class="keyword">protected</span>:
<a name="l00123"></a>00123 
<a name="l00124"></a><a class="code" href="classEGS__EllipticCylindersT.html#a7db164c19bf51e80f5f3162e6922c8d6">00124</a>     EGS_Float *ax,  
<a name="l00125"></a>00125               *ay,  
<a name="l00126"></a>00126               *axi, 
<a name="l00127"></a>00127               *ayi, 
<a name="l00128"></a>00128               *sx,  
<a name="l00129"></a>00129               *<a class="code" href="classEGS__EllipticCylindersT.html#a7db164c19bf51e80f5f3162e6922c8d6" title="Used for hownear calculations.">sy</a>;  
<a name="l00130"></a><a class="code" href="classEGS__EllipticCylindersT.html#aadb3f509c38a5d86085ab900f2c49db3">00130</a>     <span class="keywordtype">bool</span>  *<a class="code" href="classEGS__EllipticCylindersT.html#aadb3f509c38a5d86085ab900f2c49db3" title="True if the two radii are equal.">is_cyl</a>;  
<a name="l00131"></a><a class="code" href="classEGS__EllipticCylindersT.html#a38d00408e7d3663cfeae09fe48611511">00131</a>     <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> <a class="code" href="classEGS__EllipticCylindersT.html#a38d00408e7d3663cfeae09fe48611511" title="A point on the cylinder axis.">xo</a>;  
<a name="l00132"></a><a class="code" href="classEGS__EllipticCylindersT.html#a7f69862a56eb248596ded5754a4764a5">00132</a>     Tx <a class="code" href="classEGS__EllipticCylindersT.html#a7f69862a56eb248596ded5754a4764a5" title="The projection operator for the first (&amp;#39;x&amp;#39;) axis.">Ax</a>;          
<a name="l00133"></a><a class="code" href="classEGS__EllipticCylindersT.html#ae188ee150ad08610919de4e02dd57dcd">00133</a>     Ty <a class="code" href="classEGS__EllipticCylindersT.html#ae188ee150ad08610919de4e02dd57dcd" title="The projection operator for the second (&amp;#39;y&amp;#39;) axis.">Ay</a>;          
<a name="l00134"></a><a class="code" href="classEGS__EllipticCylindersT.html#aa86726e11179574e4015124990d79311">00134</a>     <span class="keywordtype">string</span> <a class="code" href="classEGS__EllipticCylindersT.html#aa86726e11179574e4015124990d79311" title="The cylinder type.">mytype</a>;  
<a name="l00135"></a>00135     <span class="keywordtype">int</span>    nwarn;
<a name="l00136"></a>00136 
<a name="l00137"></a>00137 <span class="keyword">public</span>:
<a name="l00138"></a>00138 
<a name="l00143"></a><a class="code" href="classEGS__EllipticCylindersT.html#a75adc1efeacae55b293203937d9932e2">00143</a>     <a class="code" href="classEGS__EllipticCylindersT.html#a75adc1efeacae55b293203937d9932e2" title="Desctructor.">~EGS_EllipticCylindersT</a>() {
<a name="l00144"></a>00144         <span class="keywordflow">if</span>(nreg &gt; 0) {
<a name="l00145"></a>00145             <span class="keyword">delete</span> [] ax; <span class="keyword">delete</span> [] axi;
<a name="l00146"></a>00146             <span class="keyword">delete</span> [] ay; <span class="keyword">delete</span> [] ayi;
<a name="l00147"></a>00147             <span class="keyword">delete</span> [] sx; <span class="keyword">delete</span> [] sy;
<a name="l00148"></a>00148             <span class="keyword">delete</span> [] is_cyl;
<a name="l00149"></a>00149         }
<a name="l00150"></a>00150     };
<a name="l00151"></a>00151 
<a name="l00160"></a><a class="code" href="classEGS__EllipticCylindersT.html#adb8241ee06daa81aaf3d59c99d729d9e">00160</a>     <a class="code" href="classEGS__EllipticCylindersT.html" title="A set of concentric elliptic cylinders.">EGS_EllipticCylindersT</a>(<span class="keywordtype">int</span> nc, <span class="keyword">const</span> EGS_Float *x_rad,
<a name="l00161"></a>00161                    <span class="keyword">const</span> EGS_Float *y_rad,
<a name="l00162"></a>00162                    <span class="keyword">const</span> <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> &amp;position, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp;Name,
<a name="l00163"></a>00163                    <span class="keyword">const</span> Tx &amp;A_x, <span class="keyword">const</span> Ty &amp;A_y) : <a class="code" href="classEGS__BaseGeometry.html">EGS_BaseGeometry</a>(Name),
<a name="l00164"></a>00164                    Ax(A_x), Ay(A_y), xo(position), nwarn(0) {
<a name="l00165"></a>00165         <span class="keywordflow">if</span>(nc&gt;0) {
<a name="l00166"></a>00166             ax = <span class="keyword">new</span> EGS_Float [nc]; axi = <span class="keyword">new</span> EGS_Float [nc];
<a name="l00167"></a>00167             ay = <span class="keyword">new</span> EGS_Float [nc]; ayi = <span class="keyword">new</span> EGS_Float [nc];
<a name="l00168"></a>00168             sx = <span class="keyword">new</span> EGS_Float [nc]; sy = <span class="keyword">new</span> EGS_Float [nc];
<a name="l00169"></a>00169             is_cyl = <span class="keyword">new</span> <span class="keywordtype">bool</span> [nc];
<a name="l00170"></a>00170             <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;nc;i++) {
<a name="l00171"></a>00171                 ax[i]=x_rad[i]; axi[i] = 1/ax[i];
<a name="l00172"></a>00172                 ay[i]=y_rad[i]; ayi[i] = 1/ay[i];
<a name="l00173"></a>00173                 EGS_Float z = ay[i]/ax[i];
<a name="l00174"></a>00174                 <span class="keywordflow">if</span>( fabs(z-1) &gt; 1e-4 ) {
<a name="l00175"></a>00175                     sx[i] = 1/(z*z-1)/ax[i]; sy[i] = z*sx[i];
<a name="l00176"></a>00176                     is_cyl[i] = <span class="keyword">false</span>;
<a name="l00177"></a>00177                 } <span class="keywordflow">else</span> is_cyl[i] = <span class="keyword">true</span>;
<a name="l00178"></a>00178             }
<a name="l00179"></a>00179             nreg=nc;
<a name="l00180"></a>00180         }
<a name="l00181"></a>00181         mytype = Ax.getType() + Ay.getType();
<a name="l00182"></a>00182     };
<a name="l00183"></a>00183 
<a name="l00185"></a><a class="code" href="classEGS__EllipticCylindersT.html#ac294da20eba5682cd864e4381c3644fb">00185</a>     <a class="code" href="classEGS__EllipticCylindersT.html" title="A set of concentric elliptic cylinders.">EGS_EllipticCylindersT</a>(<span class="keyword">const</span> vector&lt;EGS_Float&gt; &amp;x_rad,
<a name="l00186"></a>00186                            <span class="keyword">const</span> vector&lt;EGS_Float&gt; &amp;y_rad,
<a name="l00187"></a>00187                    <span class="keyword">const</span> <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> &amp;position, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp;Name,
<a name="l00188"></a>00188                    <span class="keyword">const</span> Tx &amp;A_x, <span class="keyword">const</span> Ty &amp;A_y) : <a class="code" href="classEGS__BaseGeometry.html">EGS_BaseGeometry</a>(Name),
<a name="l00189"></a>00189                    Ax(A_x), Ay(A_y), xo(position), nwarn(0) {
<a name="l00190"></a>00190         <span class="keywordtype">int</span> nc = x_rad.size();
<a name="l00191"></a>00191         <span class="keywordflow">if</span>(nc&gt;0) {
<a name="l00192"></a>00192             ax = <span class="keyword">new</span> EGS_Float [nc]; axi = <span class="keyword">new</span> EGS_Float [nc];
<a name="l00193"></a>00193             ay = <span class="keyword">new</span> EGS_Float [nc]; ayi = <span class="keyword">new</span> EGS_Float [nc];
<a name="l00194"></a>00194             sx = <span class="keyword">new</span> EGS_Float [nc]; sy = <span class="keyword">new</span> EGS_Float [nc];
<a name="l00195"></a>00195             is_cyl = <span class="keyword">new</span> <span class="keywordtype">bool</span> [nc];
<a name="l00196"></a>00196             <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;nc;i++) {
<a name="l00197"></a>00197                 ax[i]=x_rad[i]; axi[i] = 1/ax[i];
<a name="l00198"></a>00198                 ay[i]=y_rad[i]; ayi[i] = 1/ay[i];
<a name="l00199"></a>00199                 EGS_Float z = ay[i]/ax[i];
<a name="l00200"></a>00200                 <span class="keywordflow">if</span>( fabs(z-1) &gt; 1e-4 ) {
<a name="l00201"></a>00201                     sx[i] = 1/(z*z-1)/ax[i]; sy[i] = z*sx[i];
<a name="l00202"></a>00202                     is_cyl[i] = <span class="keyword">false</span>;
<a name="l00203"></a>00203                 } <span class="keywordflow">else</span> is_cyl[i] = <span class="keyword">true</span>;
<a name="l00204"></a>00204             }
<a name="l00205"></a>00205             nreg=nc;
<a name="l00206"></a>00206         }
<a name="l00207"></a>00207         mytype = Ax.getType() + Ay.getType();
<a name="l00208"></a>00208     };
<a name="l00209"></a>00209 
<a name="l00210"></a>00210     <span class="keywordtype">bool</span> isInside(<span class="keyword">const</span> <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> &amp;x) {
<a name="l00211"></a>00211         <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> rc(x-xo);
<a name="l00212"></a>00212         EGS_Float rx = Ax*rc*axi[nreg-1], ry = Ay*rc*ayi[nreg-1];
<a name="l00213"></a>00213         <span class="keywordflow">return</span> rx*rx + ry*ry &lt;= 1 ? <span class="keyword">true</span> : <span class="keyword">false</span>;
<a name="l00214"></a>00214     };
<a name="l00215"></a>00215 
<a name="l00216"></a>00216     <span class="keywordtype">int</span> isWhere(<span class="keyword">const</span> <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> &amp;x) {
<a name="l00217"></a>00217         <span class="keywordflow">if</span>( !isInside(x) ) <span class="keywordflow">return</span> -1;
<a name="l00218"></a>00218         <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> rc(x-xo);
<a name="l00219"></a>00219         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0; j&lt;nreg-1; j++) {
<a name="l00220"></a>00220             EGS_Float rx = Ax*rc*axi[j], ry = Ay*rc*ayi[j];
<a name="l00221"></a>00221             <span class="keywordflow">if</span>( rx*rx + ry*ry &lt;= 1 ) <span class="keywordflow">return</span> j;
<a name="l00222"></a>00222         }
<a name="l00223"></a>00223         <span class="keywordflow">return</span> nreg-1;
<a name="l00224"></a>00224     };
<a name="l00225"></a>00225 
<a name="l00226"></a>00226     <span class="keywordtype">int</span> inside(<span class="keyword">const</span> <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> &amp;x) { <span class="keywordflow">return</span> isWhere(x); };
<a name="l00227"></a>00227 
<a name="l00228"></a>00228     <span class="keywordtype">int</span> howfar(<span class="keywordtype">int</span> ireg, <span class="keyword">const</span> <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> &amp;x, <span class="keyword">const</span> <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> &amp;u,
<a name="l00229"></a>00229             EGS_Float &amp;t, <span class="keywordtype">int</span> *newmed = 0, <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> *normal = 0) {
<a name="l00230"></a>00230 
<a name="l00231"></a>00231         <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> xp(x-xo);
<a name="l00232"></a>00232         <span class="keywordtype">int</span> inew = ireg; <span class="keywordtype">int</span> iold = inew &lt; 0 ? nreg : ireg;
<a name="l00233"></a>00233         <span class="keywordtype">int</span> ihit = ireg;
<a name="l00234"></a>00234         <span class="keywordflow">if</span>( ireg &lt; 0 || ireg &gt; 0 ) {
<a name="l00235"></a>00235             <span class="comment">// Particle is outside or inside but not in the inner-most</span>
<a name="l00236"></a>00236             <span class="comment">// cylinder. Check for intersection with an inner cylinder.</span>
<a name="l00237"></a>00237             <span class="keywordtype">int</span> n = iold-1;
<a name="l00238"></a>00238             EGS_Float ux = Ax*u*axi[n], uy = Ay*u*ayi[n];
<a name="l00239"></a>00239             EGS_Float u2 = ux*ux + uy*uy;
<a name="l00240"></a>00240             <span class="keywordflow">if</span>( u2 &gt; 0 ) {
<a name="l00241"></a>00241                 EGS_Float xx = Ax*xp*axi[n], xy = Ay*xp*ayi[n];
<a name="l00242"></a>00242                 EGS_Float xu = xx*ux + xy*uy;
<a name="l00243"></a>00243                 <span class="keywordflow">if</span>( xu &lt; 0 ) {
<a name="l00244"></a>00244                     EGS_Float r2 = xx*xx + xy*xy - 1;
<a name="l00245"></a>00245                     <span class="keywordflow">if</span>( r2 &gt; 0 ) {
<a name="l00246"></a>00246                         EGS_Float D = xu*xu - r2*u2;
<a name="l00247"></a>00247                         <span class="keywordflow">if</span>( D &gt;= 0 ) {
<a name="l00248"></a>00248                             EGS_Float d = r2/(sqrt(D) - xu);
<a name="l00249"></a>00249                             <span class="keywordflow">if</span>( d &lt;= t ) { t = d; inew = n; ihit = inew; }
<a name="l00250"></a>00250                         }
<a name="l00251"></a>00251                     }
<a name="l00252"></a>00252                     <span class="keywordflow">else</span> { t = 0; inew = n; ihit = inew; }
<a name="l00253"></a>00253                 }
<a name="l00254"></a>00254             }
<a name="l00255"></a>00255         }
<a name="l00256"></a>00256 
<a name="l00257"></a>00257         <span class="keywordflow">if</span>( ireg &gt;= 0 &amp;&amp; t &gt; 0 ) {
<a name="l00258"></a>00258             <span class="comment">// If here, particle is inside. Check for intersection with</span>
<a name="l00259"></a>00259             <span class="comment">// the cylinder the particle is in.</span>
<a name="l00260"></a>00260             EGS_Float ux = Ax*u*axi[ireg], uy = Ay*u*ayi[ireg];
<a name="l00261"></a>00261             EGS_Float u2 = ux*ux + uy*uy;
<a name="l00262"></a>00262             <span class="keywordflow">if</span>( u2 &gt; 0 ) {
<a name="l00263"></a>00263                 EGS_Float xx = Ax*xp*axi[ireg], xy = Ay*xp*ayi[ireg];
<a name="l00264"></a>00264                 EGS_Float xu = xx*ux + xy*uy;
<a name="l00265"></a>00265                 EGS_Float r2 = xx*xx + xy*xy - 1;
<a name="l00266"></a>00266                 EGS_Float d = 1e30;
<a name="l00267"></a>00267                 <span class="keywordflow">if</span>( r2 &gt;= 0 ) {
<a name="l00268"></a>00268                     <span class="comment">// we think we are inside but the math shows we are</span>
<a name="l00269"></a>00269                     <span class="comment">// outside. Hopefully a truncation problem.</span>
<a name="l00270"></a>00270                     <span class="keywordflow">if</span>( xu &gt; 0 ) <span class="comment">// moving outwards.</span>
<a name="l00271"></a>00271                         d = 0;
<a name="l00272"></a>00272                     <span class="keywordflow">else</span> {
<a name="l00273"></a>00273                         <span class="comment">// moving inwards =&gt; assume we are at the boundary</span>
<a name="l00274"></a>00274                         <span class="comment">// and r2 &gt;= 0 is a truncation problem.</span>
<a name="l00275"></a>00275                         d = -2*xu/u2;
<a name="l00276"></a>00276                     }
<a name="l00277"></a>00277                 }
<a name="l00278"></a>00278                 <span class="keywordflow">else</span> {
<a name="l00279"></a>00279                     EGS_Float D = sqrt(xu*xu - r2*u2);
<a name="l00280"></a>00280                     d = xu &lt; 0 ? (D-xu)/u2 : -r2/(D+xu);
<a name="l00281"></a>00281                 }
<a name="l00282"></a>00282                 <span class="keywordflow">if</span>( d &lt;= t ) {
<a name="l00283"></a>00283                     t = d; inew = ireg+1; ihit = ireg;
<a name="l00284"></a>00284                 }
<a name="l00285"></a>00285             }
<a name="l00286"></a>00286         }
<a name="l00287"></a>00287         <span class="keywordflow">if</span>( inew == ireg ) <span class="keywordflow">return</span> inew;
<a name="l00288"></a>00288 
<a name="l00289"></a>00289         <span class="keywordflow">if</span>( normal ) {
<a name="l00290"></a>00290             <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> xhit = xp + u*t;
<a name="l00291"></a>00291             EGS_Float xx = Ax*xhit, xy = Ay*xhit;
<a name="l00292"></a>00292             *normal = Ax.normal()*(xx*ay[ihit]*ay[ihit]) +
<a name="l00293"></a>00293                       Ay.normal()*(xy*ax[ihit]*ax[ihit]);
<a name="l00294"></a>00294             normal-&gt;normalize();
<a name="l00295"></a>00295             <span class="keywordflow">if</span>( inew &gt; iold ) *normal *= (-1);
<a name="l00296"></a>00296         }
<a name="l00297"></a>00297         <span class="keywordflow">if</span>( inew &gt;= nreg ) <span class="keywordflow">return</span> -1;
<a name="l00298"></a>00298         <span class="keywordflow">if</span>( newmed ) *newmed = medium(inew);
<a name="l00299"></a>00299         <span class="keywordflow">return</span> inew;
<a name="l00300"></a>00300     };
<a name="l00301"></a>00301 
<a name="l00302"></a>00302     EGS_Float hownear(<span class="keywordtype">int</span> ireg, <span class="keyword">const</span> <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> &amp;x) {
<a name="l00303"></a>00303         EGS_Float xx = fabs(Ax*x), xy = fabs(Ay*x);
<a name="l00304"></a>00304         EGS_Float tperp = ireg &gt;= 0 ? hownear(ireg,xx,xy) : 1e30;
<a name="l00305"></a>00305         <span class="keywordflow">if</span>( ireg &amp;&amp; tperp &gt; 0 ) {
<a name="l00306"></a>00306             <span class="keywordtype">int</span> n = ireg &lt; 0 ? nreg-1 : ireg-1;
<a name="l00307"></a>00307             EGS_Float t1 = hownear(n,xx,xy);
<a name="l00308"></a>00308             <span class="keywordflow">if</span>( t1 &lt; tperp ) tperp = t1;
<a name="l00309"></a>00309         }
<a name="l00310"></a>00310         <span class="keywordflow">return</span> tperp;
<a name="l00311"></a>00311     };
<a name="l00312"></a>00312 
<a name="l00313"></a>00313     <span class="keyword">const</span> <span class="keywordtype">string</span> &amp;getType()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> mytype; };
<a name="l00314"></a>00314 
<a name="l00315"></a>00315     <span class="keywordtype">void</span> printInfo()<span class="keyword"> const </span>{
<a name="l00316"></a>00316         <a class="code" href="classEGS__BaseGeometry.html#a90b349e45353ab0b7fa32053a9d37085" title="Print information about this geometry.">EGS_BaseGeometry::printInfo</a>();
<a name="l00317"></a>00317         <a class="code" href="group__egspp__main.html#ga38c38ac950788399c630481c2b3722f2" title="Always use this function for reporting the progress of a simulation and any other type of information...">egsInformation</a>(<span class="stringliteral">&quot;Type = %s\n&quot;</span>,mytype.c_str());
<a name="l00318"></a>00318         <a class="code" href="group__egspp__main.html#ga38c38ac950788399c630481c2b3722f2" title="Always use this function for reporting the progress of a simulation and any other type of information...">egsInformation</a>(<span class="stringliteral">&quot; midpoint of cylinders = (%g,%g,%g)\n&quot;</span>,xo.x,xo.y,xo.z);
<a name="l00319"></a>00319         <span class="keywordtype">int</span> j;
<a name="l00320"></a>00320         <a class="code" href="group__egspp__main.html#ga38c38ac950788399c630481c2b3722f2" title="Always use this function for reporting the progress of a simulation and any other type of information...">egsInformation</a>(<span class="stringliteral">&quot; radii along &#39;x&#39; =&quot;</span>);
<a name="l00321"></a>00321         <span class="keywordflow">for</span>(j=0; j&lt;nreg; j++) <a class="code" href="group__egspp__main.html#ga38c38ac950788399c630481c2b3722f2" title="Always use this function for reporting the progress of a simulation and any other type of information...">egsInformation</a>(<span class="stringliteral">&quot; %g&quot;</span>,ax[j]);
<a name="l00322"></a>00322         <a class="code" href="group__egspp__main.html#ga38c38ac950788399c630481c2b3722f2" title="Always use this function for reporting the progress of a simulation and any other type of information...">egsInformation</a>(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00323"></a>00323         <a class="code" href="group__egspp__main.html#ga38c38ac950788399c630481c2b3722f2" title="Always use this function for reporting the progress of a simulation and any other type of information...">egsInformation</a>(<span class="stringliteral">&quot; radii along &#39;y&#39; =&quot;</span>);
<a name="l00324"></a>00324         <span class="keywordflow">for</span>(j=0; j&lt;nreg; j++) <a class="code" href="group__egspp__main.html#ga38c38ac950788399c630481c2b3722f2" title="Always use this function for reporting the progress of a simulation and any other type of information...">egsInformation</a>(<span class="stringliteral">&quot; %g&quot;</span>,ay[j]);
<a name="l00325"></a>00325         <a class="code" href="group__egspp__main.html#ga38c38ac950788399c630481c2b3722f2" title="Always use this function for reporting the progress of a simulation and any other type of information...">egsInformation</a>(<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00326"></a>00326         <a class="code" href="group__egspp__main.html#ga38c38ac950788399c630481c2b3722f2" title="Always use this function for reporting the progress of a simulation and any other type of information...">egsInformation</a>(<span class="stringliteral">&quot;===================================================\n&quot;</span>);
<a name="l00327"></a>00327     };
<a name="l00328"></a>00328 
<a name="l00329"></a>00329 <span class="keyword">private</span>:
<a name="l00330"></a>00330 
<a name="l00331"></a>00331     EGS_Float hownear(<span class="keywordtype">int</span> ireg, EGS_Float xx, EGS_Float xy) {
<a name="l00332"></a>00332         <span class="keywordflow">if</span>( is_cyl[ireg] )
<a name="l00333"></a>00333             <span class="keywordflow">return</span> fabs(ax[ireg]-sqrt(xx*xx+xy*xy));
<a name="l00334"></a>00334         <span class="keywordtype">double</span> uo = sx[ireg]*xx, vo = sy[ireg]*xy;
<a name="l00335"></a>00335         <span class="keywordtype">double</span> x1 = (uo &lt; 0 &amp;&amp; uo &gt; -2) ?
<a name="l00336"></a>00336             uo*(uo*uo-4*(vo*vo+3))/(16*(1+vo*vo)) :
<a name="l00337"></a>00337                 1 - 0.5*vo*vo/(vo*vo+(uo+1)*(uo+1));
<a name="l00338"></a>00338         <span class="keywordtype">int</span> ntry=0;
<a name="l00339"></a>00339         <span class="keywordflow">while</span>(1) {
<a name="l00340"></a>00340             <span class="keywordflow">if</span>( ++ntry &gt; 50 ) {
<a name="l00341"></a>00341                 <span class="keywordflow">if</span>( ++nwarn &lt; 20 ) <a class="code" href="group__egspp__main.html#gadf4109d942f372e48e1dea86c0ca62cb" title="Always use this function for reporting warnings.">egsWarning</a>(<span class="stringliteral">&quot;EGS_EllipticCylindersT::&quot;</span>
<a name="l00342"></a>00342                         <span class="stringliteral">&quot;hownear: failed to find solution\n&quot;</span>);
<a name="l00343"></a>00343                 <span class="keywordflow">return</span> 0;
<a name="l00344"></a>00344             }
<a name="l00345"></a>00345             <span class="keywordtype">double</span> vox = vo*x1, uox = uo + x1, xm1 = 1 - x1*x1;
<a name="l00346"></a>00346             <span class="keywordtype">double</span> f = vox*vox - uox*uox*xm1;
<a name="l00347"></a>00347             <span class="keywordflow">if</span>( fabs(f) &lt; 1e-7 ) <span class="keywordflow">break</span>;
<a name="l00348"></a>00348             <span class="keywordtype">double</span> fs = 2*(vox*vo + uox*(x1*uox-xm1));
<a name="l00349"></a>00349             x1 -= f/fs;
<a name="l00350"></a>00350         }
<a name="l00351"></a>00351         <span class="keywordtype">double</span> y1 = ay[ireg]*sqrt(1-x1*x1) - xy; x1 = ax[ireg]*x1-xx;
<a name="l00352"></a>00352         <span class="keywordflow">return</span> sqrt(x1*x1 + y1*y1);
<a name="l00353"></a>00353     };
<a name="l00354"></a>00354 };
<a name="l00355"></a>00355 
<a name="l00356"></a>00356 <span class="keyword">typedef</span> <a class="code" href="classEGS__EllipticCylindersT.html" title="A set of concentric elliptic cylinders.">EGS_EllipticCylindersT&lt;EGS_XProjector,EGS_YProjector&gt;</a>
<a name="l00357"></a>00357         <a class="code" href="classEGS__EllipticCylindersT.html" title="A set of concentric elliptic cylinders.">EGS_EllipticCylindersXY</a>;
<a name="l00358"></a>00358 <span class="keyword">typedef</span> <a class="code" href="classEGS__EllipticCylindersT.html" title="A set of concentric elliptic cylinders.">EGS_EllipticCylindersT&lt;EGS_XProjector,EGS_ZProjector&gt;</a>
<a name="l00359"></a>00359         <a class="code" href="classEGS__EllipticCylindersT.html" title="A set of concentric elliptic cylinders.">EGS_EllipticCylindersXZ</a>;
<a name="l00360"></a>00360 <span class="keyword">typedef</span> <a class="code" href="classEGS__EllipticCylindersT.html" title="A set of concentric elliptic cylinders.">EGS_EllipticCylindersT&lt;EGS_YProjector,EGS_ZProjector&gt;</a>
<a name="l00361"></a>00361         <a class="code" href="classEGS__EllipticCylindersT.html" title="A set of concentric elliptic cylinders.">EGS_EllipticCylindersYZ</a>;
<a name="l00362"></a>00362 <span class="keyword">typedef</span> <a class="code" href="classEGS__EllipticCylindersT.html" title="A set of concentric elliptic cylinders.">EGS_EllipticCylindersT&lt;EGS_Projector,EGS_Projector&gt;</a>
<a name="l00363"></a>00363         <a class="code" href="classEGS__EllipticCylindersT.html" title="A set of concentric elliptic cylinders.">EGS_EllipticCylinders</a>;
<a name="l00364"></a>00364 
<a name="l00365"></a>00365 <span class="preprocessor">#endif</span>
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.3 </small></address>
</body>
</html>
