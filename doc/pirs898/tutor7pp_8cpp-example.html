<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>EGSnrc C++ class library: tutor7pp.cpp</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.3 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">EGSnrc C++ class library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<h1>tutor7pp.cpp</h1>  </div>
</div>
<div class="contents">
<p>The tutor7pp application is a re-implementation of the original tutor7 mortran application in C++ using <a class="el" href="classEGS__AdvancedApplication.html" title="Base class for advanced EGSnrc applications based on the mortran EGSnrc back-end.">EGS_AdvancedApplication</a>. It calculates the deposited, transmitted and reflected energy fractions in addition to the pulse height distribution in requested geometry regions. However, unlike the original tutor7 application, which can only calculate these quantites for a slab geometry for a pencil beam incident at a user defined angle, tutor7pp can perform the simulation in any geometry that can be defined using the <code>egspp</code> <a class="el" href="group__Geometry.html">geometry package</a> for any particle source that can be defined using the <code>egspp</code> <a class="el" href="group__Sources.html">source package</a>. In addition, tutor7pp provides the functionality of being able to restart a calculation, run a calculation in parallel and automatically recombine the results, limit the simulation time to a user defined maximum time, or abort the simulation if a user defined statistical uncertainty has been reached. Despite this added functionality, the tutor7pp source code is much shorter than the original tutor7 implementation in mortran. The reader is encouraged to study the guidelines for developing EGSnrc C++ applications provided in the <a class="el" href="classEGS__Application.html">EGS_Application class documentation</a> before reading this example.</p>
<p>To implement the required functionality we derive an application class from <a class="el" href="classEGS__AdvancedApplication.html" title="Base class for advanced EGSnrc applications based on the mortran EGSnrc back-end.">EGS_AdvancedApplication</a> <div class="fragment"><pre class="fragment"><span class="preprocessor">#include &quot;<a class="code" href="egs__advanced__application_8h.html" title="EGS_AdvancedApplication class header file.">egs_advanced_application.h</a>&quot;</span>

<span class="preprocessor">#include &quot;<a class="code" href="egs__scoring_8h.html" title="Scoring classes.">egs_scoring.h</a>&quot;</span>
<span class="preprocessor">#include &quot;<a class="code" href="egs__interface2_8h.html" title="This file defines the C/C++ interface to the EGSnrc mortran back-end.">egs_interface2.h</a>&quot;</span>
<span class="preprocessor">#include &quot;<a class="code" href="egs__functions_8h.html" title="Global egspp functions.">egs_functions.h</a>&quot;</span>
<span class="preprocessor">#include &quot;<a class="code" href="egs__input_8h.html" title="EGS_Input header file.">egs_input.h</a>&quot;</span>
<span class="preprocessor">#include &quot;<a class="code" href="egs__base__source_8h.html" title="Base particle source header file.">egs_base_source.h</a>&quot;</span>
<span class="preprocessor">#include &quot;<a class="code" href="egs__rndm_8h.html" title="Base random number generator.">egs_rndm.h</a>&quot;</span>

<span class="preprocessor">#include &lt;cstdlib&gt;</span>
<span class="keyword">using namespace </span>std;

<span class="keyword">class </span>APP_EXPORT Tutor7_Application : <span class="keyword">public</span> <a name="_a0"></a><a class="code" href="classEGS__AdvancedApplication.html" title="Base class for advanced EGSnrc applications based on the mortran EGSnrc back-end.">EGS_AdvancedApplication</a> {
</pre></div> The various include files are needed to gain access to the declarations of the classes and functions that will be used. We then declare various private data members: <div class="fragment"><pre class="fragment">
    <span class="keywordtype">double</span>           Etot;      <span class="comment">// total energy that has entered the geometry</span>
    <a name="_a1"></a><a class="code" href="classEGS__ScoringArray.html" title="A class for scoring an array of quantities (e.g. a dose distribution) in a Monte Carlo simulation...">EGS_ScoringArray</a> *score;    <span class="comment">// scoring array with energies deposited</span>
    <a class="code" href="classEGS__ScoringArray.html" title="A class for scoring an array of quantities (e.g. a dose distribution) in a Monte Carlo simulation...">EGS_ScoringArray</a> *eflu;     <span class="comment">// scoring array for electron fluence at back of geometry</span>
    <a class="code" href="classEGS__ScoringArray.html" title="A class for scoring an array of quantities (e.g. a dose distribution) in a Monte Carlo simulation...">EGS_ScoringArray</a> *gflu;     <span class="comment">// scoring array for photon fluence at back of geometry</span>
    <a class="code" href="classEGS__ScoringArray.html" title="A class for scoring an array of quantities (e.g. a dose distribution) in a Monte Carlo simulation...">EGS_ScoringArray</a> **pheight; <span class="comment">// pulse height distributions.</span>
    EGS_Float        *ph_de;    <span class="comment">// bin widths if the pulse height distributions.</span>
    <span class="keywordtype">int</span>              *ph_regions; <span class="comment">// region indeces of the ph-dsitributions</span>
    <span class="keywordtype">int</span>              nreg;      <span class="comment">// number of regions in the geometry</span>
    <span class="keywordtype">int</span>              nph;       <span class="comment">// number of pulse height objects.</span>
    <span class="keywordtype">int</span>              rr_flag;   <span class="comment">// used for RR and radiative splitting</span>
    EGS_Float        current_weight; <span class="comment">// the weight of the initial particle that</span>
                                     <span class="comment">// is currently being simulated</span>
    <span class="keywordtype">bool</span>  deflect_brems;
    <span class="keyword">static</span> <span class="keywordtype">string</span> revision;    <span class="comment">// the CVS revision number</span>
</pre></div> Their function is briefly explained by the comments and will become more clear in what follows. We now need a constructor for our application class that takes the command line arguments as input, passes them to the base class constructor and initializes its data <div class="fragment"><pre class="fragment">
<span class="keyword">public</span>:

    Tutor7_Application(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv) :
        <a class="code" href="classEGS__AdvancedApplication.html" title="Base class for advanced EGSnrc applications based on the mortran EGSnrc back-end.">EGS_AdvancedApplication</a>(argc,argv), score(0), eflu(0), gflu(0), pheight(0),
        nreg(0), nph(0), Etot(0), rr_flag(0), current_weight(1), deflect_brems(false) { };
</pre></div> The call to the <a class="el" href="classEGS__AdvancedApplication.html" title="Base class for advanced EGSnrc applications based on the mortran EGSnrc back-end.">EGS_AdvancedApplication</a> constructor checks the arguments passed on the command line and sets up the name of the application, the input file name, the pegs file name, the output file name, the working directory, batch vs interactive run, parallel job execution (i_parallel and n_parallel) and reads in the input file into an <a class="el" href="classEGS__Input.html" title="A class for storing information in a tree-like structure of key-value pairs. This class is used throu...">EGS_Input</a> object (a pointer to this object is available with the protected data member <a class="el" href="classEGS__Application.html#a6067426a81c58bb73ba412244c5fae39" title="the input to this simulation.">EGS_Application::input</a>). To demonstrate good coding habits, we declare a destructor for our application that deallocates the memory used <div class="fragment"><pre class="fragment">
    ~Tutor7_Application() {
        <span class="keywordflow">if</span>( score ) <span class="keyword">delete</span> score;
        <span class="keywordflow">if</span>( eflu ) <span class="keyword">delete</span> eflu;
        <span class="keywordflow">if</span>( gflu ) <span class="keyword">delete</span> gflu;
        <span class="keywordflow">if</span>( nph &gt; 0 ) {
            <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0; j&lt;nph; j++) <span class="keyword">delete</span> pheight[j];
            <span class="keyword">delete</span> [] pheight; <span class="keyword">delete</span> [] ph_regions; <span class="keyword">delete</span> [] ph_de;
        }
    };
</pre></div> We now declare the various virtual functions that we wish to re-implement: the function to describe our user code, <div class="fragment"><pre class="fragment">
    <span class="keywordtype">void</span> describeUserCode() <span class="keyword">const</span>;
</pre></div> the function to initialize the scoring variables, <div class="fragment"><pre class="fragment">
    <span class="keywordtype">int</span> initScoring();
</pre></div> the function for scoring the quantities of interest at run time, <div class="fragment"><pre class="fragment">
    <span class="keywordtype">int</span> ausgab(<span class="keywordtype">int</span> iarg);
</pre></div> the functions needed for restarting simulations and parallel runs, <div class="fragment"><pre class="fragment">
    <span class="keywordtype">int</span> outputData();

    <span class="keywordtype">int</span> readData();

    <span class="keywordtype">void</span> resetCounter();

    <span class="keywordtype">int</span> addState(istream &amp;data);
</pre></div> the function to output the results of the simulation, <div class="fragment"><pre class="fragment">
    <span class="keywordtype">void</span> outputResults();
</pre></div> the function that makes the current result known to the <a class="el" href="classEGS__RunControl.html">run control object</a>, <div class="fragment"><pre class="fragment">
    <span class="keywordtype">void</span> getCurrentResult(<span class="keywordtype">double</span> &amp;sum, <span class="keywordtype">double</span> &amp;sum2, <span class="keywordtype">double</span> &amp;norm,
            <span class="keywordtype">double</span> &amp;count);
</pre></div> and the protected function called before the simulation of a new particle <div class="fragment"><pre class="fragment">
<span class="keyword">protected</span>:

    <span class="keywordtype">int</span> startNewShower();


};
</pre></div> This completes our application class declaration.</p>
<p>We now provide implementations of the above functions. First we have to declare the static data member <code>revision</code>: <div class="fragment"><pre class="fragment">
<span class="keywordtype">string</span> Tutor7_Application::revision = <span class="stringliteral">&quot;$Revision: 1.13 $&quot;</span>;
</pre></div> Note that the revision string is automatically updated by CVS, which we use for version control at the NRC, each time we commit a new version of the tutor7pp application. The <code>describeUserCode</code>() function simply outputs the name of our application and the revision numbers of the base application class and our application class using egsInformation: <div class="fragment"><pre class="fragment">
<span class="keyword">extern</span> <span class="stringliteral">&quot;C&quot;</span> <span class="keywordtype">void</span> F77_OBJ_(egs_scale_xcc,EGS_SCALE_XCC)(<span class="keyword">const</span> <span class="keywordtype">int</span> *,<span class="keyword">const</span> EGS_Float *);
<span class="keyword">extern</span> <span class="stringliteral">&quot;C&quot;</span> <span class="keywordtype">void</span> F77_OBJ_(egs_scale_bc,EGS_SCALE_BC)(<span class="keyword">const</span> <span class="keywordtype">int</span> *,<span class="keyword">const</span> EGS_Float *);

<span class="keywordtype">void</span> Tutor7_Application::describeUserCode()<span class="keyword"> const </span>{
   <a name="a2"></a><a class="code" href="group__egspp__main.html#ga38c38ac950788399c630481c2b3722f2" title="Always use this function for reporting the progress of a simulation and any other type of information...">egsInformation</a>(
     <span class="stringliteral">&quot;\n               ***************************************************&quot;</span>
     <span class="stringliteral">&quot;\n               *                                                 *&quot;</span>
     <span class="stringliteral">&quot;\n               *                  tutor7pp                       *&quot;</span>
     <span class="stringliteral">&quot;\n               *                                                 *&quot;</span>
     <span class="stringliteral">&quot;\n               ***************************************************&quot;</span>
     <span class="stringliteral">&quot;\n\n&quot;</span>);
   <a class="code" href="group__egspp__main.html#ga38c38ac950788399c630481c2b3722f2" title="Always use this function for reporting the progress of a simulation and any other type of information...">egsInformation</a>(<span class="stringliteral">&quot;This is Tutor7_Application %s based on\n&quot;</span>
     <span class="stringliteral">&quot;      EGS_AdvancedApplication %s\n\n&quot;</span>,
     <a name="a3"></a><a class="code" href="group__egspp__main.html#ga93d32bad171fae0575c0ea56cbdd4290" title="Remove the $&amp;#39;s from a CVS key.">egsSimplifyCVSKey</a>(revision).c_str(),
     <a class="code" href="group__egspp__main.html#ga93d32bad171fae0575c0ea56cbdd4290" title="Remove the $&amp;#39;s from a CVS key.">egsSimplifyCVSKey</a>(base_revision).c_str());
}
</pre></div> This is useful for determining which version was used to obtain a given result from the logfile produced by the application. The egsSimplifyCVSKey function used above removes the $'s from CVS keys.</p>
<p>The next step is to initialize the scoring variables in <code>initScoring</code>(). We will need a scoring array object to collect energy depositions in all regions of the geometry and the outside region (divided into energy transmitted, defined as the energy of particles exiting the geometry and moving forward, and energy reflected, defined as the energy of particles exiting the geometry and moving backwards) from which we can calculate energy deposition fractions. For this purpose we obtain the number of regions in the geometry <div class="fragment"><pre class="fragment">
<span class="keywordtype">int</span> Tutor7_Application::initScoring() {
    nreg = geometry-&gt;regions();
</pre></div> and initialize a scoring array with <code>nreg+2</code> regions pointed to by our class variable <code>score:</code> <div class="fragment"><pre class="fragment">    score = <span class="keyword">new</span> <a class="code" href="classEGS__ScoringArray.html" title="A class for scoring an array of quantities (e.g. a dose distribution) in a Monte Carlo simulation...">EGS_ScoringArray</a>(nreg+2);
</pre></div> We want the user to be able to specify the geometry regions for which to calculate a pulse height distribution (PHD) by including </p>
<div class="fragment"><pre class="fragment">
:start scoring options:
    pulse height regions = 1 5 77
    pulse height bins = 125 50 500
:stop scoring options:
</pre></div><p> in their input file, with the <code>pulse height regions</code> key specifying all regions for which a PHD calculation is requested and the <code>pulse height bins</code> key the number of bins to use for each PHD region (obviously, the number of integer inputs to these two keys must be the same). To implement this functionality, we interogate the <a class="el" href="classEGS__Application.html#a6067426a81c58bb73ba412244c5fae39">input object </a>, which contains all input found in the input file, for a composite key named <code>scoring options</code> <div class="fragment"><pre class="fragment">    <a name="_a4"></a><a class="code" href="classEGS__Input.html" title="A class for storing information in a tree-like structure of key-value pairs. This class is used throu...">EGS_Input</a> *options = input-&gt;<a name="a5"></a><a class="code" href="classEGS__Input.html#a1fb7e11391a1ab33c23321633d035781" title="Get the property named key.">takeInputItem</a>(<span class="stringliteral">&quot;scoring options&quot;</span>);
</pre></div> and if such property exists (<em>i.e</em>. <code>options</code> is not <code>null</code>), check for the <code>pulse height regions</code> and <code>pulse height bins</code> keys: <div class="fragment"><pre class="fragment">            vector&lt;string&gt; tmp;
            <span class="keywordtype">int</span> err = scale-&gt;getInput(<span class="stringliteral">&quot;scale xcc&quot;</span>,tmp);
            <span class="comment">//egsInformation(&quot;Found &#39;scale xcc&#39;, err=%d tmp.size()=%d\n&quot;,err,tmp.size());</span>
            <span class="keywordflow">if</span>( !err &amp;&amp; tmp.size() == 2 ) {
                <span class="keywordtype">int</span> imed = <a name="a6"></a><a class="code" href="classEGS__BaseGeometry.html#adb608c74a77dcd0979baa72da5b6cd2f" title="Get the index of a medium named medname.">EGS_BaseGeometry::getMediumIndex</a>(tmp[0]) + 1;
                <span class="keywordflow">if</span>( imed &gt; 0 ) {
                    EGS_Float fac = atof(tmp[1].c_str());
                    <a class="code" href="group__egspp__main.html#ga38c38ac950788399c630481c2b3722f2" title="Always use this function for reporting the progress of a simulation and any other type of information...">egsInformation</a>(<span class="stringliteral">&quot;\n ***** Scaling xcc of medium %d with %g\n&quot;</span>,imed,fac);
                    F77_OBJ_(egs_scale_xcc,EGS_SCALE_XCC)(&amp;imed,&amp;fac);
                }
            }
            <span class="keyword">delete</span> scale;
        }
        <span class="keywordflow">while</span>( (scale = options-&gt;<a class="code" href="classEGS__Input.html#a1fb7e11391a1ab33c23321633d035781" title="Get the property named key.">takeInputItem</a>(<span class="stringliteral">&quot;scale bc&quot;</span>)) ) {
            vector&lt;string&gt; tmp;
            <span class="keywordtype">int</span> err = scale-&gt;getInput(<span class="stringliteral">&quot;scale bc&quot;</span>,tmp);
            <span class="comment">//egsInformation(&quot;Found &#39;scale xcc&#39;, err=%d tmp.size()=%d\n&quot;,err,tmp.size());</span>
            <span class="keywordflow">if</span>( !err &amp;&amp; tmp.size() == 2 ) {
                <span class="keywordtype">int</span> imed = <a class="code" href="classEGS__BaseGeometry.html#adb608c74a77dcd0979baa72da5b6cd2f" title="Get the index of a medium named medname.">EGS_BaseGeometry::getMediumIndex</a>(tmp[0]) + 1;
                <span class="keywordflow">if</span>( imed &gt; 0 ) {
                    EGS_Float fac = atof(tmp[1].c_str());
                    <a class="code" href="group__egspp__main.html#ga38c38ac950788399c630481c2b3722f2" title="Always use this function for reporting the progress of a simulation and any other type of information...">egsInformation</a>(<span class="stringliteral">&quot;\n ***** Scaling bc of medium %d with %g\n&quot;</span>,imed,fac);
                    F77_OBJ_(egs_scale_bc,EGS_SCALE_BC)(&amp;imed,&amp;fac);
                }
            }
            <span class="keyword">delete</span> scale;
        }

        vector&lt;string&gt; choices; choices.push_back(<span class="stringliteral">&quot;no&quot;</span>); choices.push_back(<span class="stringliteral">&quot;yes&quot;</span>);
        deflect_brems = options-&gt;<a name="a7"></a><a class="code" href="classEGS__Input.html#a154f3de14ebb23c3e78316b40b33b719" title="Assign values to an array of strings from an input identified by key.">getInput</a>(<span class="stringliteral">&quot;deflect electron after brems&quot;</span>,choices,0);
        <span class="keywordflow">if</span>( deflect_brems ) {
            <a class="code" href="group__egspp__main.html#ga38c38ac950788399c630481c2b3722f2" title="Always use this function for reporting the progress of a simulation and any other type of information...">egsInformation</a>(<span class="stringliteral">&quot;\n *** Using electron deflection in brems events\n\n&quot;</span>);
            setAusgabCall(AfterBrems,<span class="keyword">true</span>);
        }

        <span class="keywordtype">int</span> n_rr;
        <span class="keywordflow">if</span>( !options-&gt;<a class="code" href="classEGS__Input.html#a154f3de14ebb23c3e78316b40b33b719" title="Assign values to an array of strings from an input identified by key.">getInput</a>(<span class="stringliteral">&quot;Russian Roulette&quot;</span>,n_rr) &amp;&amp; n_rr &gt; 1 ) {
            <a name="a8"></a><a class="code" href="egs__interface2_8h.html#a0023d201c8c03e188ebf9943f6951af7" title="The address of the mortran egs_vr common block as a pointer to a C-structure of type EGS_VarianceRedu...">the_egsvr</a>-&gt;<a name="a9"></a><a class="code" href="structEGS__VarianceReduction.html#ade261c730784e1debd811957bf23a5eb">i_do_rr</a> = n_rr;
            setAusgabCall(BeforeBrems,<span class="keyword">true</span>);
            setAusgabCall(AfterBrems,<span class="keyword">true</span>);
            setAusgabCall(BeforeAnnihFlight,<span class="keyword">true</span>);
            setAusgabCall(AfterAnnihFlight,<span class="keyword">true</span>);
            setAusgabCall(BeforeAnnihRest,<span class="keyword">true</span>);
            setAusgabCall(AfterAnnihRest,<span class="keyword">true</span>);
            <span class="comment">//setAusgabCall(FluorescentEvent,true);</span>
            <a class="code" href="group__egspp__main.html#ga38c38ac950788399c630481c2b3722f2" title="Always use this function for reporting the progress of a simulation and any other type of information...">egsInformation</a>(<span class="stringliteral">&quot;\nUsing Russian Roulette with survival probability 1/%d\n&quot;</span>,n_rr);
        }

        <span class="comment">// The user has provided scoring options input.</span>
        <span class="comment">// See where she/he wants to score a pulse height distribution</span>
        <span class="comment">// and how many bins to use for each pulse height distribution</span>
        vector&lt;int&gt; regions;
        <span class="keywordtype">int</span> err = options-&gt;<a class="code" href="classEGS__Input.html#a154f3de14ebb23c3e78316b40b33b719" title="Assign values to an array of strings from an input identified by key.">getInput</a>(<span class="stringliteral">&quot;pulse height regions&quot;</span>,regions);
        vector&lt;int&gt; nbins;
        <span class="keywordtype">int</span> err1 = options-&gt;<a class="code" href="classEGS__Input.html#a154f3de14ebb23c3e78316b40b33b719" title="Assign values to an array of strings from an input identified by key.">getInput</a>(<span class="stringliteral">&quot;pulse height bins&quot;</span>,nbins);
</pre></div> If the keys exist (<em>i.e</em>. <code>err</code> and <code>err1</code> are zero), we check that the number of inputs is the same, or, alternatively there is only a single input to the <code>pulse height bins</code> key (in this case we use the same number of bins for all PHDs), and if this is not satisfied issue a warning so that the user is made aware of a potential mistake in the input file, <div class="fragment"><pre class="fragment">        <span class="keywordflow">if</span>( !err &amp;&amp; !err1 ) {
            <span class="keywordflow">if</span>( regions.size() != nbins.size() &amp;&amp; nbins.size() != 1 )
                    <a name="a10"></a><a class="code" href="group__egspp__main.html#gadf4109d942f372e48e1dea86c0ca62cb" title="Always use this function for reporting warnings.">egsWarning</a>(<span class="stringliteral">&quot;initScoring(): you must input the same &quot;</span>
                <span class="stringliteral">&quot;number of &#39;regions&#39; and &#39;bins&#39; inputs or a single &#39;bins&#39;&quot;</span>
                <span class="stringliteral">&quot; input\n&quot;</span>);
</pre></div> otherwise we have to initialize scoring arrays for the requested PHDs. We first alocate a temporary array of pointers to scoring objects and set all of them to <code>null:</code> <div class="fragment"><pre class="fragment">            <span class="keywordflow">else</span> {
                <a class="code" href="classEGS__ScoringArray.html" title="A class for scoring an array of quantities (e.g. a dose distribution) in a Monte Carlo simulation...">EGS_ScoringArray</a> **tmp = <span class="keyword">new</span> <a class="code" href="classEGS__ScoringArray.html" title="A class for scoring an array of quantities (e.g. a dose distribution) in a Monte Carlo simulation...">EGS_ScoringArray</a>* [nreg+2];
                <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;nreg+2; i++) tmp[i] = 0;
</pre></div> We then loop over the number of PHD regions <div class="fragment"><pre class="fragment">                <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0; j&lt;regions.size(); j++) {
</pre></div> For each requested PHD region we set the number of bins (possibly warning the user, if the number is less than 1), <div class="fragment"><pre class="fragment">                    <span class="keywordtype">int</span> nb = nbins.size() == 1 ? nbins[0] : nbins[j];
                    <span class="keywordflow">if</span>( nb &lt; 1 )
                        <a class="code" href="group__egspp__main.html#gadf4109d942f372e48e1dea86c0ca62cb" title="Always use this function for reporting warnings.">egsWarning</a>(<span class="stringliteral">&quot;zero bins for region %d?\n&quot;</span>,regions[j]);
</pre></div> and check that the region index is valid <div class="fragment"><pre class="fragment">                    <span class="keywordflow">if</span>( regions[j] &lt; 0 || regions[j] &gt; nreg+1 )
                        <a class="code" href="group__egspp__main.html#gadf4109d942f372e48e1dea86c0ca62cb" title="Always use this function for reporting warnings.">egsWarning</a>(<span class="stringliteral">&quot;invalid region index %d\n&quot;</span>,regions[j]);
</pre></div> If the number of bins is positive and the region index is valid, we check if there is not already a PHD scoring object for this region initilized and warn the user if there is <div class="fragment"><pre class="fragment">                    <span class="keywordflow">if</span>( nb &gt; 0 &amp;&amp; regions[j] &gt;= 0 &amp;&amp; regions[j] &lt; nreg+2 ){
                        <span class="keywordtype">int</span> ij = regions[j];
                        <span class="keywordflow">if</span>( tmp[ij] ) <a class="code" href="group__egspp__main.html#ga38c38ac950788399c630481c2b3722f2" title="Always use this function for reporting the progress of a simulation and any other type of information...">egsInformation</a>(<span class="stringliteral">&quot;There is already a &quot;</span>
                  <span class="stringliteral">&quot;PHD object in region %d =&gt; ignoring it\n&quot;</span>,ij);
</pre></div> (perhaps the user has made a mistake and input the same PHD region twice), otherwise we construct a scoring array with <code>nb</code> bins, increment the number of requested PHDs by one and store the pointer to the newly constructed scoring array in <code>tmp:</code> <div class="fragment"><pre class="fragment">                        <span class="keywordflow">else</span> { tmp[ij] = <span class="keyword">new</span> <a class="code" href="classEGS__ScoringArray.html" title="A class for scoring an array of quantities (e.g. a dose distribution) in a Monte Carlo simulation...">EGS_ScoringArray</a>(nb); ++nph; }
                    }
</pre></div> When the loop over requested PHD regions is completed, <code>nph</code> has the number of valid PHD requests and the elements of <code>tmp</code> that are not <code>null</code> have the pointers to the scorring array objects allocated for the calculation of the PHDs. We then allocate an array of pointers to scorring array objects with the required size, <div class="fragment"><pre class="fragment">                }
                <span class="keywordflow">if</span>( nph &gt; 0 ) {
                    pheight = <span class="keyword">new</span> <a class="code" href="classEGS__ScoringArray.html" title="A class for scoring an array of quantities (e.g. a dose distribution) in a Monte Carlo simulation...">EGS_ScoringArray</a>* [nph];
</pre></div> an array with region indeces for each requested PHD, <div class="fragment"><pre class="fragment">                    ph_regions = <span class="keyword">new</span> <span class="keywordtype">int</span> [nph];
</pre></div> and an array with bin widths for each PHD <div class="fragment"><pre class="fragment">                    ph_de = <span class="keyword">new</span> EGS_Float [nph];
</pre></div> We then obtain the maximum source energy <div class="fragment"><pre class="fragment">                    EGS_Float Emax = source-&gt;getEmax();
</pre></div> and loop over all regions <div class="fragment"><pre class="fragment">                    <span class="keywordtype">int</span> iph = 0;
                    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0; j&lt;nreg+2; j++) {
</pre></div> If <code>tmp</code>[j] is not <code>null</code>, we set the <code>iph't</code> element of the just allocated arrays to contain the pointer to the scorring array, the region index of the PHD, and the bin width: <div class="fragment"><pre class="fragment">                        <span class="keywordflow">if</span>( tmp[j] ) {
                            pheight[iph] = tmp[j];
                            ph_regions[iph] = j;
                            <span class="keywordtype">int</span> nbin = pheight[iph]-&gt;<a name="a11"></a><a class="code" href="classEGS__ScoringArray.html#a022d5676d6934ba40bc6d416591e2f56" title="Returns the number of bins (or elements or regions, the most appropriate term depending on the way th...">bins</a>();
                            ph_de[iph++] = Emax/nbin;
                        }
                    }
                }
</pre></div> We then delete <code>tmp</code> to avoid memory leaks <div class="fragment"><pre class="fragment">                <span class="keyword">delete</span> [] tmp;
            }
</pre></div> This completes the initilization of PHD scoring. If the user has provided <code>scoring options</code> input but the input is incorrect (indicated by <code>err</code> and/or <code>err1</code> not being zero), we warn them so that they can check their input file <div class="fragment"><pre class="fragment">        } <span class="keywordflow">else</span> <a class="code" href="group__egspp__main.html#gadf4109d942f372e48e1dea86c0ca62cb" title="Always use this function for reporting warnings.">egsWarning</a>(<span class="stringliteral">&quot;initScoring(): you must provide both, &#39;regions&#39;&quot;</span>
                   <span class="stringliteral">&quot; and &#39;bins&#39; input\n&quot;</span>);
</pre></div> We then delete the <code>scoring options</code> input as it is no longer needed <div class="fragment"><pre class="fragment">        <span class="keyword">delete</span> options;
    }
    <span class="keywordflow">return</span> 0;
}
</pre></div> (Note: if we were expecting that someone might want to extend the functionality of our tutor7pp application by deriving from the Tutor7_Application class, we should have introduced a protected data member to point to the <code>scroring options</code> property and should not delete it here. In this case we also should have split the class declaration into a separate header file). This completes the <code>initScoring</code>() implementation.</p>
<p>The implementation of our <code>ausgab</code>() function is very simple: for enertgy deposition events (<em>i.e</em>. <code>iarg&lt;=4</code>) we determine the region index of the top particle on the particle stack and score the energy deposited weighted with the statistical weight of the particle into the corresponding scoring region using the <a class="el" href="classEGS__ScoringArray.html#a9a2cc351e95c8a224ae5a571aa99638d">score() </a> method of our scoring array object: <div class="fragment"><pre class="fragment">
<span class="keywordtype">int</span> Tutor7_Application::ausgab(<span class="keywordtype">int</span> iarg) {
    <span class="keywordflow">if</span>( iarg &lt;= 4 ) {
        <span class="keywordtype">int</span> np = <a name="a12"></a><a class="code" href="egs__interface2_8h.html#ad3c6fd2b0e445d2273263b64cb2e4d74" title="The address of the mortran STACK common block as a pointer to a C-structure of type EGS_Stack...">the_stack</a>-&gt;<a name="a13"></a><a class="code" href="structEGS__Stack.html#af5e322d06055d31869c5c45cb6e462d1">np</a> - 1; <span class="keywordtype">int</span> ir = <a class="code" href="egs__interface2_8h.html#ad3c6fd2b0e445d2273263b64cb2e4d74" title="The address of the mortran STACK common block as a pointer to a C-structure of type EGS_Stack...">the_stack</a>-&gt;<a name="a14"></a><a class="code" href="structEGS__Stack.html#a7b57f3b0571707c6bb4cb4f65720af75">ir</a>[np]-1;
        <span class="keywordflow">if</span>( ir == 0 &amp;&amp; <a class="code" href="egs__interface2_8h.html#ad3c6fd2b0e445d2273263b64cb2e4d74" title="The address of the mortran STACK common block as a pointer to a C-structure of type EGS_Stack...">the_stack</a>-&gt;<a name="a15"></a><a class="code" href="structEGS__Stack.html#a792b83be2582af5596c36966e634d748">w</a>[np] &gt; 0 ) ir = nreg+1;
        score-&gt;score(ir,<a name="a16"></a><a class="code" href="egs__interface2_8h.html#a0e5931e71c4f14d863e2fe3a5f508e14" title="The address of the mortran EPCONT common block as a pointer to a C-structure of type EGS_Epcont...">the_epcont</a>-&gt;<a name="a17"></a><a class="code" href="structEGS__Epcont.html#a4a37133c1fbcbfe96cffab989a9c2633">edep</a>*<a class="code" href="egs__interface2_8h.html#ad3c6fd2b0e445d2273263b64cb2e4d74" title="The address of the mortran STACK common block as a pointer to a C-structure of type EGS_Stack...">the_stack</a>-&gt;<a name="a18"></a><a class="code" href="structEGS__Stack.html#abde65475db0a8c4350dadf06a7ac2375">wt</a>[np]);
        <span class="comment">// if( the_stack-&gt;iq[np] ) score-&gt;score(ir,the_epcont-&gt;edep*the_stack-&gt;wt[np]);</span>
        <span class="keywordflow">if</span>( ir == nreg+1 ) {
            <a class="code" href="classEGS__ScoringArray.html" title="A class for scoring an array of quantities (e.g. a dose distribution) in a Monte Carlo simulation...">EGS_ScoringArray</a> *flu = <a class="code" href="egs__interface2_8h.html#ad3c6fd2b0e445d2273263b64cb2e4d74" title="The address of the mortran STACK common block as a pointer to a C-structure of type EGS_Stack...">the_stack</a>-&gt;<a name="a19"></a><a class="code" href="structEGS__Stack.html#a9a8a5f250531ac78188175d4903abd4d">iq</a>[np] ? eflu : gflu;
            EGS_Float r2 = <a class="code" href="egs__interface2_8h.html#ad3c6fd2b0e445d2273263b64cb2e4d74" title="The address of the mortran STACK common block as a pointer to a C-structure of type EGS_Stack...">the_stack</a>-&gt;<a name="a20"></a><a class="code" href="structEGS__Stack.html#a3e1893b08c58c1930215b05ffd3b200c">x</a>[np]*<a class="code" href="egs__interface2_8h.html#ad3c6fd2b0e445d2273263b64cb2e4d74" title="The address of the mortran STACK common block as a pointer to a C-structure of type EGS_Stack...">the_stack</a>-&gt;<a class="code" href="structEGS__Stack.html#a3e1893b08c58c1930215b05ffd3b200c">x</a>[np] + <a class="code" href="egs__interface2_8h.html#ad3c6fd2b0e445d2273263b64cb2e4d74" title="The address of the mortran STACK common block as a pointer to a C-structure of type EGS_Stack...">the_stack</a>-&gt;<a name="a21"></a><a class="code" href="structEGS__Stack.html#abaeb3b4d4df09253d62ecf9c866a75b5">y</a>[np]*<a class="code" href="egs__interface2_8h.html#ad3c6fd2b0e445d2273263b64cb2e4d74" title="The address of the mortran STACK common block as a pointer to a C-structure of type EGS_Stack...">the_stack</a>-&gt;<a class="code" href="structEGS__Stack.html#abaeb3b4d4df09253d62ecf9c866a75b5">y</a>[np];
            <span class="keywordflow">if</span>( r2 &lt; 400 ) {
                <span class="keywordtype">int</span> bin = (int) (sqrt(r2)*10.);
                flu-&gt;<a name="a22"></a><a class="code" href="classEGS__ScoringArray.html#a9a2cc351e95c8a224ae5a571aa99638d" title="Add f to the score in the element ireg.">score</a>(bin,<a class="code" href="egs__interface2_8h.html#ad3c6fd2b0e445d2273263b64cb2e4d74" title="The address of the mortran STACK common block as a pointer to a C-structure of type EGS_Stack...">the_stack</a>-&gt;<a class="code" href="structEGS__Stack.html#abde65475db0a8c4350dadf06a7ac2375">wt</a>[np]/<a class="code" href="egs__interface2_8h.html#ad3c6fd2b0e445d2273263b64cb2e4d74" title="The address of the mortran STACK common block as a pointer to a C-structure of type EGS_Stack...">the_stack</a>-&gt;<a class="code" href="structEGS__Stack.html#a792b83be2582af5596c36966e634d748">w</a>[np]);
            }
        }
</pre></div> The calculation of requested pulse height distributions will be done in the <code>startNewShower</code>() function (see below).</p>
<p>The <code>outputData</code>() function must store the accumulated results to a data stream (click on <code>outputData</code>() below to see the base class documentation of this virtual function). We use the base class implementation to store the data of the base application and return the generated error code, if an error occured: <div class="fragment"><pre class="fragment">        <span class="keywordflow">return</span> 0;
    }
    <span class="keywordtype">int</span> np = <a class="code" href="egs__interface2_8h.html#ad3c6fd2b0e445d2273263b64cb2e4d74" title="The address of the mortran STACK common block as a pointer to a C-structure of type EGS_Stack...">the_stack</a>-&gt;<a class="code" href="structEGS__Stack.html#af5e322d06055d31869c5c45cb6e462d1">np</a>-1;
    <span class="keywordflow">if</span>( iarg == BeforeBrems || iarg == BeforeAnnihRest || iarg == BeforeAnnihFlight &amp;&amp;
        <a class="code" href="egs__interface2_8h.html#ad3c6fd2b0e445d2273263b64cb2e4d74" title="The address of the mortran STACK common block as a pointer to a C-structure of type EGS_Stack...">the_stack</a>-&gt;<a name="a23"></a><a class="code" href="structEGS__Stack.html#afaaf57ba783e01b7f0a0aeb6fbe0447c">latch</a>[np] &gt; 0 ) {
        <a class="code" href="egs__interface2_8h.html#ad3c6fd2b0e445d2273263b64cb2e4d74" title="The address of the mortran STACK common block as a pointer to a C-structure of type EGS_Stack...">the_stack</a>-&gt;<a class="code" href="structEGS__Stack.html#afaaf57ba783e01b7f0a0aeb6fbe0447c">latch</a>[np] = 0; rr_flag = 1;
        <a class="code" href="egs__interface2_8h.html#a0023d201c8c03e188ebf9943f6951af7" title="The address of the mortran egs_vr common block as a pointer to a C-structure of type EGS_VarianceRedu...">the_egsvr</a>-&gt;<a name="a24"></a><a class="code" href="structEGS__VarianceReduction.html#a81248fb91da28fad36740687608583db">nbr_split</a> = <a class="code" href="egs__interface2_8h.html#a0023d201c8c03e188ebf9943f6951af7" title="The address of the mortran egs_vr common block as a pointer to a C-structure of type EGS_VarianceRedu...">the_egsvr</a>-&gt;<a class="code" href="structEGS__VarianceReduction.html#ade261c730784e1debd811957bf23a5eb">i_do_rr</a>; <span class="keywordflow">return</span> 0;
    }
    <span class="keywordflow">if</span>( iarg == AfterBrems &amp;&amp; deflect_brems ) {
        <a name="_a25"></a><a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> u(<a class="code" href="egs__interface2_8h.html#ad3c6fd2b0e445d2273263b64cb2e4d74" title="The address of the mortran STACK common block as a pointer to a C-structure of type EGS_Stack...">the_stack</a>-&gt;<a name="a26"></a><a class="code" href="structEGS__Stack.html#abcce3249128b99879d88aefc0e747adb">u</a>[np-1],<a class="code" href="egs__interface2_8h.html#ad3c6fd2b0e445d2273263b64cb2e4d74" title="The address of the mortran STACK common block as a pointer to a C-structure of type EGS_Stack...">the_stack</a>-&gt;<a name="a27"></a><a class="code" href="structEGS__Stack.html#a74269a7153ecdc20f966ac7e7a4900e3">v</a>[np-1],<a class="code" href="egs__interface2_8h.html#ad3c6fd2b0e445d2273263b64cb2e4d74" title="The address of the mortran STACK common block as a pointer to a C-structure of type EGS_Stack...">the_stack</a>-&gt;<a class="code" href="structEGS__Stack.html#a792b83be2582af5596c36966e634d748">w</a>[np-1]);
        EGS_Float tau = <a class="code" href="egs__interface2_8h.html#ad3c6fd2b0e445d2273263b64cb2e4d74" title="The address of the mortran STACK common block as a pointer to a C-structure of type EGS_Stack...">the_stack</a>-&gt;<a name="a28"></a><a class="code" href="structEGS__Stack.html#a054b5f967362fb583b08aa141d44d274">E</a>[np-1]/<a name="a29"></a><a class="code" href="egs__interface2_8h.html#a0672b754e821b69e7fb77eff1c412bc9" title="The address of the mortran USEFUL common block as a pointer to a C-structure of type EGS_Useful...">the_useful</a>-&gt;<a name="a30"></a><a class="code" href="structEGS__Useful.html#a65779a8f4b47d673a45c274fadcde881" title="Electron rest energy.">rm</a> - 1;
        EGS_Float beta = sqrt(tau*(tau+2))/(tau+1);
        EGS_Float eta = 2*rndm-&gt;getUniform()-1;
        EGS_Float cost = (beta + eta)/(1 + beta*eta);
        EGS_Float sint = 1 - cost*cost;
        <span class="keywordflow">if</span>( sint &gt; 0 ) {
            sint = sqrt(sint); EGS_Float cphi, sphi;
            rndm-&gt;getAzimuth(cphi,sphi); u.rotate(cost,sint,cphi,sphi);
            <a class="code" href="egs__interface2_8h.html#ad3c6fd2b0e445d2273263b64cb2e4d74" title="The address of the mortran STACK common block as a pointer to a C-structure of type EGS_Stack...">the_stack</a>-&gt;<a class="code" href="structEGS__Stack.html#abcce3249128b99879d88aefc0e747adb">u</a>[np-1] = u.x;
            <a class="code" href="egs__interface2_8h.html#ad3c6fd2b0e445d2273263b64cb2e4d74" title="The address of the mortran STACK common block as a pointer to a C-structure of type EGS_Stack...">the_stack</a>-&gt;<a class="code" href="structEGS__Stack.html#a74269a7153ecdc20f966ac7e7a4900e3">v</a>[np-1] = u.y;
            <a class="code" href="egs__interface2_8h.html#ad3c6fd2b0e445d2273263b64cb2e4d74" title="The address of the mortran STACK common block as a pointer to a C-structure of type EGS_Stack...">the_stack</a>-&gt;<a class="code" href="structEGS__Stack.html#a792b83be2582af5596c36966e634d748">w</a>[np-1] = u.z;
        }
    }

    <span class="keywordflow">if</span>( iarg == AfterBrems || iarg == AfterAnnihRest || iarg == AfterAnnihFlight ) {
        <a class="code" href="egs__interface2_8h.html#a0023d201c8c03e188ebf9943f6951af7" title="The address of the mortran egs_vr common block as a pointer to a C-structure of type EGS_VarianceRedu...">the_egsvr</a>-&gt;<a class="code" href="structEGS__VarianceReduction.html#a81248fb91da28fad36740687608583db">nbr_split</a> = 1;
        <span class="keywordflow">if</span>( iarg == AfterBrems &amp;&amp; rr_flag ) {
            <a class="code" href="egs__interface2_8h.html#ad3c6fd2b0e445d2273263b64cb2e4d74" title="The address of the mortran STACK common block as a pointer to a C-structure of type EGS_Stack...">the_stack</a>-&gt;<a class="code" href="structEGS__Stack.html#afaaf57ba783e01b7f0a0aeb6fbe0447c">latch</a>[<a class="code" href="egs__interface2_8h.html#ad3c6fd2b0e445d2273263b64cb2e4d74" title="The address of the mortran STACK common block as a pointer to a C-structure of type EGS_Stack...">the_stack</a>-&gt;<a name="a31"></a><a class="code" href="structEGS__Stack.html#abe62f2d6c7aa86780efeb28a158d8111">npold</a>-1] = 1;
        }
        rr_flag = 0; <span class="keywordflow">return</span> 0;
    }
    <span class="comment">/*</span>
<span class="comment">    if( iarg == FluorescentEvent &amp;&amp; the_stack-&gt;latch[np] &gt; 0 ) {</span>
<span class="comment">        the_stack-&gt;latch[np] = 0; the_stack-&gt;wt[np] /= the_egsvr-&gt;i_do_rr;</span>
<span class="comment">        if( np+1+the_egsvr-&gt;i_do_rr &gt; MXSTACK )</span>
<span class="comment">            egsFatal(&quot;Stack size exceeded while splitting dluorescent photon!\n&quot;);</span>
<span class="comment">        for(int j=1; j&lt;the_egsvr-&gt;i_do_rr; j++) {</span>
<span class="comment">            EGS_Float cost = 2*rndm-&gt;getUniform()-1;</span>
<span class="comment">            EGS_Float sint = 1 - cost*cost; sint = sint &gt; 0 ? sqrt(sint) : 0;</span>
<span class="comment">            EGS_Float cphi, sphi; rndm-&gt;getAzimuth(cphi,sphi);</span>
<span class="comment">            the_stack-&gt;E[np+j] = the_stack-&gt;E[np];</span>
<span class="comment">            the_stack-&gt;wt[np+j] = the_stack-&gt;wt[np];</span>
<span class="comment">            the_stack-&gt;iq[np+j] = the_stack-&gt;iq[np];</span>
<span class="comment">            the_stack-&gt;ir[np+j] = the_stack-&gt;ir[np];</span>
<span class="comment">            the_stack-&gt;dnear[np+j] = the_stack-&gt;dnear[np];</span>
<span class="comment">            the_stack-&gt;latch[np+j] = the_stack-&gt;latch[np];</span>
<span class="comment">            the_stack-&gt;x[np+j] = the_stack-&gt;x[np];</span>
<span class="comment">            the_stack-&gt;y[np+j] = the_stack-&gt;y[np];</span>
<span class="comment">            the_stack-&gt;z[np+j] = the_stack-&gt;z[np];</span>
<span class="comment">            the_stack-&gt;u[np+j] = sint*cphi;</span>
<span class="comment">            the_stack-&gt;v[np+j] = sint*sphi;</span>
<span class="comment">            the_stack-&gt;w[np+j] = cost;</span>
<span class="comment">        }</span>
<span class="comment">    }</span>
<span class="comment">    */</span>


    <span class="keywordflow">return</span> 0;
}

<span class="keywordtype">int</span> Tutor7_Application::outputData() {
    <span class="keywordtype">int</span> err = <a name="a32"></a><a class="code" href="classEGS__AdvancedApplication.html#a5938d12d44e755accaacd79aa92c805c" title="Output intermediate results.">EGS_AdvancedApplication::outputData</a>();
    <span class="keywordflow">if</span>( err ) <span class="keywordflow">return</span> err;
</pre></div> We then write our own data to the data stream pointed to by <a class="el" href="classEGS__Application.html#ab382f1b191803900a08a11decdd71714">data_out</a>: the total energy deposited so far <div class="fragment"><pre class="fragment">    (*data_out) &lt;&lt; <span class="stringliteral">&quot;  &quot;</span> &lt;&lt; Etot &lt;&lt; endl;
</pre></div> the energy fractions accumulated in the scorring array <div class="fragment"><pre class="fragment">    <span class="keywordflow">if</span>( !score-&gt;storeState(*data_out) ) <span class="keywordflow">return</span> 101;
</pre></div> and the pulse height distribution results <div class="fragment"><pre class="fragment">    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0; j&lt;nph; j++) {
        <span class="keywordflow">if</span>( !pheight[j]-&gt;storeState(*data_out) ) <span class="keywordflow">return</span> 102+j;
    }
    <span class="keywordflow">if</span>( !eflu-&gt;storeState(*data_out) ) <span class="keywordflow">return</span> 301;
    <span class="keywordflow">if</span>( !gflu-&gt;storeState(*data_out) ) <span class="keywordflow">return</span> 302;
    <span class="keywordflow">return</span> 0;
}
</pre></div> Note that <a class="el" href="classEGS__Application.html#ab382f1b191803900a08a11decdd71714">data_out</a> is set up to point to the output stream created by opening the <code>.egsdat</code> file for writing in the base application class.</p>
<p>The function directly innverse to <code>outputData</code>() is <code>readData</code>(). The implementation is therefore basically the same as <code>outputData</code>() except that now we read the data from the stream pointed to by <a class="el" href="classEGS__Application.html#a978476a101fc626a2cfa8d2c18a244f9">data_in</a>: <div class="fragment"><pre class="fragment">
<span class="keywordtype">int</span> Tutor7_Application::readData() {
    <span class="keywordtype">int</span> err = <a name="a33"></a><a class="code" href="classEGS__AdvancedApplication.html#a06f19f07a28df1d2384ee29addace191" title="Read intermediate results.">EGS_AdvancedApplication::readData</a>();
    <span class="keywordflow">if</span>( err ) <span class="keywordflow">return</span> err;
    (*data_in) &gt;&gt; Etot;
    <span class="keywordflow">if</span>( !score-&gt;setState(*data_in) ) <span class="keywordflow">return</span> 101;
    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0; j&lt;nph; j++) {
        <span class="keywordflow">if</span>( !pheight[j]-&gt;setState(*data_in) ) <span class="keywordflow">return</span> 102+j;
    }
    <span class="keywordflow">if</span>( !eflu-&gt;setState(*data_in) ) <span class="keywordflow">return</span> 301;
    <span class="keywordflow">if</span>( !gflu-&gt;setState(*data_in) ) <span class="keywordflow">return</span> 302;
    <span class="keywordflow">return</span> 0;
}
</pre></div></p>
<p>The <code>resetCounter</code>() function, which is needed for combining parallel runs and is called before the loop over available data files, must put our application class into a state with zero particles simulated. We therefore use the base class function to reset the data of the base application class, <div class="fragment"><pre class="fragment">
<span class="keywordtype">void</span> Tutor7_Application::resetCounter() {
    <a name="a34"></a><a class="code" href="classEGS__AdvancedApplication.html#a014bd195880a2870c8e194a4e70ca65d" title="Reset the application to a &amp;#39;pristine&amp;#39; state.">EGS_AdvancedApplication::resetCounter</a>();
</pre></div> set the total energy deposited to zero and use the <a class="el" href="classEGS__ScoringArray.html#ab53979299221381cf4388be409246c16">reset() </a> functions of the scoring arrays to reset these: <div class="fragment"><pre class="fragment">    score-&gt;reset(); Etot = 0;
    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0; j&lt;nph; j++) pheight[j]-&gt;reset();
    eflu-&gt;reset(); gflu-&gt;reset();
}
</pre></div></p>
<p>The <code>addState</code>() function is used to combine the results of parallel runs. It is therefore similar to the <code>readData</code>() function except that now the data read from the input stream is added to the existing data instead of replacing the state of the application with these data. We therefore use the base class <code>addState</code>() function, <div class="fragment"><pre class="fragment">
<span class="keywordtype">int</span> Tutor7_Application::addState(istream &amp;data) {
    <span class="keywordtype">int</span> err = <a name="a35"></a><a class="code" href="classEGS__AdvancedApplication.html#afcbb19952d15adab639d67aae2db166c" title="Add data from a parallel job.">EGS_AdvancedApplication::addState</a>(data);
    <span class="keywordflow">if</span>( err ) <span class="keywordflow">return</span> err;
</pre></div> add the total energy deposited into the geometry, <div class="fragment"><pre class="fragment">    <span class="keywordtype">double</span> etot_tmp; data &gt;&gt; etot_tmp; Etot += etot_tmp;
</pre></div> construct a temporary scoring array object with <code>nreg+2</code> regions, <div class="fragment"><pre class="fragment">    <a class="code" href="classEGS__ScoringArray.html" title="A class for scoring an array of quantities (e.g. a dose distribution) in a Monte Carlo simulation...">EGS_ScoringArray</a> tmp(nreg+2);
</pre></div> read the data into this object, <div class="fragment"><pre class="fragment">    <span class="keywordflow">if</span>( !tmp.<a name="a36"></a><a class="code" href="classEGS__ScoringArray.html#ae205fe3537ce313f7af805487bf22bdc" title="Sets the state fof the scoring array object from the data in the input stream data.">setState</a>(data) ) <span class="keywordflow">return</span> 101;
</pre></div> and add it to the existing data <div class="fragment"><pre class="fragment">    (*score) += tmp;
</pre></div> We do the same for the pulse height distributions: <div class="fragment"><pre class="fragment">    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0; j&lt;nph; j++) {
        <a class="code" href="classEGS__ScoringArray.html" title="A class for scoring an array of quantities (e.g. a dose distribution) in a Monte Carlo simulation...">EGS_ScoringArray</a> tmpj(pheight[j]-&gt;bins());
        <span class="keywordflow">if</span>( !tmpj.<a class="code" href="classEGS__ScoringArray.html#ae205fe3537ce313f7af805487bf22bdc" title="Sets the state fof the scoring array object from the data in the input stream data.">setState</a>(data) ) <span class="keywordflow">return</span> 102 + j;
        (*pheight[j]) += tmpj;
    }
    <a class="code" href="classEGS__ScoringArray.html" title="A class for scoring an array of quantities (e.g. a dose distribution) in a Monte Carlo simulation...">EGS_ScoringArray</a> tmp1(200);
    <span class="keywordflow">if</span>( !tmp1.setState(data) ) <span class="keywordflow">return</span> 301;
    (*eflu) += tmp1;
    <span class="keywordflow">if</span>( !tmp1.setState(data) ) <span class="keywordflow">return</span> 302;
    (*gflu) += tmp1;
    <span class="keywordflow">return</span> 0;
}
</pre></div></p>
<p>The <code>outputResults</code>() function must output the results of a simulation into the logfile (or the standard output, if the application is run interactively). In our implementation we first inform the user about the last statistically independent history simulated and the total energy deposited into the geometry: <div class="fragment"><pre class="fragment">
<span class="keywordtype">void</span> Tutor7_Application::outputResults() {
    <a class="code" href="group__egspp__main.html#ga38c38ac950788399c630481c2b3722f2" title="Always use this function for reporting the progress of a simulation and any other type of information...">egsInformation</a>(<span class="stringliteral">&quot;\n\n last case = %d Etot = %g\n&quot;</span>,
            (<span class="keywordtype">int</span>)current_case,Etot);
</pre></div> We then use the <a class="el" href="classEGS__ScoringArray.html#ae79f7eea52619c97d3d82850602f8180">reportResults() </a> method of the energy fractions scoring array to report the deposited energy fractions: <div class="fragment"><pre class="fragment">    <span class="keywordtype">double</span> norm = ((double)current_case)/Etot;
    score-&gt;reportResults(norm,
            <span class="stringliteral">&quot;Reflected/deposited/transmitted energy fraction&quot;</span>,<span class="keyword">false</span>,
            <span class="stringliteral">&quot;  %d  %12.6e +/- %12.6e %c\n&quot;</span>);
</pre></div> Because the scoring array object divides the results by the number of statistically independent showers (<code>last_case</code>) but we want the normalization to be fraction of the energy deposited, we set the normalization constant to be <code>last_case/Etot</code>. The string passed as a second argument will be output as a title and the <code>false</code> argument indicates that we want the uncertainties to be absolute instead of relative as percent of the local result. The last argument is a format string used to output the result. If omitted or set to <code>null</code>, a default format string will be used (using a g format for outputing the floating numbers). If the user has requested the calculation of one or more pulse height distributions (<em>i.e</em>. <code>nph&gt;0</code>), we output a title depending on the number of distributions calculated: <div class="fragment"><pre class="fragment">    <span class="keywordflow">if</span>( nph &gt; 0 ) {
        <span class="keywordflow">if</span>( nph &gt; 1 ) <a class="code" href="group__egspp__main.html#ga38c38ac950788399c630481c2b3722f2" title="Always use this function for reporting the progress of a simulation and any other type of information...">egsInformation</a>(<span class="stringliteral">&quot;\n\n Pulse height distributions\n&quot;</span>
                <span class="stringliteral">&quot;==========================\n\n&quot;</span>);
        <span class="keywordflow">else</span> <a class="code" href="group__egspp__main.html#ga38c38ac950788399c630481c2b3722f2" title="Always use this function for reporting the progress of a simulation and any other type of information...">egsInformation</a>(<span class="stringliteral">&quot;\n\n Pulse height distribution in region %d\n&quot;</span>
                <span class="stringliteral">&quot;==========================================\n\n&quot;</span>,
                ph_regions[0]);
</pre></div> and then in a loop over the number of pulse height distributions calculated <div class="fragment"><pre class="fragment">        <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0; j&lt;nph; j++) {
            <span class="keywordflow">if</span>( nph &gt; 1 ) <a class="code" href="group__egspp__main.html#ga38c38ac950788399c630481c2b3722f2" title="Always use this function for reporting the progress of a simulation and any other type of information...">egsInformation</a>(<span class="stringliteral">&quot;Region %d\n&quot;</span>
                    <span class="stringliteral">&quot;----------------\n\n&quot;</span>,ph_regions[j]);
</pre></div> we have a loop over the number of bins for the pulse height distribution in this region, obtain the result from the scoring array and output a data triplet consisting of the midpoint energy of the bin, the result in the bin and the uncertainty of the result: <div class="fragment"><pre class="fragment">            <span class="keywordtype">double</span> f,df;
            <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;pheight[j]-&gt;bins(); i++) {
                pheight[j]-&gt;currentResult(i,f,df);
                <a class="code" href="group__egspp__main.html#ga38c38ac950788399c630481c2b3722f2" title="Always use this function for reporting the progress of a simulation and any other type of information...">egsInformation</a>(<span class="stringliteral">&quot;%g   %g   %g\n&quot;</span>,ph_de[j]*(0.5+i),
                        f/ph_de[j],df/ph_de[j]);
            }
        }
    }
    EGS_Float Rmax = 20; EGS_Float dr = Rmax/200;
    <span class="comment">/*</span>
<span class="comment">    egsInformation(&quot;\n\n Electron/Photon fluence at back of geometry as a function of radial distance\n&quot;</span>
<span class="comment">                        &quot;============================================================================\n&quot;);</span>
<span class="comment">    for(int j=0; j&lt;200; ++j) {</span>
<span class="comment">        double fe,dfe,fg,dfg;</span>
<span class="comment">        eflu-&gt;currentResult(j,fe,dfe); gflu-&gt;currentResult(j,fg,dfg);</span>
<span class="comment">        EGS_Float r1 = dr*j, r2 = r1 + dr;</span>
<span class="comment">        EGS_Float A = M_PI*(r2*r2 - r1*r1);</span>
<span class="comment">        EGS_Float r = j &gt; 0 ? 0.5*(r1 + r2) : 0;</span>
<span class="comment">        egsInformation(&quot;%9.3f  %15.6e  %15.6e  %15.6e  %15.6e\n&quot;,r,fe/A,dfe/A,fg/A,dfg/A);</span>
<span class="comment">    }</span>
</pre></div> Because the scoring array object already divides by the number of statistically independent events, we only divide by the bin width to have the results normalized as counts per incident particle per MeV.</p>
<p>The <code>getCurrentResult</code>() function is used by the <a class="el" href="classEGS__RunControl.html">run control object </a> to provide a single result for our simulation that is the combined result from all jobs in parallel runs. We arbitrarily decide to define the single result of our simulation monitored at run time as the energy fraction reflected (stored in the zeroth region of the <code>score</code> scoring array). Hence, the implementation of this function looks like this: <div class="fragment"><pre class="fragment">    */
}
</pre></div></p>
<p>In the <code>startNewShower</code>() function we must collect the energy being imparted into the geometry and inform our scoring objects when the simulation of a new statistically independent event begins. In addition, we implement the scoring of the requested pulse height distributions (PHD) here. We start by collecting the energy entering the geometry <div class="fragment"><pre class="fragment">
<span class="keywordtype">void</span> Tutor7_Application::getCurrentResult(<span class="keywordtype">double</span> &amp;sum, <span class="keywordtype">double</span> &amp;sum2,
        <span class="keywordtype">double</span> &amp;norm, <span class="keywordtype">double</span> &amp;count) {
    count = current_case;
    norm = Etot &gt; 0 ? count/Etot : 0;
    score-&gt;currentScore(0,sum,sum2);
}

<span class="keywordtype">int</span> Tutor7_Application::startNewShower() {
    Etot += p.E*p.wt;
</pre></div> The parameters of the particle that is about to be simulated are available in the <a class="el" href="classEGS__Application.html#a6fd58166cb82b03b7861e0a2352d7494">EGS_Application::p</a> protected data member. We then check if the particle about to be simulated is statistically independent from the last particle simulated by comparing the inherited protected data members <a class="el" href="classEGS__Application.html#a8b9c94245bddeb84bbda1af8018d12f2" title="The current case as returned from the source.">EGS_Application::current_case</a> and <a class="el" href="classEGS__Application.html#a3b6078556ea6054228474eba59351cc5" title="The last case simulated.">EGS_Application::last_case</a>: <div class="fragment"><pre class="fragment">    <span class="keywordtype">int</span> res = <a name="a37"></a><a class="code" href="classEGS__Application.html#a2a3aa6b3640802f7cd72b6679f589380" title="Called just before the shower() function.">EGS_Application::startNewShower</a>();
    <span class="keywordflow">if</span>( res ) <span class="keywordflow">return</span> res;
    <span class="keywordflow">if</span>( current_case != last_case ) {
</pre></div> If they are the same, then the two particles belong to the same statistically independent case and we don't need to do anything. This can happen <em>e.g</em>. when using a <a class="el" href="classEGS__PhspSource.html">phase space file </a> or a <a class="el" href="classEGS__BeamSource.html">BEAM simulation source </a>, see <em>e.g</em>. [Walters <em>et.al</em>., Med.Phys. 29 (2002) 2745] for a detailed discussion of the correct implementation of a history-by-history statistical analysis. If the user has requested the calculation of PHDs (<em>i.e</em>. <code>nph&gt;0</code>), we loop over all requested PHDs <div class="fragment"><pre class="fragment">        <span class="keywordflow">if</span>( nph &gt; 0 ) {
            <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0; j&lt;nph; j++) {
</pre></div> inform the scoring array used to collect this PHD that a new statistically independent event is about to begin, <div class="fragment"><pre class="fragment">                pheight[j]-&gt;setHistory(current_case);
</pre></div> obtain the energy deposited in the PHD region in the last statistically independent shower, <div class="fragment"><pre class="fragment">                <span class="keywordtype">int</span> ireg = ph_regions[j];
                EGS_Float edep = score-&gt;currentScore(ireg);
</pre></div> and, if this energy is greater than zero, determine the PHD bin to which such an energy deposition belongs and add a count to this PHD bin <div class="fragment"><pre class="fragment">                <span class="keywordflow">if</span>( edep &gt; 0 ) {
                    <span class="keywordtype">int</span> ibin = (int) (edep/(current_weight*ph_de[j]));
                    <span class="keywordflow">if</span>( ibin &gt;= 0 &amp;&amp; ibin &lt; pheight[j]-&gt;bins() )
                        pheight[j]-&gt;score(ibin,1);

                }
            }
        }
</pre></div> Note that in the above we divide by <code>current_weight</code>. This is needed because all energy depositions are weighted with the particle weights that may not be constant and also may be different from unity (<em>e.g</em>. for a <a class="el" href="classEGS__CollimatedSource.html">collimated point source </a>). We remember the statistical weight of the particles intiating the showers in <code>current_weight</code> (see below). We then inform the energy deposition scoring array that a new statistically independent event begins <div class="fragment"><pre class="fragment">        score-&gt;setHistory(current_case);
</pre></div> and set the last simulated case to the current case <div class="fragment"><pre class="fragment">        eflu-&gt;setHistory(current_case);
        gflu-&gt;setHistory(current_case);
        last_case = current_case;
    }
</pre></div> and remember the statistical weight of the incident particle. <div class="fragment"><pre class="fragment">    current_weight = p.wt;
    <span class="keywordflow">return</span> 0;
}
</pre></div></p>
<p>This completes the implementation of our Tutor7_Application class. One needs more code compared to an application derived from <a class="el" href="classEGS__SimpleApplication.html" title="A base class for developing simple EGSnrc applications.">EGS_SimpleApplication</a> (see <em>e.g</em>. <a href="tutor2pp_8cpp-example.html">this example</a>). However, a closer examination shows that a significant part of the code is neede to implement the restart/parallel runs/combine results functionality and to provide the user with the capability to specify the regions for PHD calculation in the input file. Without this added functionality, the tutor7pp source code would be not much longer than tutor2pp.</p>
<p>We now need a short <code>main</code> function. We construct an instance of the Tutor7_Application class passing the command line arguments to its constructor <div class="fragment"><pre class="fragment">
<span class="preprocessor">#ifdef BUILD_APP_LIB</span>
<span class="preprocessor">APP_LIB(Tutor7_Application);</span>
</pre></div> We then initialize the application <div class="fragment"><pre class="fragment"></pre></div> and return the error code if some error occured (<em>e.g</em>. the cross section data for the media in the geometry was not found in the specified PEGS data file, there was a mistake in the specification of the geometry, etc.) <div class="fragment"><pre class="fragment"></pre></div> We then run the simulation <div class="fragment"><pre class="fragment"></pre></div> and return the error code if some error occured, <div class="fragment"><pre class="fragment"></pre></div> otherwise we finish the simulation <div class="fragment"><pre class="fragment"></pre></div> That's all.</p>
<p>The final step is to provide a Makefile for our application. We will use the standard makefile for building C++ applications provided with the EGSnrc distribution. To do so, we include the make config files,  <div class="fragment"><pre class="fragment">include $(EGS_CONFIG)
include $(SPEC_DIR)egspp.spec
include $(SPEC_DIR)egspp_$(my_machine).conf
</pre></div> set the application name <div class="fragment"><pre class="fragment"></pre></div> specify that no additional macros are needed to build the EGSnrc mortran back-end, <div class="fragment"><pre class="fragment"></pre></div> specify that we are deriving from <a class="el" href="classEGS__AdvancedApplication.html" title="Base class for advanced EGSnrc applications based on the mortran EGSnrc back-end.">EGS_AdvancedApplication</a>, <div class="fragment"><pre class="fragment"></pre></div> specify the set of mortran sources to be the predefined set of sources for advanced applications, <div class="fragment"><pre class="fragment"></pre></div> the additional header files that our application depends upon, <div class="fragment"><pre class="fragment"></pre></div> and finally include the standard set of rules for building C++ applications <div class="fragment"><pre class="fragment"></pre></div></p>
<p>Here is the complete source code of the tutor7pp application:</p>
<div class="fragment"><pre class="fragment"><span class="comment">/*</span>
<span class="comment">###############################################################################</span>
<span class="comment">#</span>
<span class="comment">#  EGSnrc egs++ tutor7pp application</span>
<span class="comment">#  Copyright (C) 2015 National Research Council Canada</span>
<span class="comment">#</span>
<span class="comment">#  This file is part of EGSnrc.</span>
<span class="comment">#</span>
<span class="comment">#  EGSnrc is free software: you can redistribute it and/or modify it under</span>
<span class="comment">#  the terms of the GNU Affero General Public License as published by the</span>
<span class="comment">#  Free Software Foundation, either version 3 of the License, or (at your</span>
<span class="comment">#  option) any later version.</span>
<span class="comment">#</span>
<span class="comment">#  EGSnrc is distributed in the hope that it will be useful, but WITHOUT ANY</span>
<span class="comment">#  WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</span>
<span class="comment">#  FOR A PARTICULAR PURPOSE.  See the GNU Affero General Public License for</span>
<span class="comment">#  more details.</span>
<span class="comment">#</span>
<span class="comment">#  You should have received a copy of the GNU Affero General Public License</span>
<span class="comment">#  along with EGSnrc. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="comment">#</span>
<span class="comment">###############################################################################</span>
<span class="comment">#</span>
<span class="comment">#  Author:          Iwan Kawrakow, 2005</span>
<span class="comment">#</span>
<span class="comment">#  Contributors:    Frederic Tessier</span>
<span class="comment">#</span>
<span class="comment">###############################################################################</span>
<span class="comment">#</span>
<span class="comment">#  A relatively simple EGSnrc application using the C++ interface. It</span>
<span class="comment">#  implements the functionality of the original tutor7 tutorial code written</span>
<span class="comment">#  in mortran except that now, due to the use of the general geometry and</span>
<span class="comment">#  source packages included in egspp, any geometry or any source can be used</span>
<span class="comment">#  in the simulation.</span>
<span class="comment">#</span>
<span class="comment">#  In addition, tutor7pp derives from the EGS_AdvancedApplication class and</span>
<span class="comment">#  therefore automatically inherits the ability to do restarted and parallel</span>
<span class="comment">#  simulations, to combine the results of parallel runs or to re-analyze the</span>
<span class="comment">#  results of single/parallel runs. It also inherits the ability to run for a</span>
<span class="comment">#  user specified maximum amount of cpu time or to terminate the simulation</span>
<span class="comment">#  when a user specified uncertainty has been reached.</span>
<span class="comment">#</span>
<span class="comment">#</span>
<span class="comment">#  TERMINOLOGY</span>
<span class="comment">#  -----------</span>
<span class="comment">#</span>
<span class="comment">#  Simulations are split into &#39;chunks&#39;. For simple simulations (no parallel</span>
<span class="comment">#  runs, etc.) there is a single simulation chunk with the number of</span>
<span class="comment">#  histories specified in the input file. For parallel runs the number of</span>
<span class="comment">#  chunks and number of histories per chunk are determined by a &#39;run control</span>
<span class="comment">#  object&#39; (see below).</span>
<span class="comment">#</span>
<span class="comment">#  Each simulation chunk is split into &#39;batches&#39;. The batches are not required</span>
<span class="comment">#  for statistical analysis (by using the provided scoring classes it is easy</span>
<span class="comment">#  to have a history-by-history uncertainty estimation). Instead, simulation</span>
<span class="comment">#  chunks are split into batches so that the progress of the simulation can be</span>
<span class="comment">#  reported after the completion of a batch and the current results can be</span>
<span class="comment">#  stored into a data file. By default there are 10 batches per simulation chunk</span>
<span class="comment">#  but this can be changed in the input file.</span>
<span class="comment">#</span>
<span class="comment">#  The simulation is controlled via a &#39;run control object&#39; (RCO) The purpose</span>
<span class="comment">#  of the run control object is to give to the shower loop the number of</span>
<span class="comment">#  histories per simulation chunk, number of batches per chunk and to possibly</span>
<span class="comment">#  terminate the simulation prematurely if certain conditions are met (e.g.</span>
<span class="comment">#  maximum cpu time allowed is exceeded or the required uncertainty has been</span>
<span class="comment">#  reached).</span>
<span class="comment">#</span>
<span class="comment">#  egs++ provides 2 run control objects:</span>
<span class="comment">#</span>
<span class="comment">#  1)  simple:  the simple RCO always uses a single simulation chunk.</span>
<span class="comment">#</span>
<span class="comment">#  2)  JCF:     a JCF object is used by default for parallel runs</span>
<span class="comment">#               JCF stands for Job Control File as this type of object</span>
<span class="comment">#               uses a file placed in the user code directory to record</span>
<span class="comment">#               the number of histories remaining, the number of jobs</span>
<span class="comment">#               running, etc., in parallel runs. This is explained in</span>
<span class="comment">#               more details in PIRS-877. A JCF object uses by default</span>
<span class="comment">#               10 simulation chunks but this can be changed in the</span>
<span class="comment">#               input file.</span>
<span class="comment">#</span>
<span class="comment">#  It is possible to use a simple control object for parallel runs by giving</span>
<span class="comment">#  the -s or --simple command line option. In this case, each parallel job</span>
<span class="comment">#  will run the number of histories specified in the input file but</span>
<span class="comment">#  automatically adjust the initial random number seed(s) with the job index.</span>
<span class="comment">#  This additional possibility has been implemented because several users have</span>
<span class="comment">#  reported problems with file locking needed for a JCF run control object.</span>
<span class="comment">#</span>
<span class="comment">#  It is also possible to have other RCO&#39;s compiled into shared libraries and</span>
<span class="comment">#  automatically loaded at run time (e.g., one could implement a RCO that</span>
<span class="comment">#  communicates via TCP/IP with a remote server to obtain the number of</span>
<span class="comment">#  histories in the next simulation chunk).</span>
<span class="comment">#</span>
<span class="comment">#</span>
<span class="comment">#  USAGE</span>
<span class="comment">#  -----</span>
<span class="comment">#</span>
<span class="comment">#  - Geometry and particle source are specified in an input file as explained</span>
<span class="comment">#    in PIRS-899 and PIRS-898.</span>
<span class="comment">#</span>
<span class="comment">#  - Run control is specified in a section of the input file delimited by</span>
<span class="comment">#    :start run control: and :stop run control: labels.</span>
<span class="comment">#</span>
<span class="comment">#  - A simple RCO is used for single job runs.</span>
<span class="comment">#</span>
<span class="comment">#  - A JCF RCO is used by default for parallel runs, unless -s or --simple</span>
<span class="comment">#    is specified on the command line.</span>
<span class="comment">#</span>
<span class="comment">#  - A simple RCO understands the following keys:</span>
<span class="comment">#    ncase                       = number of histories to run</span>
<span class="comment">#    nbatch                      = number of batches to use</span>
<span class="comment">#    statistical accuracy sought = required uncertainty, in %</span>
<span class="comment">#    max cpu hours allowed       = max. processor time allowed</span>
<span class="comment">#    calculation                 = first | restart | combine | analyze</span>
<span class="comment">#</span>
<span class="comment">#    All inputs except for ncase are optional (a missing ncase key will result</span>
<span class="comment">#    in a simulation with 0 particles).</span>
<span class="comment">#</span>
<span class="comment">#  - A JCF object understands all the above keys plus</span>
<span class="comment">#    nchunk = number of simulation chunks</span>
<span class="comment">#</span>
<span class="comment">#  - The simulation is run using</span>
<span class="comment">#</span>
<span class="comment">#    tutor7pp -i input_file -p pegs_file [-o output_file] [-s] [-P n -j i]</span>
<span class="comment">#</span>
<span class="comment">#    where command line arguments between [] are optional. The -P n option</span>
<span class="comment">#    specifies the number of parallel jobs n and -j i the index of this job.</span>
<span class="comment">#    On Linux/Unix systems it is more convenient to use the &#39;exb&#39; script for</span>
<span class="comment">#    parallel job submission (see PIRS-877)</span>
<span class="comment">#</span>
<span class="comment">###############################################################################</span>
<span class="comment">*/</span>


<span class="preprocessor">#include &quot;<a class="code" href="egs__advanced__application_8h.html" title="EGS_AdvancedApplication class header file.">egs_advanced_application.h</a>&quot;</span>
<span class="preprocessor">#include &quot;<a class="code" href="egs__scoring_8h.html" title="Scoring classes.">egs_scoring.h</a>&quot;</span>
<span class="preprocessor">#include &quot;<a class="code" href="egs__interface2_8h.html" title="This file defines the C/C++ interface to the EGSnrc mortran back-end.">egs_interface2.h</a>&quot;</span>
<span class="preprocessor">#include &quot;<a class="code" href="egs__functions_8h.html" title="Global egspp functions.">egs_functions.h</a>&quot;</span>
<span class="preprocessor">#include &quot;<a class="code" href="egs__input_8h.html" title="EGS_Input header file.">egs_input.h</a>&quot;</span>
<span class="preprocessor">#include &quot;<a class="code" href="egs__base__source_8h.html" title="Base particle source header file.">egs_base_source.h</a>&quot;</span>
<span class="preprocessor">#include &quot;<a class="code" href="egs__rndm_8h.html" title="Base random number generator.">egs_rndm.h</a>&quot;</span>

<span class="preprocessor">#include &lt;cstdlib&gt;</span>
<span class="keyword">using namespace </span>std;

<span class="keyword">class </span>APP_EXPORT Tutor7_Application : <span class="keyword">public</span> <a class="code" href="classEGS__AdvancedApplication.html" title="Base class for advanced EGSnrc applications based on the mortran EGSnrc back-end.">EGS_AdvancedApplication</a> {

    <span class="keywordtype">double</span>           Etot;      <span class="comment">// total energy that has entered the geometry</span>
    <a class="code" href="classEGS__ScoringArray.html" title="A class for scoring an array of quantities (e.g. a dose distribution) in a Monte Carlo simulation...">EGS_ScoringArray</a> *score;    <span class="comment">// scoring array with energies deposited</span>
    <a class="code" href="classEGS__ScoringArray.html" title="A class for scoring an array of quantities (e.g. a dose distribution) in a Monte Carlo simulation...">EGS_ScoringArray</a> *eflu;     <span class="comment">// scoring array for electron fluence at back of geometry</span>
    <a class="code" href="classEGS__ScoringArray.html" title="A class for scoring an array of quantities (e.g. a dose distribution) in a Monte Carlo simulation...">EGS_ScoringArray</a> *gflu;     <span class="comment">// scoring array for photon fluence at back of geometry</span>
    <a class="code" href="classEGS__ScoringArray.html" title="A class for scoring an array of quantities (e.g. a dose distribution) in a Monte Carlo simulation...">EGS_ScoringArray</a> **pheight; <span class="comment">// pulse height distributions.</span>
    EGS_Float        *ph_de;    <span class="comment">// bin widths if the pulse height distributions.</span>
    <span class="keywordtype">int</span>              *ph_regions; <span class="comment">// region indeces of the ph-dsitributions</span>
    <span class="keywordtype">int</span>              nreg;      <span class="comment">// number of regions in the geometry</span>
    <span class="keywordtype">int</span>              nph;       <span class="comment">// number of pulse height objects.</span>
    <span class="keywordtype">int</span>              rr_flag;   <span class="comment">// used for RR and radiative splitting</span>
    EGS_Float        current_weight; <span class="comment">// the weight of the initial particle that</span>
                                     <span class="comment">// is currently being simulated</span>
    <span class="keywordtype">bool</span>  deflect_brems;
    <span class="keyword">static</span> <span class="keywordtype">string</span> revision;    <span class="comment">// the CVS revision number</span>

<span class="keyword">public</span>:

    Tutor7_Application(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv) :
        <a class="code" href="classEGS__AdvancedApplication.html" title="Base class for advanced EGSnrc applications based on the mortran EGSnrc back-end.">EGS_AdvancedApplication</a>(argc,argv), score(0), eflu(0), gflu(0), pheight(0),
        nreg(0), nph(0), Etot(0), rr_flag(0), current_weight(1), deflect_brems(<span class="keyword">false</span>) { };

    ~Tutor7_Application() {
        <span class="keywordflow">if</span>( score ) <span class="keyword">delete</span> score;
        <span class="keywordflow">if</span>( eflu ) <span class="keyword">delete</span> eflu;
        <span class="keywordflow">if</span>( gflu ) <span class="keyword">delete</span> gflu;
        <span class="keywordflow">if</span>( nph &gt; 0 ) {
            <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0; j&lt;nph; j++) <span class="keyword">delete</span> pheight[j];
            <span class="keyword">delete</span> [] pheight; <span class="keyword">delete</span> [] ph_regions; <span class="keyword">delete</span> [] ph_de;
        }
    };

    <span class="keywordtype">void</span> describeUserCode() <span class="keyword">const</span>;

    <span class="keywordtype">int</span> initScoring();

    <span class="keywordtype">int</span> ausgab(<span class="keywordtype">int</span> iarg);

    <span class="keywordtype">int</span> outputData();

    <span class="keywordtype">int</span> readData();

    <span class="keywordtype">void</span> resetCounter();

    <span class="keywordtype">int</span> addState(istream &amp;data);

    <span class="keywordtype">void</span> outputResults();

    <span class="keywordtype">void</span> getCurrentResult(<span class="keywordtype">double</span> &amp;sum, <span class="keywordtype">double</span> &amp;sum2, <span class="keywordtype">double</span> &amp;norm,
            <span class="keywordtype">double</span> &amp;count);

<span class="keyword">protected</span>:

    <span class="keywordtype">int</span> startNewShower();


};

<span class="keywordtype">string</span> Tutor7_Application::revision = <span class="stringliteral">&quot;$Revision: 1.13 $&quot;</span>;

<span class="keyword">extern</span> <span class="stringliteral">&quot;C&quot;</span> <span class="keywordtype">void</span> F77_OBJ_(egs_scale_xcc,EGS_SCALE_XCC)(<span class="keyword">const</span> <span class="keywordtype">int</span> *,<span class="keyword">const</span> EGS_Float *);
<span class="keyword">extern</span> <span class="stringliteral">&quot;C&quot;</span> <span class="keywordtype">void</span> F77_OBJ_(egs_scale_bc,EGS_SCALE_BC)(<span class="keyword">const</span> <span class="keywordtype">int</span> *,<span class="keyword">const</span> EGS_Float *);

<span class="keywordtype">void</span> Tutor7_Application::describeUserCode()<span class="keyword"> const </span>{
   <a class="code" href="group__egspp__main.html#ga38c38ac950788399c630481c2b3722f2" title="Always use this function for reporting the progress of a simulation and any other type of information...">egsInformation</a>(
     <span class="stringliteral">&quot;\n               ***************************************************&quot;</span>
     <span class="stringliteral">&quot;\n               *                                                 *&quot;</span>
     <span class="stringliteral">&quot;\n               *                  tutor7pp                       *&quot;</span>
     <span class="stringliteral">&quot;\n               *                                                 *&quot;</span>
     <span class="stringliteral">&quot;\n               ***************************************************&quot;</span>
     <span class="stringliteral">&quot;\n\n&quot;</span>);
   <a class="code" href="group__egspp__main.html#ga38c38ac950788399c630481c2b3722f2" title="Always use this function for reporting the progress of a simulation and any other type of information...">egsInformation</a>(<span class="stringliteral">&quot;This is Tutor7_Application %s based on\n&quot;</span>
     <span class="stringliteral">&quot;      EGS_AdvancedApplication %s\n\n&quot;</span>,
     <a class="code" href="group__egspp__main.html#ga93d32bad171fae0575c0ea56cbdd4290" title="Remove the $&amp;#39;s from a CVS key.">egsSimplifyCVSKey</a>(revision).c_str(),
     <a class="code" href="group__egspp__main.html#ga93d32bad171fae0575c0ea56cbdd4290" title="Remove the $&amp;#39;s from a CVS key.">egsSimplifyCVSKey</a>(base_revision).c_str());
}

<span class="keywordtype">int</span> Tutor7_Application::initScoring() {
    <span class="comment">// Get the numner of regions in the geometry.</span>
    nreg = geometry-&gt;regions();
    score = <span class="keyword">new</span> <a class="code" href="classEGS__ScoringArray.html" title="A class for scoring an array of quantities (e.g. a dose distribution) in a Monte Carlo simulation...">EGS_ScoringArray</a>(nreg+2);
     <span class="comment">//i.e. we always score energy fractions</span>
    eflu = <span class="keyword">new</span> <a class="code" href="classEGS__ScoringArray.html" title="A class for scoring an array of quantities (e.g. a dose distribution) in a Monte Carlo simulation...">EGS_ScoringArray</a>(200); gflu = <span class="keyword">new</span> <a class="code" href="classEGS__ScoringArray.html" title="A class for scoring an array of quantities (e.g. a dose distribution) in a Monte Carlo simulation...">EGS_ScoringArray</a>(200);
    <a class="code" href="classEGS__Input.html" title="A class for storing information in a tree-like structure of key-value pairs. This class is used throu...">EGS_Input</a> *options = input-&gt;<a class="code" href="classEGS__Input.html#a1fb7e11391a1ab33c23321633d035781" title="Get the property named key.">takeInputItem</a>(<span class="stringliteral">&quot;scoring options&quot;</span>);
    <span class="keywordflow">if</span>( options ) {

        <a class="code" href="classEGS__Input.html" title="A class for storing information in a tree-like structure of key-value pairs. This class is used throu...">EGS_Input</a> *scale;
        <span class="keywordflow">while</span>( (scale = options-&gt;<a class="code" href="classEGS__Input.html#a1fb7e11391a1ab33c23321633d035781" title="Get the property named key.">takeInputItem</a>(<span class="stringliteral">&quot;scale xcc&quot;</span>)) ) {
            vector&lt;string&gt; tmp;
            <span class="keywordtype">int</span> err = scale-&gt;<a class="code" href="classEGS__Input.html#a154f3de14ebb23c3e78316b40b33b719" title="Assign values to an array of strings from an input identified by key.">getInput</a>(<span class="stringliteral">&quot;scale xcc&quot;</span>,tmp);
            <span class="comment">//egsInformation(&quot;Found &#39;scale xcc&#39;, err=%d tmp.size()=%d\n&quot;,err,tmp.size());</span>
            <span class="keywordflow">if</span>( !err &amp;&amp; tmp.size() == 2 ) {
                <span class="keywordtype">int</span> imed = <a class="code" href="classEGS__BaseGeometry.html#adb608c74a77dcd0979baa72da5b6cd2f" title="Get the index of a medium named medname.">EGS_BaseGeometry::getMediumIndex</a>(tmp[0]) + 1;
                <span class="keywordflow">if</span>( imed &gt; 0 ) {
                    EGS_Float fac = atof(tmp[1].c_str());
                    <a class="code" href="group__egspp__main.html#ga38c38ac950788399c630481c2b3722f2" title="Always use this function for reporting the progress of a simulation and any other type of information...">egsInformation</a>(<span class="stringliteral">&quot;\n ***** Scaling xcc of medium %d with %g\n&quot;</span>,imed,fac);
                    F77_OBJ_(egs_scale_xcc,EGS_SCALE_XCC)(&amp;imed,&amp;fac);
                }
            }
            <span class="keyword">delete</span> scale;
        }
        <span class="keywordflow">while</span>( (scale = options-&gt;<a class="code" href="classEGS__Input.html#a1fb7e11391a1ab33c23321633d035781" title="Get the property named key.">takeInputItem</a>(<span class="stringliteral">&quot;scale bc&quot;</span>)) ) {
            vector&lt;string&gt; tmp;
            <span class="keywordtype">int</span> err = scale-&gt;<a class="code" href="classEGS__Input.html#a154f3de14ebb23c3e78316b40b33b719" title="Assign values to an array of strings from an input identified by key.">getInput</a>(<span class="stringliteral">&quot;scale bc&quot;</span>,tmp);
            <span class="comment">//egsInformation(&quot;Found &#39;scale xcc&#39;, err=%d tmp.size()=%d\n&quot;,err,tmp.size());</span>
            <span class="keywordflow">if</span>( !err &amp;&amp; tmp.size() == 2 ) {
                <span class="keywordtype">int</span> imed = <a class="code" href="classEGS__BaseGeometry.html#adb608c74a77dcd0979baa72da5b6cd2f" title="Get the index of a medium named medname.">EGS_BaseGeometry::getMediumIndex</a>(tmp[0]) + 1;
                <span class="keywordflow">if</span>( imed &gt; 0 ) {
                    EGS_Float fac = atof(tmp[1].c_str());
                    <a class="code" href="group__egspp__main.html#ga38c38ac950788399c630481c2b3722f2" title="Always use this function for reporting the progress of a simulation and any other type of information...">egsInformation</a>(<span class="stringliteral">&quot;\n ***** Scaling bc of medium %d with %g\n&quot;</span>,imed,fac);
                    F77_OBJ_(egs_scale_bc,EGS_SCALE_BC)(&amp;imed,&amp;fac);
                }
            }
            <span class="keyword">delete</span> scale;
        }

        vector&lt;string&gt; choices; choices.push_back(<span class="stringliteral">&quot;no&quot;</span>); choices.push_back(<span class="stringliteral">&quot;yes&quot;</span>);
        deflect_brems = options-&gt;<a class="code" href="classEGS__Input.html#a154f3de14ebb23c3e78316b40b33b719" title="Assign values to an array of strings from an input identified by key.">getInput</a>(<span class="stringliteral">&quot;deflect electron after brems&quot;</span>,choices,0);
        <span class="keywordflow">if</span>( deflect_brems ) {
            <a class="code" href="group__egspp__main.html#ga38c38ac950788399c630481c2b3722f2" title="Always use this function for reporting the progress of a simulation and any other type of information...">egsInformation</a>(<span class="stringliteral">&quot;\n *** Using electron deflection in brems events\n\n&quot;</span>);
            setAusgabCall(AfterBrems,<span class="keyword">true</span>);
        }

        <span class="keywordtype">int</span> n_rr;
        <span class="keywordflow">if</span>( !options-&gt;<a class="code" href="classEGS__Input.html#a154f3de14ebb23c3e78316b40b33b719" title="Assign values to an array of strings from an input identified by key.">getInput</a>(<span class="stringliteral">&quot;Russian Roulette&quot;</span>,n_rr) &amp;&amp; n_rr &gt; 1 ) {
            <a class="code" href="egs__interface2_8h.html#a0023d201c8c03e188ebf9943f6951af7" title="The address of the mortran egs_vr common block as a pointer to a C-structure of type EGS_VarianceRedu...">the_egsvr</a>-&gt;<a class="code" href="structEGS__VarianceReduction.html#ade261c730784e1debd811957bf23a5eb">i_do_rr</a> = n_rr;
            setAusgabCall(BeforeBrems,<span class="keyword">true</span>);
            setAusgabCall(AfterBrems,<span class="keyword">true</span>);
            setAusgabCall(BeforeAnnihFlight,<span class="keyword">true</span>);
            setAusgabCall(AfterAnnihFlight,<span class="keyword">true</span>);
            setAusgabCall(BeforeAnnihRest,<span class="keyword">true</span>);
            setAusgabCall(AfterAnnihRest,<span class="keyword">true</span>);
            <span class="comment">//setAusgabCall(FluorescentEvent,true);</span>
            <a class="code" href="group__egspp__main.html#ga38c38ac950788399c630481c2b3722f2" title="Always use this function for reporting the progress of a simulation and any other type of information...">egsInformation</a>(<span class="stringliteral">&quot;\nUsing Russian Roulette with survival probability 1/%d\n&quot;</span>,n_rr);
        }

        <span class="comment">// The user has provided scoring options input.</span>
        <span class="comment">// See where she/he wants to score a pulse height distribution</span>
        <span class="comment">// and how many bins to use for each pulse height distribution</span>
        vector&lt;int&gt; regions;
        <span class="keywordtype">int</span> err = options-&gt;<a class="code" href="classEGS__Input.html#a154f3de14ebb23c3e78316b40b33b719" title="Assign values to an array of strings from an input identified by key.">getInput</a>(<span class="stringliteral">&quot;pulse height regions&quot;</span>,regions);
        vector&lt;int&gt; nbins;
        <span class="keywordtype">int</span> err1 = options-&gt;<a class="code" href="classEGS__Input.html#a154f3de14ebb23c3e78316b40b33b719" title="Assign values to an array of strings from an input identified by key.">getInput</a>(<span class="stringliteral">&quot;pulse height bins&quot;</span>,nbins);
        <span class="keywordflow">if</span>( !err &amp;&amp; !err1 ) {
            <span class="keywordflow">if</span>( regions.size() != nbins.size() &amp;&amp; nbins.size() != 1 )
                    <a class="code" href="group__egspp__main.html#gadf4109d942f372e48e1dea86c0ca62cb" title="Always use this function for reporting warnings.">egsWarning</a>(<span class="stringliteral">&quot;initScoring(): you must input the same &quot;</span>
                <span class="stringliteral">&quot;number of &#39;regions&#39; and &#39;bins&#39; inputs or a single &#39;bins&#39;&quot;</span>
                <span class="stringliteral">&quot; input\n&quot;</span>);
            <span class="keywordflow">else</span> {
                <a class="code" href="classEGS__ScoringArray.html" title="A class for scoring an array of quantities (e.g. a dose distribution) in a Monte Carlo simulation...">EGS_ScoringArray</a> **tmp = <span class="keyword">new</span> <a class="code" href="classEGS__ScoringArray.html" title="A class for scoring an array of quantities (e.g. a dose distribution) in a Monte Carlo simulation...">EGS_ScoringArray</a>* [nreg+2];
                <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;nreg+2; i++) tmp[i] = 0;
                <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0; j&lt;regions.size(); j++) {
                    <span class="keywordtype">int</span> nb = nbins.size() == 1 ? nbins[0] : nbins[j];
                    <span class="keywordflow">if</span>( nb &lt; 1 )
                        <a class="code" href="group__egspp__main.html#gadf4109d942f372e48e1dea86c0ca62cb" title="Always use this function for reporting warnings.">egsWarning</a>(<span class="stringliteral">&quot;zero bins for region %d?\n&quot;</span>,regions[j]);
                    <span class="keywordflow">if</span>( regions[j] &lt; 0 || regions[j] &gt; nreg+1 )
                        <a class="code" href="group__egspp__main.html#gadf4109d942f372e48e1dea86c0ca62cb" title="Always use this function for reporting warnings.">egsWarning</a>(<span class="stringliteral">&quot;invalid region index %d\n&quot;</span>,regions[j]);
                    <span class="keywordflow">if</span>( nb &gt; 0 &amp;&amp; regions[j] &gt;= 0 &amp;&amp; regions[j] &lt; nreg+2 ){
                        <span class="keywordtype">int</span> ij = regions[j];
                        <span class="keywordflow">if</span>( tmp[ij] ) <a class="code" href="group__egspp__main.html#ga38c38ac950788399c630481c2b3722f2" title="Always use this function for reporting the progress of a simulation and any other type of information...">egsInformation</a>(<span class="stringliteral">&quot;There is already a &quot;</span>
                  <span class="stringliteral">&quot;PHD object in region %d =&gt; ignoring it\n&quot;</span>,ij);
                        <span class="keywordflow">else</span> { tmp[ij] = <span class="keyword">new</span> <a class="code" href="classEGS__ScoringArray.html" title="A class for scoring an array of quantities (e.g. a dose distribution) in a Monte Carlo simulation...">EGS_ScoringArray</a>(nb); ++nph; }
                    }
                }
                <span class="keywordflow">if</span>( nph &gt; 0 ) {
                    pheight = <span class="keyword">new</span> <a class="code" href="classEGS__ScoringArray.html" title="A class for scoring an array of quantities (e.g. a dose distribution) in a Monte Carlo simulation...">EGS_ScoringArray</a>* [nph];
                    ph_regions = <span class="keyword">new</span> <span class="keywordtype">int</span> [nph];
                    ph_de = <span class="keyword">new</span> EGS_Float [nph];
                    EGS_Float Emax = source-&gt;getEmax();
                    <span class="keywordtype">int</span> iph = 0;
                    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0; j&lt;nreg+2; j++) {
                        <span class="keywordflow">if</span>( tmp[j] ) {
                            pheight[iph] = tmp[j];
                            ph_regions[iph] = j;
                            <span class="keywordtype">int</span> nbin = pheight[iph]-&gt;<a class="code" href="classEGS__ScoringArray.html#a022d5676d6934ba40bc6d416591e2f56" title="Returns the number of bins (or elements or regions, the most appropriate term depending on the way th...">bins</a>();
                            ph_de[iph++] = Emax/nbin;
                        }
                    }
                }
                <span class="keyword">delete</span> [] tmp;
            }
        } <span class="keywordflow">else</span> <a class="code" href="group__egspp__main.html#gadf4109d942f372e48e1dea86c0ca62cb" title="Always use this function for reporting warnings.">egsWarning</a>(<span class="stringliteral">&quot;initScoring(): you must provide both, &#39;regions&#39;&quot;</span>
                   <span class="stringliteral">&quot; and &#39;bins&#39; input\n&quot;</span>);
        <span class="keyword">delete</span> options;
    }
    <span class="keywordflow">return</span> 0;
}

<span class="keywordtype">int</span> Tutor7_Application::ausgab(<span class="keywordtype">int</span> iarg) {
    <span class="keywordflow">if</span>( iarg &lt;= 4 ) {
        <span class="keywordtype">int</span> np = <a class="code" href="egs__interface2_8h.html#ad3c6fd2b0e445d2273263b64cb2e4d74" title="The address of the mortran STACK common block as a pointer to a C-structure of type EGS_Stack...">the_stack</a>-&gt;<a class="code" href="structEGS__Stack.html#af5e322d06055d31869c5c45cb6e462d1">np</a> - 1; <span class="keywordtype">int</span> ir = <a class="code" href="egs__interface2_8h.html#ad3c6fd2b0e445d2273263b64cb2e4d74" title="The address of the mortran STACK common block as a pointer to a C-structure of type EGS_Stack...">the_stack</a>-&gt;<a class="code" href="structEGS__Stack.html#a7b57f3b0571707c6bb4cb4f65720af75">ir</a>[np]-1;
        <span class="keywordflow">if</span>( ir == 0 &amp;&amp; <a class="code" href="egs__interface2_8h.html#ad3c6fd2b0e445d2273263b64cb2e4d74" title="The address of the mortran STACK common block as a pointer to a C-structure of type EGS_Stack...">the_stack</a>-&gt;<a class="code" href="structEGS__Stack.html#a792b83be2582af5596c36966e634d748">w</a>[np] &gt; 0 ) ir = nreg+1;
        score-&gt;score(ir,<a class="code" href="egs__interface2_8h.html#a0e5931e71c4f14d863e2fe3a5f508e14" title="The address of the mortran EPCONT common block as a pointer to a C-structure of type EGS_Epcont...">the_epcont</a>-&gt;<a class="code" href="structEGS__Epcont.html#a4a37133c1fbcbfe96cffab989a9c2633">edep</a>*<a class="code" href="egs__interface2_8h.html#ad3c6fd2b0e445d2273263b64cb2e4d74" title="The address of the mortran STACK common block as a pointer to a C-structure of type EGS_Stack...">the_stack</a>-&gt;<a class="code" href="structEGS__Stack.html#abde65475db0a8c4350dadf06a7ac2375">wt</a>[np]);
        <span class="comment">// if( the_stack-&gt;iq[np] ) score-&gt;score(ir,the_epcont-&gt;edep*the_stack-&gt;wt[np]);</span>
        <span class="keywordflow">if</span>( ir == nreg+1 ) {
            <a class="code" href="classEGS__ScoringArray.html" title="A class for scoring an array of quantities (e.g. a dose distribution) in a Monte Carlo simulation...">EGS_ScoringArray</a> *flu = <a class="code" href="egs__interface2_8h.html#ad3c6fd2b0e445d2273263b64cb2e4d74" title="The address of the mortran STACK common block as a pointer to a C-structure of type EGS_Stack...">the_stack</a>-&gt;<a class="code" href="structEGS__Stack.html#a9a8a5f250531ac78188175d4903abd4d">iq</a>[np] ? eflu : gflu;
            EGS_Float r2 = <a class="code" href="egs__interface2_8h.html#ad3c6fd2b0e445d2273263b64cb2e4d74" title="The address of the mortran STACK common block as a pointer to a C-structure of type EGS_Stack...">the_stack</a>-&gt;<a class="code" href="structEGS__Stack.html#a3e1893b08c58c1930215b05ffd3b200c">x</a>[np]*<a class="code" href="egs__interface2_8h.html#ad3c6fd2b0e445d2273263b64cb2e4d74" title="The address of the mortran STACK common block as a pointer to a C-structure of type EGS_Stack...">the_stack</a>-&gt;<a class="code" href="structEGS__Stack.html#a3e1893b08c58c1930215b05ffd3b200c">x</a>[np] + <a class="code" href="egs__interface2_8h.html#ad3c6fd2b0e445d2273263b64cb2e4d74" title="The address of the mortran STACK common block as a pointer to a C-structure of type EGS_Stack...">the_stack</a>-&gt;<a class="code" href="structEGS__Stack.html#abaeb3b4d4df09253d62ecf9c866a75b5">y</a>[np]*<a class="code" href="egs__interface2_8h.html#ad3c6fd2b0e445d2273263b64cb2e4d74" title="The address of the mortran STACK common block as a pointer to a C-structure of type EGS_Stack...">the_stack</a>-&gt;<a class="code" href="structEGS__Stack.html#abaeb3b4d4df09253d62ecf9c866a75b5">y</a>[np];
            <span class="keywordflow">if</span>( r2 &lt; 400 ) {
                <span class="keywordtype">int</span> bin = (int) (sqrt(r2)*10.);
                flu-&gt;<a class="code" href="classEGS__ScoringArray.html#a9a2cc351e95c8a224ae5a571aa99638d" title="Add f to the score in the element ireg.">score</a>(bin,<a class="code" href="egs__interface2_8h.html#ad3c6fd2b0e445d2273263b64cb2e4d74" title="The address of the mortran STACK common block as a pointer to a C-structure of type EGS_Stack...">the_stack</a>-&gt;<a class="code" href="structEGS__Stack.html#abde65475db0a8c4350dadf06a7ac2375">wt</a>[np]/<a class="code" href="egs__interface2_8h.html#ad3c6fd2b0e445d2273263b64cb2e4d74" title="The address of the mortran STACK common block as a pointer to a C-structure of type EGS_Stack...">the_stack</a>-&gt;<a class="code" href="structEGS__Stack.html#a792b83be2582af5596c36966e634d748">w</a>[np]);
            }
        }
        <span class="keywordflow">return</span> 0;
    }
    <span class="keywordtype">int</span> np = <a class="code" href="egs__interface2_8h.html#ad3c6fd2b0e445d2273263b64cb2e4d74" title="The address of the mortran STACK common block as a pointer to a C-structure of type EGS_Stack...">the_stack</a>-&gt;<a class="code" href="structEGS__Stack.html#af5e322d06055d31869c5c45cb6e462d1">np</a>-1;
    <span class="keywordflow">if</span>( iarg == BeforeBrems || iarg == BeforeAnnihRest || iarg == BeforeAnnihFlight &amp;&amp;
        <a class="code" href="egs__interface2_8h.html#ad3c6fd2b0e445d2273263b64cb2e4d74" title="The address of the mortran STACK common block as a pointer to a C-structure of type EGS_Stack...">the_stack</a>-&gt;<a class="code" href="structEGS__Stack.html#afaaf57ba783e01b7f0a0aeb6fbe0447c">latch</a>[np] &gt; 0 ) {
        <a class="code" href="egs__interface2_8h.html#ad3c6fd2b0e445d2273263b64cb2e4d74" title="The address of the mortran STACK common block as a pointer to a C-structure of type EGS_Stack...">the_stack</a>-&gt;<a class="code" href="structEGS__Stack.html#afaaf57ba783e01b7f0a0aeb6fbe0447c">latch</a>[np] = 0; rr_flag = 1;
        <a class="code" href="egs__interface2_8h.html#a0023d201c8c03e188ebf9943f6951af7" title="The address of the mortran egs_vr common block as a pointer to a C-structure of type EGS_VarianceRedu...">the_egsvr</a>-&gt;<a class="code" href="structEGS__VarianceReduction.html#a81248fb91da28fad36740687608583db">nbr_split</a> = <a class="code" href="egs__interface2_8h.html#a0023d201c8c03e188ebf9943f6951af7" title="The address of the mortran egs_vr common block as a pointer to a C-structure of type EGS_VarianceRedu...">the_egsvr</a>-&gt;<a class="code" href="structEGS__VarianceReduction.html#ade261c730784e1debd811957bf23a5eb">i_do_rr</a>; <span class="keywordflow">return</span> 0;
    }
    <span class="keywordflow">if</span>( iarg == AfterBrems &amp;&amp; deflect_brems ) {
        <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> u(<a class="code" href="egs__interface2_8h.html#ad3c6fd2b0e445d2273263b64cb2e4d74" title="The address of the mortran STACK common block as a pointer to a C-structure of type EGS_Stack...">the_stack</a>-&gt;<a class="code" href="structEGS__Stack.html#abcce3249128b99879d88aefc0e747adb">u</a>[np-1],<a class="code" href="egs__interface2_8h.html#ad3c6fd2b0e445d2273263b64cb2e4d74" title="The address of the mortran STACK common block as a pointer to a C-structure of type EGS_Stack...">the_stack</a>-&gt;<a class="code" href="structEGS__Stack.html#a74269a7153ecdc20f966ac7e7a4900e3">v</a>[np-1],<a class="code" href="egs__interface2_8h.html#ad3c6fd2b0e445d2273263b64cb2e4d74" title="The address of the mortran STACK common block as a pointer to a C-structure of type EGS_Stack...">the_stack</a>-&gt;<a class="code" href="structEGS__Stack.html#a792b83be2582af5596c36966e634d748">w</a>[np-1]);
        EGS_Float tau = <a class="code" href="egs__interface2_8h.html#ad3c6fd2b0e445d2273263b64cb2e4d74" title="The address of the mortran STACK common block as a pointer to a C-structure of type EGS_Stack...">the_stack</a>-&gt;<a class="code" href="structEGS__Stack.html#a054b5f967362fb583b08aa141d44d274">E</a>[np-1]/<a class="code" href="egs__interface2_8h.html#a0672b754e821b69e7fb77eff1c412bc9" title="The address of the mortran USEFUL common block as a pointer to a C-structure of type EGS_Useful...">the_useful</a>-&gt;<a class="code" href="structEGS__Useful.html#a65779a8f4b47d673a45c274fadcde881" title="Electron rest energy.">rm</a> - 1;
        EGS_Float beta = sqrt(tau*(tau+2))/(tau+1);
        EGS_Float eta = 2*rndm-&gt;getUniform()-1;
        EGS_Float cost = (beta + eta)/(1 + beta*eta);
        EGS_Float sint = 1 - cost*cost;
        <span class="keywordflow">if</span>( sint &gt; 0 ) {
            sint = sqrt(sint); EGS_Float cphi, sphi;
            rndm-&gt;getAzimuth(cphi,sphi); u.rotate(cost,sint,cphi,sphi);
            <a class="code" href="egs__interface2_8h.html#ad3c6fd2b0e445d2273263b64cb2e4d74" title="The address of the mortran STACK common block as a pointer to a C-structure of type EGS_Stack...">the_stack</a>-&gt;<a class="code" href="structEGS__Stack.html#abcce3249128b99879d88aefc0e747adb">u</a>[np-1] = u.x;
            <a class="code" href="egs__interface2_8h.html#ad3c6fd2b0e445d2273263b64cb2e4d74" title="The address of the mortran STACK common block as a pointer to a C-structure of type EGS_Stack...">the_stack</a>-&gt;<a class="code" href="structEGS__Stack.html#a74269a7153ecdc20f966ac7e7a4900e3">v</a>[np-1] = u.y;
            <a class="code" href="egs__interface2_8h.html#ad3c6fd2b0e445d2273263b64cb2e4d74" title="The address of the mortran STACK common block as a pointer to a C-structure of type EGS_Stack...">the_stack</a>-&gt;<a class="code" href="structEGS__Stack.html#a792b83be2582af5596c36966e634d748">w</a>[np-1] = u.z;
        }
    }

    <span class="keywordflow">if</span>( iarg == AfterBrems || iarg == AfterAnnihRest || iarg == AfterAnnihFlight ) {
        <a class="code" href="egs__interface2_8h.html#a0023d201c8c03e188ebf9943f6951af7" title="The address of the mortran egs_vr common block as a pointer to a C-structure of type EGS_VarianceRedu...">the_egsvr</a>-&gt;<a class="code" href="structEGS__VarianceReduction.html#a81248fb91da28fad36740687608583db">nbr_split</a> = 1;
        <span class="keywordflow">if</span>( iarg == AfterBrems &amp;&amp; rr_flag ) {
            <a class="code" href="egs__interface2_8h.html#ad3c6fd2b0e445d2273263b64cb2e4d74" title="The address of the mortran STACK common block as a pointer to a C-structure of type EGS_Stack...">the_stack</a>-&gt;<a class="code" href="structEGS__Stack.html#afaaf57ba783e01b7f0a0aeb6fbe0447c">latch</a>[<a class="code" href="egs__interface2_8h.html#ad3c6fd2b0e445d2273263b64cb2e4d74" title="The address of the mortran STACK common block as a pointer to a C-structure of type EGS_Stack...">the_stack</a>-&gt;<a class="code" href="structEGS__Stack.html#abe62f2d6c7aa86780efeb28a158d8111">npold</a>-1] = 1;
        }
        rr_flag = 0; <span class="keywordflow">return</span> 0;
    }
    <span class="comment">/*</span>
<span class="comment">    if( iarg == FluorescentEvent &amp;&amp; the_stack-&gt;latch[np] &gt; 0 ) {</span>
<span class="comment">        the_stack-&gt;latch[np] = 0; the_stack-&gt;wt[np] /= the_egsvr-&gt;i_do_rr;</span>
<span class="comment">        if( np+1+the_egsvr-&gt;i_do_rr &gt; MXSTACK )</span>
<span class="comment">            egsFatal(&quot;Stack size exceeded while splitting dluorescent photon!\n&quot;);</span>
<span class="comment">        for(int j=1; j&lt;the_egsvr-&gt;i_do_rr; j++) {</span>
<span class="comment">            EGS_Float cost = 2*rndm-&gt;getUniform()-1;</span>
<span class="comment">            EGS_Float sint = 1 - cost*cost; sint = sint &gt; 0 ? sqrt(sint) : 0;</span>
<span class="comment">            EGS_Float cphi, sphi; rndm-&gt;getAzimuth(cphi,sphi);</span>
<span class="comment">            the_stack-&gt;E[np+j] = the_stack-&gt;E[np];</span>
<span class="comment">            the_stack-&gt;wt[np+j] = the_stack-&gt;wt[np];</span>
<span class="comment">            the_stack-&gt;iq[np+j] = the_stack-&gt;iq[np];</span>
<span class="comment">            the_stack-&gt;ir[np+j] = the_stack-&gt;ir[np];</span>
<span class="comment">            the_stack-&gt;dnear[np+j] = the_stack-&gt;dnear[np];</span>
<span class="comment">            the_stack-&gt;latch[np+j] = the_stack-&gt;latch[np];</span>
<span class="comment">            the_stack-&gt;x[np+j] = the_stack-&gt;x[np];</span>
<span class="comment">            the_stack-&gt;y[np+j] = the_stack-&gt;y[np];</span>
<span class="comment">            the_stack-&gt;z[np+j] = the_stack-&gt;z[np];</span>
<span class="comment">            the_stack-&gt;u[np+j] = sint*cphi;</span>
<span class="comment">            the_stack-&gt;v[np+j] = sint*sphi;</span>
<span class="comment">            the_stack-&gt;w[np+j] = cost;</span>
<span class="comment">        }</span>
<span class="comment">    }</span>
<span class="comment">    */</span>


    <span class="keywordflow">return</span> 0;
}

<span class="keywordtype">int</span> Tutor7_Application::outputData() {
    <span class="comment">// We first call the outputData() function of our base class.</span>
    <span class="comment">// This takes care of saving data related to the source, the random</span>
    <span class="comment">// number generator, CPU time used, number of histories, etc.</span>
    <span class="keywordtype">int</span> err = <a class="code" href="classEGS__AdvancedApplication.html#a5938d12d44e755accaacd79aa92c805c" title="Output intermediate results.">EGS_AdvancedApplication::outputData</a>();
    <span class="keywordflow">if</span>( err ) <span class="keywordflow">return</span> err;
    <span class="comment">// We then write our own data to the data stream. data_out is</span>
    <span class="comment">// a pointer to a data stream that has been opened for writing</span>
    <span class="comment">// in the base class.</span>
    (*data_out) &lt;&lt; <span class="stringliteral">&quot;  &quot;</span> &lt;&lt; Etot &lt;&lt; endl;
    <span class="keywordflow">if</span>( !score-&gt;storeState(*data_out) ) <span class="keywordflow">return</span> 101;
    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0; j&lt;nph; j++) {
        <span class="keywordflow">if</span>( !pheight[j]-&gt;storeState(*data_out) ) <span class="keywordflow">return</span> 102+j;
    }
    <span class="keywordflow">if</span>( !eflu-&gt;storeState(*data_out) ) <span class="keywordflow">return</span> 301;
    <span class="keywordflow">if</span>( !gflu-&gt;storeState(*data_out) ) <span class="keywordflow">return</span> 302;
    <span class="keywordflow">return</span> 0;
}

<span class="keywordtype">int</span> Tutor7_Application::readData() {
    <span class="comment">// We first call the readData() function of our base class.</span>
    <span class="comment">// This takes care of reading data related to the source, the random</span>
    <span class="comment">// number generator, CPU time used, number of histories, etc.</span>
    <span class="comment">// (everything that was stored by the base class outputData() method).</span>
    <span class="keywordtype">int</span> err = <a class="code" href="classEGS__AdvancedApplication.html#a06f19f07a28df1d2384ee29addace191" title="Read intermediate results.">EGS_AdvancedApplication::readData</a>();
    <span class="keywordflow">if</span>( err ) <span class="keywordflow">return</span> err;
    <span class="comment">// We then read our own data from the data stream.</span>
    <span class="comment">// data_in is a pointer to an input stream that has been opened</span>
    <span class="comment">// by the base class.</span>
    (*data_in) &gt;&gt; Etot;
    <span class="keywordflow">if</span>( !score-&gt;setState(*data_in) ) <span class="keywordflow">return</span> 101;
    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0; j&lt;nph; j++) {
        <span class="keywordflow">if</span>( !pheight[j]-&gt;setState(*data_in) ) <span class="keywordflow">return</span> 102+j;
    }
    <span class="keywordflow">if</span>( !eflu-&gt;setState(*data_in) ) <span class="keywordflow">return</span> 301;
    <span class="keywordflow">if</span>( !gflu-&gt;setState(*data_in) ) <span class="keywordflow">return</span> 302;
    <span class="keywordflow">return</span> 0;
}

<span class="keywordtype">void</span> Tutor7_Application::resetCounter() {
    <span class="comment">// Reset everything in the base class</span>
    <a class="code" href="classEGS__AdvancedApplication.html#a014bd195880a2870c8e194a4e70ca65d" title="Reset the application to a &amp;#39;pristine&amp;#39; state.">EGS_AdvancedApplication::resetCounter</a>();
    <span class="comment">// Reset our own data to zero.</span>
    score-&gt;reset(); Etot = 0;
    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0; j&lt;nph; j++) pheight[j]-&gt;reset();
    eflu-&gt;reset(); gflu-&gt;reset();
}

<span class="keywordtype">int</span> Tutor7_Application::addState(istream &amp;data) {
    <span class="comment">// Call first the base class addState() function to read and add</span>
    <span class="comment">// all data related to source, RNG, CPU time, etc.</span>
    <span class="keywordtype">int</span> err = <a class="code" href="classEGS__AdvancedApplication.html#afcbb19952d15adab639d67aae2db166c" title="Add data from a parallel job.">EGS_AdvancedApplication::addState</a>(data);
    <span class="keywordflow">if</span>( err ) <span class="keywordflow">return</span> err;
    <span class="comment">// Then read our own data to temporary variables and add to</span>
    <span class="comment">// our results.</span>
    <span class="keywordtype">double</span> etot_tmp; data &gt;&gt; etot_tmp; Etot += etot_tmp;
    <a class="code" href="classEGS__ScoringArray.html" title="A class for scoring an array of quantities (e.g. a dose distribution) in a Monte Carlo simulation...">EGS_ScoringArray</a> tmp(nreg+2);
    <span class="keywordflow">if</span>( !tmp.<a class="code" href="classEGS__ScoringArray.html#ae205fe3537ce313f7af805487bf22bdc" title="Sets the state fof the scoring array object from the data in the input stream data.">setState</a>(data) ) <span class="keywordflow">return</span> 101;
    (*score) += tmp;
    <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0; j&lt;nph; j++) {
        <a class="code" href="classEGS__ScoringArray.html" title="A class for scoring an array of quantities (e.g. a dose distribution) in a Monte Carlo simulation...">EGS_ScoringArray</a> tmpj(pheight[j]-&gt;bins());
        <span class="keywordflow">if</span>( !tmpj.setState(data) ) <span class="keywordflow">return</span> 102 + j;
        (*pheight[j]) += tmpj;
    }
    <a class="code" href="classEGS__ScoringArray.html" title="A class for scoring an array of quantities (e.g. a dose distribution) in a Monte Carlo simulation...">EGS_ScoringArray</a> tmp1(200);
    <span class="keywordflow">if</span>( !tmp1.setState(data) ) <span class="keywordflow">return</span> 301;
    (*eflu) += tmp1;
    <span class="keywordflow">if</span>( !tmp1.setState(data) ) <span class="keywordflow">return</span> 302;
    (*gflu) += tmp1;
    <span class="keywordflow">return</span> 0;
}

<span class="keywordtype">void</span> Tutor7_Application::outputResults() {
    <a class="code" href="group__egspp__main.html#ga38c38ac950788399c630481c2b3722f2" title="Always use this function for reporting the progress of a simulation and any other type of information...">egsInformation</a>(<span class="stringliteral">&quot;\n\n last case = %d Etot = %g\n&quot;</span>,
            (<span class="keywordtype">int</span>)current_case,Etot);
    <span class="keywordtype">double</span> norm = ((double)current_case)/Etot;
    score-&gt;reportResults(norm,
            <span class="stringliteral">&quot;Reflected/deposited/transmitted energy fraction&quot;</span>,<span class="keyword">false</span>,
            <span class="stringliteral">&quot;  %d  %12.6e +/- %12.6e %c\n&quot;</span>);
    <span class="keywordflow">if</span>( nph &gt; 0 ) {
        <span class="keywordflow">if</span>( nph &gt; 1 ) <a class="code" href="group__egspp__main.html#ga38c38ac950788399c630481c2b3722f2" title="Always use this function for reporting the progress of a simulation and any other type of information...">egsInformation</a>(<span class="stringliteral">&quot;\n\n Pulse height distributions\n&quot;</span>
                <span class="stringliteral">&quot;==========================\n\n&quot;</span>);
        <span class="keywordflow">else</span> <a class="code" href="group__egspp__main.html#ga38c38ac950788399c630481c2b3722f2" title="Always use this function for reporting the progress of a simulation and any other type of information...">egsInformation</a>(<span class="stringliteral">&quot;\n\n Pulse height distribution in region %d\n&quot;</span>
                <span class="stringliteral">&quot;==========================================\n\n&quot;</span>,
                ph_regions[0]);
        <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0; j&lt;nph; j++) {
            <span class="keywordflow">if</span>( nph &gt; 1 ) <a class="code" href="group__egspp__main.html#ga38c38ac950788399c630481c2b3722f2" title="Always use this function for reporting the progress of a simulation and any other type of information...">egsInformation</a>(<span class="stringliteral">&quot;Region %d\n&quot;</span>
                    <span class="stringliteral">&quot;----------------\n\n&quot;</span>,ph_regions[j]);
            <span class="keywordtype">double</span> f,df;
            <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;pheight[j]-&gt;bins(); i++) {
                pheight[j]-&gt;currentResult(i,f,df);
                <a class="code" href="group__egspp__main.html#ga38c38ac950788399c630481c2b3722f2" title="Always use this function for reporting the progress of a simulation and any other type of information...">egsInformation</a>(<span class="stringliteral">&quot;%g   %g   %g\n&quot;</span>,ph_de[j]*(0.5+i),
                        f/ph_de[j],df/ph_de[j]);
            }
        }
    }
    EGS_Float Rmax = 20; EGS_Float dr = Rmax/200;
    <span class="comment">/*</span>
<span class="comment">    egsInformation(&quot;\n\n Electron/Photon fluence at back of geometry as a function of radial distance\n&quot;</span>
<span class="comment">                        &quot;============================================================================\n&quot;);</span>
<span class="comment">    for(int j=0; j&lt;200; ++j) {</span>
<span class="comment">        double fe,dfe,fg,dfg;</span>
<span class="comment">        eflu-&gt;currentResult(j,fe,dfe); gflu-&gt;currentResult(j,fg,dfg);</span>
<span class="comment">        EGS_Float r1 = dr*j, r2 = r1 + dr;</span>
<span class="comment">        EGS_Float A = M_PI*(r2*r2 - r1*r1);</span>
<span class="comment">        EGS_Float r = j &gt; 0 ? 0.5*(r1 + r2) : 0;</span>
<span class="comment">        egsInformation(&quot;%9.3f  %15.6e  %15.6e  %15.6e  %15.6e\n&quot;,r,fe/A,dfe/A,fg/A,dfg/A);</span>
<span class="comment">    }</span>
<span class="comment">    */</span>
}

<span class="keywordtype">void</span> Tutor7_Application::getCurrentResult(<span class="keywordtype">double</span> &amp;sum, <span class="keywordtype">double</span> &amp;sum2,
        <span class="keywordtype">double</span> &amp;norm, <span class="keywordtype">double</span> &amp;count) {
    count = current_case;
    norm = Etot &gt; 0 ? count/Etot : 0;
    score-&gt;currentScore(0,sum,sum2);
}

<span class="keywordtype">int</span> Tutor7_Application::startNewShower() {
    Etot += p.E*p.wt;
    <span class="keywordtype">int</span> res = <a class="code" href="classEGS__Application.html#a2a3aa6b3640802f7cd72b6679f589380" title="Called just before the shower() function.">EGS_Application::startNewShower</a>();
    <span class="keywordflow">if</span>( res ) <span class="keywordflow">return</span> res;
    <span class="keywordflow">if</span>( current_case != last_case ) {
        <span class="keywordflow">if</span>( nph &gt; 0 ) {
            <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0; j&lt;nph; j++) {
                pheight[j]-&gt;setHistory(current_case);
                <span class="keywordtype">int</span> ireg = ph_regions[j];
                EGS_Float edep = score-&gt;currentScore(ireg);
                <span class="keywordflow">if</span>( edep &gt; 0 ) {
                    <span class="keywordtype">int</span> ibin = (int) (edep/(current_weight*ph_de[j]));
                    <span class="keywordflow">if</span>( ibin &gt;= 0 &amp;&amp; ibin &lt; pheight[j]-&gt;bins() )
                        pheight[j]-&gt;score(ibin,1);

                }
            }
        }
        score-&gt;setHistory(current_case);
        eflu-&gt;setHistory(current_case);
        gflu-&gt;setHistory(current_case);
        last_case = current_case;
    }
    current_weight = p.wt;
    <span class="keywordflow">return</span> 0;
}

<span class="preprocessor">#ifdef BUILD_APP_LIB</span>
<span class="preprocessor"></span>APP_LIB(Tutor7_Application);
<span class="preprocessor">#else</span>
<span class="preprocessor"></span>APP_MAIN(Tutor7_Application);
<span class="preprocessor">#endif</span>
</pre></div> </div>
</div>
<hr class="footer"/><address class="footer"><small>Generated by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.3 </small></address>
</body>
</html>
