<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>EGSnrc C++ class library: /home/ftessier/EGSnrc/github/EGSnrc-doc/HEN_HOUSE/egs++/geometry/egs_nd_geometry/egs_nd_geometry.h Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.3 -->
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">EGSnrc C++ class library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>/home/ftessier/EGSnrc/github/EGSnrc-doc/HEN_HOUSE/egs++/geometry/egs_nd_geometry/egs_nd_geometry.h</h1>  </div>
</div>
<div class="contents">
<a href="egs__nd__geometry_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment">###############################################################################</span>
<a name="l00003"></a>00003 <span class="comment">#</span>
<a name="l00004"></a>00004 <span class="comment">#  EGSnrc egs++ nd geometry headers</span>
<a name="l00005"></a>00005 <span class="comment">#  Copyright (C) 2015 National Research Council Canada</span>
<a name="l00006"></a>00006 <span class="comment">#</span>
<a name="l00007"></a>00007 <span class="comment">#  This file is part of EGSnrc.</span>
<a name="l00008"></a>00008 <span class="comment">#</span>
<a name="l00009"></a>00009 <span class="comment">#  EGSnrc is free software: you can redistribute it and/or modify it under</span>
<a name="l00010"></a>00010 <span class="comment">#  the terms of the GNU Affero General Public License as published by the</span>
<a name="l00011"></a>00011 <span class="comment">#  Free Software Foundation, either version 3 of the License, or (at your</span>
<a name="l00012"></a>00012 <span class="comment">#  option) any later version.</span>
<a name="l00013"></a>00013 <span class="comment">#</span>
<a name="l00014"></a>00014 <span class="comment">#  EGSnrc is distributed in the hope that it will be useful, but WITHOUT ANY</span>
<a name="l00015"></a>00015 <span class="comment">#  WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</span>
<a name="l00016"></a>00016 <span class="comment">#  FOR A PARTICULAR PURPOSE.  See the GNU Affero General Public License for</span>
<a name="l00017"></a>00017 <span class="comment">#  more details.</span>
<a name="l00018"></a>00018 <span class="comment">#</span>
<a name="l00019"></a>00019 <span class="comment">#  You should have received a copy of the GNU Affero General Public License</span>
<a name="l00020"></a>00020 <span class="comment">#  along with EGSnrc. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<a name="l00021"></a>00021 <span class="comment">#</span>
<a name="l00022"></a>00022 <span class="comment">###############################################################################</span>
<a name="l00023"></a>00023 <span class="comment">#</span>
<a name="l00024"></a>00024 <span class="comment">#  Author:          Iwan Kawrakow, 2005</span>
<a name="l00025"></a>00025 <span class="comment">#</span>
<a name="l00026"></a>00026 <span class="comment">#  Contributors:    Blake Walters</span>
<a name="l00027"></a>00027 <span class="comment">#                   Ernesto Mainegra-Hing</span>
<a name="l00028"></a>00028 <span class="comment">#                   Frederic Tessier</span>
<a name="l00029"></a>00029 <span class="comment">#</span>
<a name="l00030"></a>00030 <span class="comment">###############################################################################</span>
<a name="l00031"></a>00031 <span class="comment">*/</span>
<a name="l00032"></a>00032 
<a name="l00033"></a>00033 
<a name="l00040"></a>00040 <span class="preprocessor">#ifndef EGS_ND_GEOMETRY_</span>
<a name="l00041"></a>00041 <span class="preprocessor"></span><span class="preprocessor">#define EGS_ND_GEOMETRY_</span>
<a name="l00042"></a>00042 <span class="preprocessor"></span>
<a name="l00043"></a>00043 <span class="preprocessor">#ifdef WIN32</span>
<a name="l00044"></a>00044 <span class="preprocessor"></span>
<a name="l00045"></a>00045 <span class="preprocessor">#ifdef BUILD_NDG_DLL</span>
<a name="l00046"></a>00046 <span class="preprocessor"></span><span class="preprocessor">#define EGS_NDG_EXPORT __declspec(dllexport)</span>
<a name="l00047"></a>00047 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00048"></a>00048 <span class="preprocessor"></span><span class="preprocessor">#define EGS_NDG_EXPORT __declspec(dllimport)</span>
<a name="l00049"></a>00049 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00050"></a>00050 <span class="preprocessor"></span><span class="preprocessor">#define EGS_NDG_LOCAL</span>
<a name="l00051"></a>00051 <span class="preprocessor"></span>
<a name="l00052"></a>00052 <span class="preprocessor">#else</span>
<a name="l00053"></a>00053 <span class="preprocessor"></span>
<a name="l00054"></a>00054 <span class="preprocessor">#ifdef HAVE_VISIBILITY</span>
<a name="l00055"></a>00055 <span class="preprocessor"></span><span class="preprocessor">#define EGS_NDG_EXPORT __attribute__ ((visibility (&quot;default&quot;)))</span>
<a name="l00056"></a>00056 <span class="preprocessor"></span><span class="preprocessor">#define EGS_NDG_LOCAL  __attribute__ ((visibility (&quot;hidden&quot;)))</span>
<a name="l00057"></a>00057 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00058"></a>00058 <span class="preprocessor"></span><span class="preprocessor">#define EGS_NDG_EXPORT</span>
<a name="l00059"></a>00059 <span class="preprocessor"></span><span class="preprocessor">#define EGS_NDG_LOCAL</span>
<a name="l00060"></a>00060 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00061"></a>00061 <span class="preprocessor"></span>
<a name="l00062"></a>00062 <span class="preprocessor">#endif</span>
<a name="l00063"></a>00063 <span class="preprocessor"></span>
<a name="l00064"></a>00064 
<a name="l00065"></a>00065 <span class="preprocessor">#include &quot;egs_base_geometry.h&quot;</span>
<a name="l00066"></a>00066 
<a name="l00067"></a>00067 <span class="preprocessor">#include&lt;vector&gt;</span>
<a name="l00068"></a>00068 <span class="preprocessor">#include &lt;iomanip&gt;</span>
<a name="l00069"></a>00069 <span class="keyword">using</span> std::vector;
<a name="l00070"></a>00070 
<a name="l00246"></a><a class="code" href="classEGS__NDGeometry.html">00246</a> <span class="keyword">class </span>EGS_NDG_EXPORT <a class="code" href="classEGS__NDGeometry.html" title="A class modeling a N-dimensional geometry.">EGS_NDGeometry</a> : <span class="keyword">public</span> <a class="code" href="classEGS__BaseGeometry.html">EGS_BaseGeometry</a> {
<a name="l00247"></a>00247 
<a name="l00248"></a>00248 <span class="keyword">public</span>:
<a name="l00249"></a>00249 
<a name="l00252"></a>00252       <a class="code" href="classEGS__NDGeometry.html" title="A class modeling a N-dimensional geometry.">EGS_NDGeometry</a>(<span class="keywordtype">int</span> ng, <a class="code" href="classEGS__BaseGeometry.html">EGS_BaseGeometry</a> **G, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp;Name = <span class="stringliteral">&quot;&quot;</span>,
<a name="l00253"></a>00253               <span class="keywordtype">bool</span> O=<span class="keyword">true</span>);
<a name="l00254"></a>00254 
<a name="l00256"></a>00256       <a class="code" href="classEGS__NDGeometry.html" title="A class modeling a N-dimensional geometry.">EGS_NDGeometry</a>(vector&lt;EGS_BaseGeometry *&gt; &amp;G, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp;Name = <span class="stringliteral">&quot;&quot;</span>,
<a name="l00257"></a>00257               <span class="keywordtype">bool</span> O=<span class="keyword">true</span>);
<a name="l00258"></a>00258 
<a name="l00259"></a>00259       ~<a class="code" href="classEGS__NDGeometry.html" title="A class modeling a N-dimensional geometry.">EGS_NDGeometry</a>();
<a name="l00260"></a>00260 
<a name="l00261"></a>00261       <span class="keywordtype">bool</span> <a class="code" href="classEGS__BaseGeometry.html#a816bf2d26bdabc3e4ee2f092bd903d92" title="Is the position x inside the geometry?">isInside</a>(<span class="keyword">const</span> <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> &amp;x) {
<a name="l00262"></a>00262           <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0; j&lt;N; j++) <span class="keywordflow">if</span>( !g[j]-&gt;<a class="code" href="classEGS__BaseGeometry.html#a816bf2d26bdabc3e4ee2f092bd903d92" title="Is the position x inside the geometry?">isInside</a>(x) ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00263"></a>00263           <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00264"></a>00264       };
<a name="l00265"></a>00265 
<a name="l00266"></a>00266       <span class="keywordtype">int</span> <a class="code" href="classEGS__BaseGeometry.html#af1a37ed6f281a2442a7e96d9658894a9" title="In which region is poisition x?">isWhere</a>(<span class="keyword">const</span> <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> &amp;x) {
<a name="l00267"></a>00267           <span class="keywordtype">int</span> ireg = 0;
<a name="l00268"></a>00268           <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0; j&lt;N; j++) {
<a name="l00269"></a>00269               <span class="keywordtype">int</span> ij = g[j]-&gt;<a class="code" href="classEGS__BaseGeometry.html#af1a37ed6f281a2442a7e96d9658894a9" title="In which region is poisition x?">isWhere</a>(x);
<a name="l00270"></a>00270               <span class="keywordflow">if</span>( ij &lt; 0 ) <span class="keywordflow">return</span> -1;
<a name="l00271"></a>00271               ireg += ij*n[j];
<a name="l00272"></a>00272           }
<a name="l00273"></a>00273           <span class="keywordflow">return</span> ireg;
<a name="l00274"></a>00274       };
<a name="l00275"></a>00275 
<a name="l00276"></a>00276       <span class="keywordtype">int</span> <a class="code" href="classEGS__BaseGeometry.html#a15008e08ea330694841fc94b64a7e8d5" title="Returns the region index, if inside, or -1 if outside (obsolete)">inside</a>(<span class="keyword">const</span> <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> &amp;x) { <span class="keywordflow">return</span> <a class="code" href="classEGS__BaseGeometry.html#af1a37ed6f281a2442a7e96d9658894a9" title="In which region is poisition x?">isWhere</a>(x); };
<a name="l00277"></a>00277 
<a name="l00278"></a>00278       EGS_Float <a class="code" href="classEGS__BaseGeometry.html#a217bc8dd7706a988acaf97165edb6435">howfarToOutside</a>(<span class="keywordtype">int</span> ireg, <span class="keyword">const</span> <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> &amp;x,
<a name="l00279"></a>00279               <span class="keyword">const</span> <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> &amp;u) {
<a name="l00280"></a>00280           <span class="keywordflow">if</span>( ireg &lt; 0 ) <span class="keywordflow">return</span> 0;
<a name="l00281"></a>00281           <span class="keywordtype">int</span> itmp = ireg; EGS_Float d = 1e30;
<a name="l00282"></a>00282           <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=N-1; j&gt;=0; j--) {
<a name="l00283"></a>00283               <span class="keywordtype">int</span> l = itmp/n[j];
<a name="l00284"></a>00284               EGS_Float t = g[j]-&gt;<a class="code" href="classEGS__BaseGeometry.html#a217bc8dd7706a988acaf97165edb6435">howfarToOutside</a>(l,x,u);
<a name="l00285"></a>00285               <span class="keywordflow">if</span>( t &lt;= 0 ) <span class="keywordflow">return</span> t;
<a name="l00286"></a>00286               <span class="keywordflow">if</span>( t &lt; d ) d = t;
<a name="l00287"></a>00287           }
<a name="l00288"></a>00288           <span class="keywordflow">return</span> d;
<a name="l00289"></a>00289       };
<a name="l00290"></a>00290 
<a name="l00291"></a>00291       <span class="keywordtype">int</span> <a class="code" href="classEGS__BaseGeometry.html#a42a459b557011291ea2e8978ebee6295" title="Calculate the distance to a boundary from x along the direction u.">howfar</a>(<span class="keywordtype">int</span> ireg, <span class="keyword">const</span> <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> &amp;x, <span class="keyword">const</span> <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> &amp;u,
<a name="l00292"></a>00292                  EGS_Float &amp;t, <span class="keywordtype">int</span> *newmed=0, <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> *normal=0) {
<a name="l00293"></a>00293           <span class="keywordflow">if</span>( ireg &gt;= 0 ) {
<a name="l00294"></a>00294               <span class="keywordtype">int</span> itmp = ireg; <span class="keywordtype">int</span> inext = -1, idelta, lnew_j;
<a name="l00295"></a>00295               <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=N-1; j&gt;=0; j--) {
<a name="l00296"></a>00296                   <span class="keywordtype">int</span> l = itmp/n[j];
<a name="l00297"></a>00297                   <span class="keywordtype">int</span> lnew = g[j]-&gt;<a class="code" href="classEGS__BaseGeometry.html#a42a459b557011291ea2e8978ebee6295" title="Calculate the distance to a boundary from x along the direction u.">howfar</a>(l,x,u,t,0,normal);
<a name="l00298"></a>00298                   <span class="keywordflow">if</span>( lnew != l ) {
<a name="l00299"></a>00299                       inext = j; idelta = lnew - l; lnew_j = lnew;
<a name="l00300"></a>00300                   }
<a name="l00301"></a>00301                   itmp -= l*n[j];
<a name="l00302"></a>00302               }
<a name="l00303"></a>00303               <span class="keywordflow">if</span>( inext &lt; 0 ) <span class="keywordflow">return</span> ireg;
<a name="l00304"></a>00304               <span class="keywordtype">int</span> inew = lnew_j &gt;= 0 ? ireg + idelta*n[inext] : lnew_j;
<a name="l00305"></a>00305               <span class="comment">//if( lnew_j &lt; 0 ) return lnew_j;</span>
<a name="l00306"></a>00306               <span class="comment">//int inew = ireg + idelta*n[inext];</span>
<a name="l00307"></a>00307               <span class="keywordflow">if</span>( newmed )
<a name="l00308"></a>00308                   *newmed = inew &gt;= 0 ? <a class="code" href="classEGS__BaseGeometry.html#aeae04119c0fa7a94b41627460878bd24" title="Returns the medium index in region ireg.">medium</a>(inew) : -1;
<a name="l00309"></a>00309               <span class="keywordflow">return</span> inew;
<a name="l00310"></a>00310           }
<a name="l00311"></a>00311           <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0; j&lt;N; j++) {
<a name="l00312"></a>00312               EGS_Float tj = t;
<a name="l00313"></a>00313               <span class="keywordtype">bool</span> is_in = g[j]-&gt;<a class="code" href="classEGS__BaseGeometry.html#a816bf2d26bdabc3e4ee2f092bd903d92" title="Is the position x inside the geometry?">isInside</a>(x);
<a name="l00314"></a>00314               <span class="comment">// Note: this logic fails if the geometry is not convex!</span>
<a name="l00315"></a>00315               <span class="keywordflow">if</span>( !is_in ) {
<a name="l00316"></a>00316                   <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> nn, *np=0;
<a name="l00317"></a>00317                   <span class="keywordflow">if</span>( normal ) np = &amp;nn;
<a name="l00318"></a>00318                   <span class="keywordtype">int</span> i = g[j]-&gt;<a class="code" href="classEGS__BaseGeometry.html#a42a459b557011291ea2e8978ebee6295" title="Calculate the distance to a boundary from x along the direction u.">howfar</a>(ireg,x,u,tj,0,np);
<a name="l00319"></a>00319                   <span class="keywordflow">if</span>( i &gt;= 0 ) {
<a name="l00320"></a>00320                       <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> tmp(x + u*tj);
<a name="l00321"></a>00321                       <span class="keywordtype">bool</span> is_ok = <span class="keyword">true</span>;
<a name="l00322"></a>00322                       <span class="keywordtype">int</span> res = 0;
<a name="l00323"></a>00323                       <span class="keywordflow">for</span>(<span class="keywordtype">int</span> k=0; k&lt;N; k++) {
<a name="l00324"></a>00324                           <span class="keywordflow">if</span>( k != j ) {
<a name="l00325"></a>00325                               <span class="keywordtype">int</span> check = g[k]-&gt;<a class="code" href="classEGS__BaseGeometry.html#af1a37ed6f281a2442a7e96d9658894a9" title="In which region is poisition x?">isWhere</a>(tmp);
<a name="l00326"></a>00326                               <span class="keywordflow">if</span>( check &lt; 0 ) { is_ok = <span class="keyword">false</span>; <span class="keywordflow">break</span>; }
<a name="l00327"></a>00327                               res += check*n[k];
<a name="l00328"></a>00328                           }
<a name="l00329"></a>00329                       }
<a name="l00330"></a>00330                       <span class="keywordflow">if</span>( is_ok ) {
<a name="l00331"></a>00331                           t = tj; res += i*n[j];
<a name="l00332"></a>00332                           <span class="keywordflow">if</span>( newmed ) *newmed = <a class="code" href="classEGS__BaseGeometry.html#aeae04119c0fa7a94b41627460878bd24" title="Returns the medium index in region ireg.">medium</a>(res);
<a name="l00333"></a>00333                           <span class="keywordflow">if</span>( normal ) *normal = nn;
<a name="l00334"></a>00334                           <span class="keywordflow">return</span> res;
<a name="l00335"></a>00335                       }
<a name="l00336"></a>00336                   }
<a name="l00337"></a>00337               }
<a name="l00338"></a>00338               <span class="comment">// and so, to fix it, we do the following for non-convex</span>
<a name="l00339"></a>00339               <span class="comment">// dimensions. But this only works if and only if there</span>
<a name="l00340"></a>00340               <span class="comment">// is not more than 1 non-convex dimension and this</span>
<a name="l00341"></a>00341               <span class="comment">// dimension is last in the list.</span>
<a name="l00342"></a>00342               <span class="keywordflow">else</span> <span class="keywordflow">if</span>( !g[j]-&gt;<a class="code" href="classEGS__BaseGeometry.html#ac5ab02600eeaf15cf76c732c8745f2d9" title="Is the geometry convex?">isConvex</a>() ) {
<a name="l00343"></a>00343                   <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> tmp(x); EGS_Float tleft = t;
<a name="l00344"></a>00344                   <span class="keywordtype">int</span> ii = g[j]-&gt;<a class="code" href="classEGS__BaseGeometry.html#af1a37ed6f281a2442a7e96d9658894a9" title="In which region is poisition x?">isWhere</a>(x);
<a name="l00345"></a>00345                   EGS_Float ttot = 0;
<a name="l00346"></a>00346                   <span class="keywordflow">while</span>(1) {
<a name="l00347"></a>00347                       EGS_Float tt = tleft;
<a name="l00348"></a>00348                       <span class="keywordtype">int</span> inew = g[j]-&gt;<a class="code" href="classEGS__BaseGeometry.html#a42a459b557011291ea2e8978ebee6295" title="Calculate the distance to a boundary from x along the direction u.">howfar</a>(ii,tmp,u,tt);
<a name="l00349"></a>00349                       <span class="keywordflow">if</span>( inew == ii ) <span class="keywordflow">break</span>;
<a name="l00350"></a>00350                       tleft -= tt; tmp += u*tt; ii = inew; ttot += tt;
<a name="l00351"></a>00351                       <span class="comment">//egsWarning(&quot; inew = %d tt = %g ttot = %g tmp = (%g,%g,%g)\n&quot;,inew,tt,ttot,tmp.x,tmp.y,tmp.z);</span>
<a name="l00352"></a>00352                       <span class="keywordflow">if</span>( ii &lt; 0 ) <span class="keywordflow">break</span>;
<a name="l00353"></a>00353                   }
<a name="l00354"></a>00354                   <span class="comment">//egsWarning(&quot;doing non-convex part: x = (%g,%g,%g) ii = %d t = %g ttot = %g\n&quot;,x.x,x.y,x.z,ii,t,ttot);</span>
<a name="l00355"></a>00355                   <span class="keywordflow">if</span>( ii &lt; 0 ) {
<a name="l00356"></a>00356                       <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> nn, *np = normal ? &amp;nn : 0;
<a name="l00357"></a>00357                       EGS_Float tt = tleft;
<a name="l00358"></a>00358                       <span class="keywordtype">int</span> inew = g[j]-&gt;<a class="code" href="classEGS__BaseGeometry.html#a42a459b557011291ea2e8978ebee6295" title="Calculate the distance to a boundary from x along the direction u.">howfar</a>(ii,tmp,u,tt,0,np);
<a name="l00359"></a>00359                       <span class="comment">//egsWarning(&quot; exited and tried to reenter: %d %g\n&quot;,inew,ttot+tt);</span>
<a name="l00360"></a>00360                       <span class="keywordflow">if</span>( inew &gt;= 0 ) {
<a name="l00361"></a>00361                           tmp += u*tt; <span class="keywordtype">bool</span> is_ok = <span class="keyword">true</span>; <span class="keywordtype">int</span> res = 0;
<a name="l00362"></a>00362                           <span class="keywordflow">for</span>(<span class="keywordtype">int</span> k=0; k&lt;N; k++) {
<a name="l00363"></a>00363                               <span class="keywordflow">if</span>( k != j ) {
<a name="l00364"></a>00364                                   <span class="keywordtype">int</span> check = g[k]-&gt;<a class="code" href="classEGS__BaseGeometry.html#af1a37ed6f281a2442a7e96d9658894a9" title="In which region is poisition x?">isWhere</a>(tmp);
<a name="l00365"></a>00365                                   <span class="keywordflow">if</span>( check &lt; 0 ) { is_ok = <span class="keyword">false</span>; <span class="keywordflow">break</span>; }
<a name="l00366"></a>00366                                   res += check*n[k];
<a name="l00367"></a>00367                               }
<a name="l00368"></a>00368                           }
<a name="l00369"></a>00369                           <span class="keywordflow">if</span>( is_ok ) {
<a name="l00370"></a>00370                               t = ttot + tt; res += inew*n[j];
<a name="l00371"></a>00371                               <span class="keywordflow">if</span>( newmed ) *newmed = <a class="code" href="classEGS__BaseGeometry.html#aeae04119c0fa7a94b41627460878bd24" title="Returns the medium index in region ireg.">medium</a>(res);
<a name="l00372"></a>00372                               <span class="keywordflow">if</span>( normal ) *normal = nn;
<a name="l00373"></a>00373                               <span class="keywordflow">return</span> res;
<a name="l00374"></a>00374                           }
<a name="l00375"></a>00375                       }
<a name="l00376"></a>00376                   }
<a name="l00377"></a>00377               }
<a name="l00378"></a>00378           }
<a name="l00379"></a>00379           <span class="keywordflow">return</span> -1;
<a name="l00380"></a>00380       };
<a name="l00381"></a>00381 
<a name="l00382"></a>00382       EGS_Float <a class="code" href="classEGS__BaseGeometry.html#a111e6d8ea34e403bebaf3621223950d9" title="Calculate the distance to a boundary for position x in any direction.">hownear</a>(<span class="keywordtype">int</span> ireg, <span class="keyword">const</span> <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> &amp;x) {
<a name="l00383"></a>00383           EGS_Float tmin = 1e30;
<a name="l00384"></a>00384           <span class="keywordflow">if</span>( ireg &gt;= 0 ) {
<a name="l00385"></a>00385               <span class="keywordtype">int</span> itmp = ireg;
<a name="l00386"></a>00386               <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=N-1; j&gt;=0; j--) {
<a name="l00387"></a>00387                   <span class="keywordtype">int</span> l = itmp/n[j];
<a name="l00388"></a>00388                   EGS_Float t = g[j]-&gt;<a class="code" href="classEGS__BaseGeometry.html#a111e6d8ea34e403bebaf3621223950d9" title="Calculate the distance to a boundary for position x in any direction.">hownear</a>(l,x);
<a name="l00389"></a>00389                   <span class="keywordflow">if</span>( t &lt; tmin ) {
<a name="l00390"></a>00390                       tmin = t; <span class="keywordflow">if</span>( tmin &lt;= 0 ) <span class="keywordflow">return</span> 0;
<a name="l00391"></a>00391                   }
<a name="l00392"></a>00392                   itmp -= l*n[j];
<a name="l00393"></a>00393               }
<a name="l00394"></a>00394               <span class="keywordflow">return</span> tmin;
<a name="l00395"></a>00395           }
<a name="l00396"></a>00396           <span class="keywordflow">if</span>( ortho ) {
<a name="l00397"></a>00397               <span class="keywordtype">int</span> nc = 0; EGS_Float s1=0, s2=0;
<a name="l00398"></a>00398               <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0; j&lt;N; j++) {
<a name="l00399"></a>00399                   <span class="keywordflow">if</span>( !g[j]-&gt;<a class="code" href="classEGS__BaseGeometry.html#a816bf2d26bdabc3e4ee2f092bd903d92" title="Is the position x inside the geometry?">isInside</a>(x) ) {
<a name="l00400"></a>00400                       EGS_Float t = g[j]-&gt;<a class="code" href="classEGS__BaseGeometry.html#a111e6d8ea34e403bebaf3621223950d9" title="Calculate the distance to a boundary for position x in any direction.">hownear</a>(-1,x);
<a name="l00401"></a>00401                       nc++; s1 += t; s2 += t*t;
<a name="l00402"></a>00402                   }
<a name="l00403"></a>00403               }
<a name="l00404"></a>00404               <span class="keywordflow">if</span>( nc == 1 ) <span class="keywordflow">return</span> s1;
<a name="l00405"></a>00405               <span class="keywordflow">return</span> sqrt(s2);
<a name="l00406"></a>00406           } <span class="keywordflow">else</span> {
<a name="l00407"></a>00407               EGS_Float tmin = 1e30;
<a name="l00408"></a>00408               <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0; j&lt;N; j++) {
<a name="l00409"></a>00409                   EGS_Float t; <span class="keywordtype">int</span> i = g[j]-&gt;<a class="code" href="classEGS__BaseGeometry.html#af1a37ed6f281a2442a7e96d9658894a9" title="In which region is poisition x?">isWhere</a>(x);
<a name="l00410"></a>00410                   t = g[j]-&gt;<a class="code" href="classEGS__BaseGeometry.html#a111e6d8ea34e403bebaf3621223950d9" title="Calculate the distance to a boundary for position x in any direction.">hownear</a>(i,x);
<a name="l00411"></a>00411                   <span class="keywordflow">if</span>( t &lt; tmin ) { tmin = t; <span class="keywordflow">if</span>( tmin &lt;= 0 ) <span class="keywordflow">return</span> 0; }
<a name="l00412"></a>00412               }
<a name="l00413"></a>00413               <span class="keywordflow">return</span> tmin;
<a name="l00414"></a>00414           }
<a name="l00415"></a>00415       };
<a name="l00416"></a>00416 
<a name="l00417"></a>00417       <span class="keywordtype">int</span> <a class="code" href="classEGS__BaseGeometry.html#a8bc9aebe58a23ed3b6d9f2d4c72265fa" title="Returns the maximum number of steps through the geometry.">getMaxStep</a>()<span class="keyword"> const </span>{
<a name="l00418"></a>00418           <span class="keywordtype">int</span> nstep = 1;
<a name="l00419"></a>00419           <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=0; j&lt;N; ++j) nstep += g[j]-&gt;<a class="code" href="classEGS__BaseGeometry.html#a8bc9aebe58a23ed3b6d9f2d4c72265fa" title="Returns the maximum number of steps through the geometry.">getMaxStep</a>();
<a name="l00420"></a>00420           <span class="keywordflow">return</span> nstep;
<a name="l00421"></a>00421       };
<a name="l00422"></a>00422 
<a name="l00423"></a>00423       <span class="keyword">const</span> <span class="keywordtype">string</span> &amp;<a class="code" href="classEGS__BaseGeometry.html#a2df5b0631c3bd57250a6a57cad56323c" title="Get the geometry type.">getType</a>()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> type; };
<a name="l00424"></a>00424 
<a name="l00425"></a>00425       <span class="keywordtype">void</span> <a class="code" href="classEGS__BaseGeometry.html#a90b349e45353ab0b7fa32053a9d37085" title="Print information about this geometry.">printInfo</a>() <span class="keyword">const</span>;
<a name="l00426"></a>00426 
<a name="l00427"></a>00427       <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classEGS__BaseGeometry.html#a2e938cb893fb564a3cf4e2141a2173c1" title="Get the list of all regions labeled with str.">getLabelRegions</a> (<span class="keyword">const</span> <span class="keywordtype">string</span> &amp;str, vector&lt;int&gt; &amp;regs);
<a name="l00428"></a>00428       <span class="keywordtype">int</span> ndRegions (<span class="keywordtype">int</span> r, <span class="keywordtype">int</span> dim, <span class="keywordtype">int</span> dimk, <span class="keywordtype">int</span> k, vector&lt;int&gt; &amp;regs);
<a name="l00429"></a>00429 
<a name="l00430"></a>00430 <span class="keyword">protected</span>:
<a name="l00431"></a>00431 
<a name="l00432"></a><a class="code" href="classEGS__NDGeometry.html#ad3fc033b4a4fdeb113887bc29e04bc30">00432</a>       <span class="keywordtype">int</span>              <a class="code" href="classEGS__NDGeometry.html#ad3fc033b4a4fdeb113887bc29e04bc30" title="Number of dimensions.">N</a>;       
<a name="l00433"></a><a class="code" href="classEGS__NDGeometry.html#ac4df59e642b5510f9f6f4664078acd7c">00433</a>       <a class="code" href="classEGS__BaseGeometry.html">EGS_BaseGeometry</a> **<a class="code" href="classEGS__NDGeometry.html#ac4df59e642b5510f9f6f4664078acd7c" title="The dimensions.">g</a>;     
<a name="l00434"></a><a class="code" href="classEGS__NDGeometry.html#a9990da49a368ce5d0c59510cfc01411e">00434</a>       <span class="keywordtype">int</span>              *<a class="code" href="classEGS__NDGeometry.html#a9990da49a368ce5d0c59510cfc01411e" title="Used for calculating region indeces.">n</a>;      
<a name="l00435"></a><a class="code" href="classEGS__NDGeometry.html#a814333b9e55332159c682606729a3b68">00435</a>       <span class="keyword">static</span> <span class="keywordtype">string</span>    <a class="code" href="classEGS__NDGeometry.html#a814333b9e55332159c682606729a3b68" title="The geometry type.">type</a>;    
<a name="l00436"></a><a class="code" href="classEGS__NDGeometry.html#ab44ebf94afb8df08740206f7ba34bb1e">00436</a>       <span class="keywordtype">bool</span> <a class="code" href="classEGS__NDGeometry.html#ab44ebf94afb8df08740206f7ba34bb1e" title="Is the geometry orthogonal ?">ortho</a>;               
<a name="l00437"></a>00437 
<a name="l00438"></a>00438       <span class="keywordtype">void</span> setup();
<a name="l00439"></a>00439 
<a name="l00446"></a>00446       <span class="keywordtype">void</span> <a class="code" href="classEGS__BaseGeometry.html#a28bf612777de14f97108021ae7eb3865" title="Set the media in the geometry from the input pointed to by inp.">setMedia</a>(<a class="code" href="classEGS__Input.html" title="A class for storing information in a tree-like structure of key-value pairs. This class is used throu...">EGS_Input</a> *inp, <span class="keywordtype">int</span> nmed, <span class="keyword">const</span> <span class="keywordtype">int</span> *med_ind);
<a name="l00447"></a>00447 
<a name="l00448"></a>00448 <span class="keyword">private</span>:
<a name="l00449"></a>00449 
<a name="l00450"></a>00450       <span class="keywordtype">void</span> setM(<span class="keywordtype">int</span> ib, <span class="keywordtype">int</span> idim, <span class="keyword">const</span> vector&lt;int&gt; &amp;ranges, <span class="keywordtype">int</span> medium);
<a name="l00451"></a>00451 };
<a name="l00452"></a>00452 
<a name="l00453"></a>00453 <span class="preprocessor">#ifdef EXPLICIT_XYZ</span>
<a name="l00454"></a>00454 <span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="egs__planes_8h.html" title="Sets of parallel planes and a plane collection.">../egs_planes/egs_planes.h</a>&quot;</span>
<a name="l00455"></a>00455 
<a name="l00538"></a><a class="code" href="classEGS__XYZGeometry.html">00538</a> <span class="keyword">class </span>EGS_NDG_EXPORT <a class="code" href="classEGS__XYZGeometry.html" title="An XYZ-geometry.">EGS_XYZGeometry</a> : <span class="keyword">public</span> <a class="code" href="classEGS__BaseGeometry.html">EGS_BaseGeometry</a> {
<a name="l00539"></a>00539 
<a name="l00540"></a>00540 <span class="keyword">public</span>:
<a name="l00541"></a>00541 
<a name="l00542"></a>00542       <a class="code" href="classEGS__XYZGeometry.html" title="An XYZ-geometry.">EGS_XYZGeometry</a>(<a class="code" href="classEGS__PlanesT.html" title="A set of parallel planes.">EGS_PlanesX</a> *Xp, <a class="code" href="classEGS__PlanesT.html" title="A set of parallel planes.">EGS_PlanesY</a> *Yp, <a class="code" href="classEGS__PlanesT.html" title="A set of parallel planes.">EGS_PlanesZ</a> *Zp,
<a name="l00543"></a>00543               <span class="keyword">const</span> <span class="keywordtype">string</span> &amp;Name = <span class="stringliteral">&quot;&quot;</span>);
<a name="l00544"></a>00544 
<a name="l00545"></a>00545       ~<a class="code" href="classEGS__XYZGeometry.html" title="An XYZ-geometry.">EGS_XYZGeometry</a>();
<a name="l00546"></a>00546 
<a name="l00547"></a>00547       <span class="keywordtype">bool</span> <a class="code" href="classEGS__BaseGeometry.html#a816bf2d26bdabc3e4ee2f092bd903d92" title="Is the position x inside the geometry?">isInside</a>(<span class="keyword">const</span> <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> &amp;x) {
<a name="l00548"></a>00548           <span class="keywordflow">if</span>( !xp-&gt;isInside(x) ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00549"></a>00549           <span class="keywordflow">if</span>( !yp-&gt;isInside(x) ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00550"></a>00550           <span class="keywordflow">if</span>( !zp-&gt;isInside(x) ) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00551"></a>00551           <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00552"></a>00552       };
<a name="l00553"></a>00553 
<a name="l00554"></a>00554       <span class="keywordtype">int</span> <a class="code" href="classEGS__BaseGeometry.html#af1a37ed6f281a2442a7e96d9658894a9" title="In which region is poisition x?">isWhere</a>(<span class="keyword">const</span> <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> &amp;x) {
<a name="l00555"></a>00555           <span class="keywordtype">int</span> ix = xp-&gt;isWhere(x); <span class="keywordflow">if</span>( ix &lt; 0 ) <span class="keywordflow">return</span> ix;
<a name="l00556"></a>00556           <span class="keywordtype">int</span> iy = yp-&gt;isWhere(x); <span class="keywordflow">if</span>( iy &lt; 0 ) <span class="keywordflow">return</span> iy;
<a name="l00557"></a>00557           <span class="keywordtype">int</span> iz = zp-&gt;isWhere(x); <span class="keywordflow">if</span>( iz &lt; 0 ) <span class="keywordflow">return</span> iz;
<a name="l00558"></a>00558           <span class="keywordflow">return</span> ix + iy*nx + iz*nxy;
<a name="l00559"></a>00559       };
<a name="l00560"></a>00560 
<a name="l00561"></a>00561       <span class="keywordtype">int</span> <a class="code" href="classEGS__BaseGeometry.html#a15008e08ea330694841fc94b64a7e8d5" title="Returns the region index, if inside, or -1 if outside (obsolete)">inside</a>(<span class="keyword">const</span> <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> &amp;x) { <span class="keywordflow">return</span> <a class="code" href="classEGS__BaseGeometry.html#af1a37ed6f281a2442a7e96d9658894a9" title="In which region is poisition x?">isWhere</a>(x); };
<a name="l00562"></a>00562 
<a name="l00563"></a>00563       <span class="keywordtype">int</span> <a class="code" href="classEGS__BaseGeometry.html#a052f3f1f85ef7dc4b3b3c26a43e3ee5b" title="Calculates intersection distances to region boundaries.">computeIntersections</a>(<span class="keywordtype">int</span> ireg, <span class="keywordtype">int</span> n, <span class="keyword">const</span> <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> &amp;X,
<a name="l00564"></a>00564               <span class="keyword">const</span> <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> &amp;u, <a class="code" href="structEGS__GeometryIntersections.html">EGS_GeometryIntersections</a> *isections) {
<a name="l00565"></a>00565           <span class="keywordflow">if</span>( n &lt; 1 ) <span class="keywordflow">return</span> -1;
<a name="l00566"></a>00566           <span class="keywordtype">int</span> ifirst = 0; EGS_Float t, t_ini = 0; <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> x(X); <span class="keywordtype">int</span> imed;
<a name="l00567"></a>00567           <span class="keywordflow">if</span>( ireg &lt; 0 ) {
<a name="l00568"></a>00568               t = 1e30; ireg = <a class="code" href="classEGS__BaseGeometry.html#a42a459b557011291ea2e8978ebee6295" title="Calculate the distance to a boundary from x along the direction u.">howfar</a>(ireg,x,u,t,&amp;imed);
<a name="l00569"></a>00569               <span class="keywordflow">if</span>( ireg &lt; 0 ) <span class="keywordflow">return</span> 0;
<a name="l00570"></a>00570               isections[0].<a class="code" href="structEGS__GeometryIntersections.html#a2f67d52d07a1de3523f38f32a0c5f9fa" title="distance to next region boundary">t</a> = t; isections[0].<a class="code" href="structEGS__GeometryIntersections.html#a7955eb5e61d33812a1585a94eccdee5f" title="relative mass density in that region">rhof</a> = 1;
<a name="l00571"></a>00571               isections[0].<a class="code" href="structEGS__GeometryIntersections.html#a2f1b6684410ebe0b1f621a7422f63236" title="region index">ireg</a> = -1; isections[0].<a class="code" href="structEGS__GeometryIntersections.html#ad6345c5ff2ddd6bf74b8d46a8d6cbc6f" title="medium index">imed</a> = -1;
<a name="l00572"></a>00572               t_ini = t; ++ifirst; x += u*t;
<a name="l00573"></a>00573           }
<a name="l00574"></a>00574           <span class="keywordflow">else</span> imed = <a class="code" href="classEGS__BaseGeometry.html#aeae04119c0fa7a94b41627460878bd24" title="Returns the medium index in region ireg.">medium</a>(ireg);
<a name="l00575"></a>00575           EGS_Float *px = xp-&gt;getPositions(),
<a name="l00576"></a>00576                     *py = yp-&gt;getPositions(),
<a name="l00577"></a>00577                     *pz = zp-&gt;getPositions();
<a name="l00578"></a>00578           <span class="keywordtype">int</span> iz = ireg/nxy; <span class="keywordtype">int</span> ir = ireg - iz*nxy;
<a name="l00579"></a>00579           <span class="keywordtype">int</span> iy = ir/nx; <span class="keywordtype">int</span> ix = ir - iy*nx;
<a name="l00580"></a>00580           EGS_Float uxi, uyi, uzi, nextx, nexty, nextz;
<a name="l00581"></a>00581           <span class="keywordtype">int</span> dirx, icx, diry, icy, dirz, icz;
<a name="l00582"></a>00582           <span class="keywordflow">if</span>( u.<a class="code" href="classEGS__Vector.html#aa67c962f9024c44d15f446c122d25cbf" title="x-component">x</a> &gt; 0 )      { uxi = 1/u.<a class="code" href="classEGS__Vector.html#aa67c962f9024c44d15f446c122d25cbf" title="x-component">x</a>; dirx =  1; icx = 1; }
<a name="l00583"></a>00583           <span class="keywordflow">else</span> <span class="keywordflow">if</span>( u.<a class="code" href="classEGS__Vector.html#aa67c962f9024c44d15f446c122d25cbf" title="x-component">x</a> &lt; 0 ) { uxi = 1/u.<a class="code" href="classEGS__Vector.html#aa67c962f9024c44d15f446c122d25cbf" title="x-component">x</a>; dirx = -1; icx = 0; }
<a name="l00584"></a>00584           <span class="keywordflow">else</span>               { uxi = 1e33;  dirx =  1; icx = 1; }
<a name="l00585"></a>00585           <span class="keywordflow">if</span>( u.<a class="code" href="classEGS__Vector.html#a156335a0c0cee0f4c6f6e23aac316350" title="y-component">y</a> &gt; 0 )      { uyi = 1/u.<a class="code" href="classEGS__Vector.html#a156335a0c0cee0f4c6f6e23aac316350" title="y-component">y</a>; diry =  1; icy = 1; }
<a name="l00586"></a>00586           <span class="keywordflow">else</span> <span class="keywordflow">if</span>( u.<a class="code" href="classEGS__Vector.html#a156335a0c0cee0f4c6f6e23aac316350" title="y-component">y</a> &lt; 0 ) { uyi = 1/u.<a class="code" href="classEGS__Vector.html#a156335a0c0cee0f4c6f6e23aac316350" title="y-component">y</a>; diry = -1; icy = 0; }
<a name="l00587"></a>00587           <span class="keywordflow">else</span>               { uyi = 1e33;  diry =  1; icy = 1; }
<a name="l00588"></a>00588           <span class="keywordflow">if</span>( u.<a class="code" href="classEGS__Vector.html#a4d45f2e6f756337d6b06b006e04bfc87" title="z-component">z</a> &gt; 0 )      { uzi = 1/u.<a class="code" href="classEGS__Vector.html#a4d45f2e6f756337d6b06b006e04bfc87" title="z-component">z</a>; dirz =  1; icz = 1; }
<a name="l00589"></a>00589           <span class="keywordflow">else</span> <span class="keywordflow">if</span>( u.<a class="code" href="classEGS__Vector.html#a4d45f2e6f756337d6b06b006e04bfc87" title="z-component">z</a> &lt; 0 ) { uzi = 1/u.<a class="code" href="classEGS__Vector.html#a4d45f2e6f756337d6b06b006e04bfc87" title="z-component">z</a>; dirz = -1; icz = 0; }
<a name="l00590"></a>00590           <span class="keywordflow">else</span>               { uzi = 1e33;  dirz =  1; icz = 1; }
<a name="l00591"></a>00591           nextx = (px[ix+icx] - x.<a class="code" href="classEGS__Vector.html#aa67c962f9024c44d15f446c122d25cbf" title="x-component">x</a>)*uxi + t_ini;
<a name="l00592"></a>00592           nexty = (py[iy+icy] - x.<a class="code" href="classEGS__Vector.html#a156335a0c0cee0f4c6f6e23aac316350" title="y-component">y</a>)*uyi + t_ini;
<a name="l00593"></a>00593           nextz = (pz[iz+icz] - x.<a class="code" href="classEGS__Vector.html#a4d45f2e6f756337d6b06b006e04bfc87" title="z-component">z</a>)*uzi + t_ini;
<a name="l00594"></a>00594           <span class="keywordflow">for</span>(<span class="keywordtype">int</span> j=ifirst; j&lt;n; j++) {
<a name="l00595"></a>00595               isections[j].<a class="code" href="structEGS__GeometryIntersections.html#ad6345c5ff2ddd6bf74b8d46a8d6cbc6f" title="medium index">imed</a> = imed; isections[j].<a class="code" href="structEGS__GeometryIntersections.html#a2f1b6684410ebe0b1f621a7422f63236" title="region index">ireg</a> = ireg;
<a name="l00596"></a>00596               isections[j].<a class="code" href="structEGS__GeometryIntersections.html#a7955eb5e61d33812a1585a94eccdee5f" title="relative mass density in that region">rhof</a> = <a class="code" href="classEGS__BaseGeometry.html#ae73ccf5d1d1264f3865b275a99ce1377" title="Get the relative mass density in region ireg.">getRelativeRho</a>(ireg);
<a name="l00597"></a>00597               <span class="keywordtype">int</span> inew;
<a name="l00598"></a>00598               <span class="keywordflow">if</span>( nextx &lt; nexty &amp;&amp; nextx &lt; nextz ) {
<a name="l00599"></a>00599                   t = nextx; ix += dirx;
<a name="l00600"></a>00600                   <span class="keywordflow">if</span>( ix &lt; 0 || ix &gt;= nx ) inew = -1;
<a name="l00601"></a>00601                   <span class="keywordflow">else</span> {
<a name="l00602"></a>00602                       inew = ireg + dirx; nextx = (px[ix+icx] - x.<a class="code" href="classEGS__Vector.html#aa67c962f9024c44d15f446c122d25cbf" title="x-component">x</a>)*uxi + t_ini;
<a name="l00603"></a>00603                   }
<a name="l00604"></a>00604               }
<a name="l00605"></a>00605               <span class="keywordflow">else</span> <span class="keywordflow">if</span>( nexty &lt; nextz ) {
<a name="l00606"></a>00606                   t = nexty; iy += diry;
<a name="l00607"></a>00607                   <span class="keywordflow">if</span>( iy &lt; 0 || iy &gt;= ny ) inew = -1;
<a name="l00608"></a>00608                   <span class="keywordflow">else</span> {
<a name="l00609"></a>00609                       inew = ireg + nx*diry; nexty = (py[iy+icy] - x.<a class="code" href="classEGS__Vector.html#a156335a0c0cee0f4c6f6e23aac316350" title="y-component">y</a>)*uyi + t_ini;
<a name="l00610"></a>00610                   }
<a name="l00611"></a>00611               }
<a name="l00612"></a>00612               <span class="keywordflow">else</span> {
<a name="l00613"></a>00613                   t = nextz; iz += dirz;
<a name="l00614"></a>00614                   <span class="keywordflow">if</span>( iz &lt; 0 || iz &gt;= nz ) inew = -1;
<a name="l00615"></a>00615                   <span class="keywordflow">else</span> {
<a name="l00616"></a>00616                       inew = ireg + nxy*dirz; nextz = (pz[iz+icz] - x.<a class="code" href="classEGS__Vector.html#a4d45f2e6f756337d6b06b006e04bfc87" title="z-component">z</a>)*uzi + t_ini;
<a name="l00617"></a>00617                   }
<a name="l00618"></a>00618               }
<a name="l00619"></a>00619               isections[j].<a class="code" href="structEGS__GeometryIntersections.html#a2f67d52d07a1de3523f38f32a0c5f9fa" title="distance to next region boundary">t</a> = t;
<a name="l00620"></a>00620               <span class="keywordflow">if</span>( inew &lt; 0 ) <span class="keywordflow">return</span> j+1;
<a name="l00621"></a>00621               ireg = inew; imed = <a class="code" href="classEGS__BaseGeometry.html#aeae04119c0fa7a94b41627460878bd24" title="Returns the medium index in region ireg.">medium</a>(ireg);
<a name="l00622"></a>00622           }
<a name="l00623"></a>00623           <span class="keywordflow">return</span> ireg &gt;= 0 ? -1 : n;
<a name="l00624"></a>00624       };
<a name="l00625"></a>00625 
<a name="l00626"></a>00626       EGS_Float <a class="code" href="classEGS__BaseGeometry.html#a217bc8dd7706a988acaf97165edb6435">howfarToOutside</a>(<span class="keywordtype">int</span> ireg, <span class="keyword">const</span> <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> &amp;x,
<a name="l00627"></a>00627                       <span class="keyword">const</span> <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> &amp;u) {
<a name="l00628"></a>00628           <span class="keywordflow">if</span>( ireg &lt; 0 ) <span class="keywordflow">return</span> 0;
<a name="l00629"></a>00629           <span class="keywordtype">int</span> iz = ireg/nxy; <span class="keywordtype">int</span> ir = ireg - iz*nxy;
<a name="l00630"></a>00630           <span class="keywordtype">int</span> iy = ir/nx; <span class="keywordtype">int</span> ix = ir - iy*nx;
<a name="l00631"></a>00631           EGS_Float  d = xp-&gt;howfarToOutside(ix,x,u);
<a name="l00632"></a>00632           EGS_Float ty = yp-&gt;howfarToOutside(iy,x,u); <span class="keywordflow">if</span>( ty &lt; d ) d = ty;
<a name="l00633"></a>00633           EGS_Float tz = zp-&gt;howfarToOutside(iz,x,u); <span class="keywordflow">if</span>( tz &lt; d ) d = tz;
<a name="l00634"></a>00634           <span class="keywordflow">return</span> d;
<a name="l00635"></a>00635       };
<a name="l00636"></a>00636 
<a name="l00637"></a>00637       <span class="keywordtype">int</span> <a class="code" href="classEGS__BaseGeometry.html#a42a459b557011291ea2e8978ebee6295" title="Calculate the distance to a boundary from x along the direction u.">howfar</a>(<span class="keywordtype">int</span> ireg, <span class="keyword">const</span> <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> &amp;x, <span class="keyword">const</span> <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> &amp;u,
<a name="l00638"></a>00638                  EGS_Float &amp;t, <span class="keywordtype">int</span> *newmed=0, <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> *normal=0) {
<a name="l00639"></a>00639           <span class="keywordflow">if</span>( ireg &gt;= 0 ) {
<a name="l00640"></a>00640               <span class="keywordtype">int</span> iz = ireg/nxy; <span class="keywordtype">int</span> ir = ireg - iz*nxy;
<a name="l00641"></a>00641               <span class="keywordtype">int</span> iy = ir/nx; <span class="keywordtype">int</span> ix = ir - iy*nx;
<a name="l00642"></a>00642               <span class="keywordtype">int</span> inew = ireg;
<a name="l00643"></a>00643               <span class="keywordflow">if</span>( u.<a class="code" href="classEGS__Vector.html#aa67c962f9024c44d15f446c122d25cbf" title="x-component">x</a> &gt; 0 ) {
<a name="l00644"></a>00644                   EGS_Float d = (xpos[ix+1]-x.<a class="code" href="classEGS__Vector.html#aa67c962f9024c44d15f446c122d25cbf" title="x-component">x</a>)/u.<a class="code" href="classEGS__Vector.html#aa67c962f9024c44d15f446c122d25cbf" title="x-component">x</a>;
<a name="l00645"></a>00645                   <span class="keywordflow">if</span>( d &lt;= t ) {
<a name="l00646"></a>00646                       t = d; <span class="keywordflow">if</span>( (++ix) &lt; nx ) inew = ireg + 1; <span class="keywordflow">else</span> inew = -1;
<a name="l00647"></a>00647                       <span class="keywordflow">if</span>( normal ) *normal = <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a>(-1,0,0);
<a name="l00648"></a>00648                   }
<a name="l00649"></a>00649               }
<a name="l00650"></a>00650               <span class="keywordflow">else</span> <span class="keywordflow">if</span>( u.<a class="code" href="classEGS__Vector.html#aa67c962f9024c44d15f446c122d25cbf" title="x-component">x</a> &lt; 0 ) {
<a name="l00651"></a>00651                   EGS_Float d = (xpos[ix]-x.<a class="code" href="classEGS__Vector.html#aa67c962f9024c44d15f446c122d25cbf" title="x-component">x</a>)/u.<a class="code" href="classEGS__Vector.html#aa67c962f9024c44d15f446c122d25cbf" title="x-component">x</a>;
<a name="l00652"></a>00652                   <span class="keywordflow">if</span>( d &lt;= t ) {
<a name="l00653"></a>00653                       t = d; <span class="keywordflow">if</span>( (--ix) &gt;= 0 ) inew = ireg - 1; <span class="keywordflow">else</span> inew = -1;
<a name="l00654"></a>00654                       <span class="keywordflow">if</span>( normal ) *normal = <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a>(1,0,0);
<a name="l00655"></a>00655                   }
<a name="l00656"></a>00656               }
<a name="l00657"></a>00657               <span class="keywordflow">if</span>( u.<a class="code" href="classEGS__Vector.html#a156335a0c0cee0f4c6f6e23aac316350" title="y-component">y</a> &gt; 0 ) {
<a name="l00658"></a>00658                   EGS_Float d = (ypos[iy+1]-x.<a class="code" href="classEGS__Vector.html#a156335a0c0cee0f4c6f6e23aac316350" title="y-component">y</a>)/u.<a class="code" href="classEGS__Vector.html#a156335a0c0cee0f4c6f6e23aac316350" title="y-component">y</a>;
<a name="l00659"></a>00659                   <span class="keywordflow">if</span>( d &lt;= t ) {
<a name="l00660"></a>00660                       t = d; <span class="keywordflow">if</span>( (++iy) &lt; ny ) inew = ireg + nx; <span class="keywordflow">else</span> inew = -1;
<a name="l00661"></a>00661                       <span class="keywordflow">if</span>( normal ) *normal = <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a>(0,-1,0);
<a name="l00662"></a>00662                   }
<a name="l00663"></a>00663               }
<a name="l00664"></a>00664               <span class="keywordflow">else</span> <span class="keywordflow">if</span>( u.<a class="code" href="classEGS__Vector.html#a156335a0c0cee0f4c6f6e23aac316350" title="y-component">y</a> &lt; 0 ) {
<a name="l00665"></a>00665                   EGS_Float d = (ypos[iy]-x.<a class="code" href="classEGS__Vector.html#a156335a0c0cee0f4c6f6e23aac316350" title="y-component">y</a>)/u.<a class="code" href="classEGS__Vector.html#a156335a0c0cee0f4c6f6e23aac316350" title="y-component">y</a>;
<a name="l00666"></a>00666                   <span class="keywordflow">if</span>( d &lt;= t ) {
<a name="l00667"></a>00667                       t = d; <span class="keywordflow">if</span>( (--iy) &gt;= 0 ) inew = ireg - nx; <span class="keywordflow">else</span> inew = -1;
<a name="l00668"></a>00668                       <span class="keywordflow">if</span>( normal ) *normal = <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a>(0,1,0);
<a name="l00669"></a>00669                   }
<a name="l00670"></a>00670               }
<a name="l00671"></a>00671               <span class="keywordflow">if</span>( u.<a class="code" href="classEGS__Vector.html#a4d45f2e6f756337d6b06b006e04bfc87" title="z-component">z</a> &gt; 0 ) {
<a name="l00672"></a>00672                   EGS_Float d = (zpos[iz+1]-x.<a class="code" href="classEGS__Vector.html#a4d45f2e6f756337d6b06b006e04bfc87" title="z-component">z</a>)/u.<a class="code" href="classEGS__Vector.html#a4d45f2e6f756337d6b06b006e04bfc87" title="z-component">z</a>;
<a name="l00673"></a>00673                   <span class="keywordflow">if</span>( d &lt;= t ) {
<a name="l00674"></a>00674                       t = d; <span class="keywordflow">if</span>( (++iz) &lt; nz ) inew = ireg+nxy; <span class="keywordflow">else</span> inew = -1;
<a name="l00675"></a>00675                       <span class="keywordflow">if</span>( normal ) *normal = <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a>(0,0,-1);
<a name="l00676"></a>00676                   }
<a name="l00677"></a>00677               }
<a name="l00678"></a>00678               <span class="keywordflow">else</span> <span class="keywordflow">if</span>( u.<a class="code" href="classEGS__Vector.html#a4d45f2e6f756337d6b06b006e04bfc87" title="z-component">z</a> &lt; 0 ) {
<a name="l00679"></a>00679                   EGS_Float d = (zpos[iz]-x.<a class="code" href="classEGS__Vector.html#a4d45f2e6f756337d6b06b006e04bfc87" title="z-component">z</a>)/u.<a class="code" href="classEGS__Vector.html#a4d45f2e6f756337d6b06b006e04bfc87" title="z-component">z</a>;
<a name="l00680"></a>00680                   <span class="keywordflow">if</span>( d &lt;= t ) {
<a name="l00681"></a>00681                       t = d; <span class="keywordflow">if</span>( (--iz) &gt;= 0 ) inew = ireg-nxy; <span class="keywordflow">else</span> inew = -1;
<a name="l00682"></a>00682                       <span class="keywordflow">if</span>( normal ) *normal = <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a>(0,0,1);
<a name="l00683"></a>00683                   }
<a name="l00684"></a>00684               }
<a name="l00685"></a>00685               <span class="keywordflow">if</span>( newmed &amp;&amp; inew &gt;= 0 ) *newmed = <a class="code" href="classEGS__BaseGeometry.html#aeae04119c0fa7a94b41627460878bd24" title="Returns the medium index in region ireg.">medium</a>(inew);
<a name="l00686"></a>00686               <span class="keywordflow">return</span> inew;
<a name="l00687"></a>00687           }
<a name="l00688"></a>00688           <span class="keywordtype">int</span> face,ix,iy,iz;
<a name="l00689"></a>00689           <span class="keywordtype">int</span> inew = howfarFromOut(x,u,t,ix,iy,iz,face,normal);
<a name="l00690"></a>00690           <span class="keywordflow">if</span>( inew &gt;= 0 &amp;&amp; newmed ) *newmed = <a class="code" href="classEGS__BaseGeometry.html#aeae04119c0fa7a94b41627460878bd24" title="Returns the medium index in region ireg.">medium</a>(inew);
<a name="l00691"></a>00691           <span class="keywordflow">return</span> inew;
<a name="l00692"></a>00692       };
<a name="l00693"></a>00693 
<a name="l00694"></a>00694       EGS_Float <a class="code" href="classEGS__BaseGeometry.html#a111e6d8ea34e403bebaf3621223950d9" title="Calculate the distance to a boundary for position x in any direction.">hownear</a>(<span class="keywordtype">int</span> ireg, <span class="keyword">const</span> <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> &amp;x) {
<a name="l00695"></a>00695           <span class="keywordflow">if</span>( ireg &gt;= 0 ) {
<a name="l00696"></a>00696               <span class="keywordtype">int</span> iz = ireg/nxy; <span class="keywordtype">int</span> ir = ireg - iz*nxy;
<a name="l00697"></a>00697               <span class="keywordtype">int</span> iy = ir/nx; <span class="keywordtype">int</span> ix = ir - iy*nx;
<a name="l00698"></a>00698               EGS_Float t = xp-&gt;hownear(ix,x);
<a name="l00699"></a>00699               EGS_Float t1 = yp-&gt;hownear(iy,x);
<a name="l00700"></a>00700               <span class="keywordflow">if</span>( t1 &lt; t ) t = t1;
<a name="l00701"></a>00701               t1 = zp-&gt;hownear(iz,x);
<a name="l00702"></a>00702               <span class="keywordflow">if</span>( t1 &lt; t ) t = t1;
<a name="l00703"></a>00703               <span class="keywordflow">return</span> t;
<a name="l00704"></a>00704           }
<a name="l00705"></a>00705           <span class="keywordtype">int</span> nc = 0; EGS_Float s1=0, s2=0;
<a name="l00706"></a>00706           <span class="keywordflow">if</span>( !xp-&gt;isInside(x) ) {
<a name="l00707"></a>00707               EGS_Float t = xp-&gt;hownear(-1,x);
<a name="l00708"></a>00708               nc++; s1 += t; s2 += t*t;
<a name="l00709"></a>00709           }
<a name="l00710"></a>00710           <span class="keywordflow">if</span>( !yp-&gt;isInside(x) ) {
<a name="l00711"></a>00711               EGS_Float t = yp-&gt;hownear(-1,x);
<a name="l00712"></a>00712               nc++; s1 += t; s2 += t*t;
<a name="l00713"></a>00713           }
<a name="l00714"></a>00714           <span class="keywordflow">if</span>( !zp-&gt;isInside(x) ) {
<a name="l00715"></a>00715               EGS_Float t = zp-&gt;hownear(-1,x);
<a name="l00716"></a>00716               nc++; s1 += t; s2 += t*t;
<a name="l00717"></a>00717           }
<a name="l00718"></a>00718           <span class="keywordflow">if</span>( nc == 1 ) <span class="keywordflow">return</span> s1;
<a name="l00719"></a>00719           <span class="keywordflow">return</span> sqrt(s2);
<a name="l00720"></a>00720       };
<a name="l00721"></a>00721 
<a name="l00722"></a>00722 
<a name="l00723"></a>00723       EGS_Float <a class="code" href="classEGS__BaseGeometry.html#a4282471032a86bd0dbad1ccb994399b5" title="Calculates the volume*relative rho (rhor) of region ireg.">getMass</a>(<span class="keywordtype">int</span> ireg) {
<a name="l00724"></a>00724           <span class="keywordflow">if</span>( ireg &gt;= 0 ) {
<a name="l00725"></a>00725               <span class="keywordtype">int</span> iz = ireg/nxy; <span class="keywordtype">int</span> ir = ireg - iz*nxy;
<a name="l00726"></a>00726               <span class="keywordtype">int</span> iy = ir/nx; <span class="keywordtype">int</span> ix = ir - iy*nx;
<a name="l00727"></a>00727               EGS_Float vol = (xpos[ix+1]-xpos[ix])*(ypos[iy+1]-ypos[iy])*
<a name="l00728"></a>00728                               (zpos[iz+1]-zpos[iz]);
<a name="l00729"></a>00729               EGS_Float dens = <a class="code" href="classEGS__BaseGeometry.html#ae73ccf5d1d1264f3865b275a99ce1377" title="Get the relative mass density in region ireg.">getRelativeRho</a>(ireg);
<a name="l00730"></a>00730               EGS_Float mass = vol*dens;
<a name="l00731"></a>00731               <span class="keywordflow">return</span> mass;
<a name="l00732"></a>00732           }
<a name="l00733"></a>00733           <span class="keywordflow">else</span> {
<a name="l00734"></a>00734               <span class="keywordflow">return</span> 1.0;
<a name="l00735"></a>00735           }
<a name="l00736"></a>00736       }
<a name="l00737"></a>00737 
<a name="l00738"></a>00738      EGS_Float <a class="code" href="classEGS__BaseGeometry.html#abeb4b60a8eb162592b22970ec676a34e" title="Returns region boundaries in direction determined by idir.">getBound</a>(<span class="keywordtype">int</span> idir, <span class="keywordtype">int</span> ind) {
<a name="l00739"></a>00739           EGS_Float bound;
<a name="l00740"></a>00740           <span class="keywordflow">if</span>(idir == 0) {
<a name="l00741"></a>00741             <span class="keywordflow">if</span>(ind&gt;=0 &amp;&amp; ind&lt;=nx) bound = xpos[ind];
<a name="l00742"></a>00742             <span class="keywordflow">else</span> {
<a name="l00743"></a>00743               <a class="code" href="group__egspp__main.html#gadf4109d942f372e48e1dea86c0ca62cb" title="Always use this function for reporting warnings.">egsWarning</a>(<span class="stringliteral">&quot;Error in getBound: Looking for X bound out of range %d\n&quot;</span>
<a name="l00744"></a>00744                          <span class="stringliteral">&quot;Will set this to zero.\n&quot;</span>,ind);
<a name="l00745"></a>00745               bound = 0.0;
<a name="l00746"></a>00746             }
<a name="l00747"></a>00747           }
<a name="l00748"></a>00748           <span class="keywordflow">else</span> <span class="keywordflow">if</span>(idir == 1) {
<a name="l00749"></a>00749             <span class="keywordflow">if</span>(ind&gt;=0 &amp;&amp; ind&lt;=ny) bound = ypos[ind];
<a name="l00750"></a>00750             <span class="keywordflow">else</span> {
<a name="l00751"></a>00751               <a class="code" href="group__egspp__main.html#gadf4109d942f372e48e1dea86c0ca62cb" title="Always use this function for reporting warnings.">egsWarning</a>(<span class="stringliteral">&quot;Error in getBound: Looking for Y bound out of range %d\n&quot;</span>
<a name="l00752"></a>00752                          <span class="stringliteral">&quot;Will set this to zero.\n&quot;</span>,ind);
<a name="l00753"></a>00753               bound = 0.0;
<a name="l00754"></a>00754             }
<a name="l00755"></a>00755           }
<a name="l00756"></a>00756           <span class="keywordflow">else</span> <span class="keywordflow">if</span>(idir == 2) {
<a name="l00757"></a>00757             <span class="keywordflow">if</span>(ind&gt;=0 &amp;&amp; ind&lt;=nz) bound = zpos[ind];
<a name="l00758"></a>00758             <span class="keywordflow">else</span> {
<a name="l00759"></a>00759               <a class="code" href="group__egspp__main.html#gadf4109d942f372e48e1dea86c0ca62cb" title="Always use this function for reporting warnings.">egsWarning</a>(<span class="stringliteral">&quot;Error in getBound: Looking for Z bound out of range %d\n&quot;</span>
<a name="l00760"></a>00760                          <span class="stringliteral">&quot;Will set this to zero.\n&quot;</span>,ind);
<a name="l00761"></a>00761               bound = 0.0;
<a name="l00762"></a>00762             }
<a name="l00763"></a>00763           }
<a name="l00764"></a>00764           <span class="keywordflow">else</span> {
<a name="l00765"></a>00765             <a class="code" href="group__egspp__main.html#gadf4109d942f372e48e1dea86c0ca62cb" title="Always use this function for reporting warnings.">egsWarning</a>(<span class="stringliteral">&quot;Error in getBound: Dimension %d undefined in EGS_XYZGeometry.\n&quot;</span>,idir);
<a name="l00766"></a>00766             bound = 0.0;
<a name="l00767"></a>00767           }
<a name="l00768"></a>00768           <span class="keywordflow">return</span> bound;
<a name="l00769"></a>00769       }
<a name="l00770"></a>00770 
<a name="l00771"></a>00771       <span class="keywordtype">int</span> <a class="code" href="classEGS__BaseGeometry.html#aa1a748c8520d94038cb4743010629826">getNRegDir</a>(<span class="keywordtype">int</span> idir) {
<a name="l00772"></a>00772           <span class="keywordflow">if</span>(idir==0) <span class="keywordflow">return</span> nx;
<a name="l00773"></a>00773           <span class="keywordflow">else</span> <span class="keywordflow">if</span>(idir==1) <span class="keywordflow">return</span> ny;
<a name="l00774"></a>00774           <span class="keywordflow">else</span> <span class="keywordflow">if</span>(idir==2) <span class="keywordflow">return</span> nz;
<a name="l00775"></a>00775           <span class="keywordflow">else</span> {
<a name="l00776"></a>00776             <a class="code" href="group__egspp__main.html#gadf4109d942f372e48e1dea86c0ca62cb" title="Always use this function for reporting warnings.">egsWarning</a>(<span class="stringliteral">&quot;Error in getNregDir: Dimension %d undefined in EGS_XYZGeometry.\n&quot;</span>,
<a name="l00777"></a>00777                        idir);
<a name="l00778"></a>00778             <span class="keywordflow">return</span> 0;
<a name="l00779"></a>00779           }
<a name="l00780"></a>00780       }
<a name="l00781"></a>00781 
<a name="l00782"></a>00782 
<a name="l00783"></a>00783       <span class="keywordtype">int</span> <a class="code" href="classEGS__BaseGeometry.html#a8bc9aebe58a23ed3b6d9f2d4c72265fa" title="Returns the maximum number of steps through the geometry.">getMaxStep</a>()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> nx+ny+nz+1; };
<a name="l00784"></a>00784 
<a name="l00785"></a>00785       <span class="keywordtype">int</span> getNx()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> nx; };
<a name="l00786"></a>00786       <span class="keywordtype">int</span> getNy()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> ny; };
<a name="l00787"></a>00787       <span class="keywordtype">int</span> getNz()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> nz; };
<a name="l00788"></a>00788 
<a name="l00789"></a>00789       EGS_Float *getXPositions() { <span class="keywordflow">return</span> xp-&gt;getPositions(); };
<a name="l00790"></a>00790       EGS_Float *getYPositions() { <span class="keywordflow">return</span> yp-&gt;getPositions(); };
<a name="l00791"></a>00791       EGS_Float *getZPositions() { <span class="keywordflow">return</span> zp-&gt;getPositions(); };
<a name="l00792"></a>00792 
<a name="l00793"></a>00793       <span class="keyword">static</span> <span class="keywordtype">int</span> getDigits(<span class="keywordtype">int</span> i);
<a name="l00794"></a>00794 
<a name="l00795"></a>00795       <span class="keyword">const</span> <span class="keywordtype">string</span> &amp;<a class="code" href="classEGS__BaseGeometry.html#a2df5b0631c3bd57250a6a57cad56323c" title="Get the geometry type.">getType</a>()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> type; };
<a name="l00796"></a>00796 
<a name="l00797"></a>00797       <span class="keywordtype">void</span> <a class="code" href="classEGS__BaseGeometry.html#a90b349e45353ab0b7fa32053a9d37085" title="Print information about this geometry.">printInfo</a>() <span class="keyword">const</span>;
<a name="l00798"></a>00798 
<a name="l00799"></a>00799       <span class="keyword">static</span> <a class="code" href="classEGS__XYZGeometry.html" title="An XYZ-geometry.">EGS_XYZGeometry</a>* constructGeometry(<span class="keyword">const</span> <span class="keywordtype">char</span> *dens_or_egphant_file,
<a name="l00800"></a>00800               <span class="keyword">const</span> <span class="keywordtype">char</span> *ramp_file, <span class="keywordtype">int</span> dens_or_egphant=0);
<a name="l00801"></a>00801       <span class="keyword">static</span> <a class="code" href="classEGS__XYZGeometry.html" title="An XYZ-geometry.">EGS_XYZGeometry</a>* constructCTGeometry(<span class="keyword">const</span> <span class="keywordtype">char</span> *dens_or_egphant_file);
<a name="l00802"></a>00802 
<a name="l00803"></a>00803       <span class="keywordtype">void</span> voxelizeGeometry(<a class="code" href="classEGS__Input.html" title="A class for storing information in a tree-like structure of key-value pairs. This class is used throu...">EGS_Input</a> *input);
<a name="l00804"></a>00804 
<a name="l00805"></a>00805       <span class="keywordtype">void</span> setXYZLabels (<a class="code" href="classEGS__Input.html" title="A class for storing information in a tree-like structure of key-value pairs. This class is used throu...">EGS_Input</a> *input);
<a name="l00806"></a>00806 
<a name="l00807"></a>00807       <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classEGS__BaseGeometry.html#a2e938cb893fb564a3cf4e2141a2173c1" title="Get the list of all regions labeled with str.">getLabelRegions</a> (<span class="keyword">const</span> <span class="keywordtype">string</span> &amp;str, vector&lt;int&gt; &amp;regs);
<a name="l00808"></a>00808       <span class="keywordtype">void</span> getXLabelRegions (<span class="keyword">const</span> <span class="keywordtype">string</span> &amp;str, vector&lt;int&gt; &amp;regs) { xp-&gt;getLabelRegions(str, regs); }
<a name="l00809"></a>00809       <span class="keywordtype">void</span> getYLabelRegions (<span class="keyword">const</span> <span class="keywordtype">string</span> &amp;str, vector&lt;int&gt; &amp;regs) { yp-&gt;getLabelRegions(str, regs); }
<a name="l00810"></a>00810       <span class="keywordtype">void</span> getZLabelRegions (<span class="keyword">const</span> <span class="keywordtype">string</span> &amp;str, vector&lt;int&gt; &amp;regs) { zp-&gt;getLabelRegions(str, regs); }
<a name="l00811"></a>00811 
<a name="l00812"></a>00812 <span class="keyword">protected</span>:
<a name="l00813"></a>00813 
<a name="l00814"></a>00814       <a class="code" href="classEGS__PlanesT.html" title="A set of parallel planes.">EGS_PlanesX</a>      *xp;
<a name="l00815"></a>00815       <a class="code" href="classEGS__PlanesT.html" title="A set of parallel planes.">EGS_PlanesY</a>      *yp;
<a name="l00816"></a>00816       <a class="code" href="classEGS__PlanesT.html" title="A set of parallel planes.">EGS_PlanesZ</a>      *zp;
<a name="l00817"></a>00817       EGS_Float        *xpos;
<a name="l00818"></a>00818       EGS_Float        *ypos;
<a name="l00819"></a>00819       EGS_Float        *zpos;
<a name="l00820"></a>00820       <span class="keywordtype">int</span>              nx, ny, nz, nxy;
<a name="l00821"></a>00821       <span class="keyword">static</span> <span class="keywordtype">string</span>    type;
<a name="l00822"></a>00822 
<a name="l00823"></a>00823       <span class="keywordtype">void</span> setup();
<a name="l00824"></a>00824 
<a name="l00825"></a>00825       <span class="keywordtype">void</span> <a class="code" href="classEGS__BaseGeometry.html#a28bf612777de14f97108021ae7eb3865" title="Set the media in the geometry from the input pointed to by inp.">setMedia</a>(<a class="code" href="classEGS__Input.html" title="A class for storing information in a tree-like structure of key-value pairs. This class is used throu...">EGS_Input</a> *inp, <span class="keywordtype">int</span> nmed, <span class="keyword">const</span> <span class="keywordtype">int</span> *med_ind);
<a name="l00826"></a>00826 
<a name="l00827"></a>00827       <span class="keywordtype">int</span> howfarFromOut(<span class="keyword">const</span> <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> &amp;x, <span class="keyword">const</span> <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> &amp;u,
<a name="l00828"></a>00828                  EGS_Float &amp;t, <span class="keywordtype">int</span> &amp;ix, <span class="keywordtype">int</span> &amp;iy, <span class="keywordtype">int</span> &amp;iz,
<a name="l00829"></a>00829                  <span class="keywordtype">int</span> &amp;face, <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> *normal=0) {
<a name="l00830"></a>00830           ix = -1; EGS_Float t1;
<a name="l00831"></a>00831           <span class="keywordflow">if</span>( x.<a class="code" href="classEGS__Vector.html#aa67c962f9024c44d15f446c122d25cbf" title="x-component">x</a> &lt;= xpos[0] &amp;&amp; u.<a class="code" href="classEGS__Vector.html#aa67c962f9024c44d15f446c122d25cbf" title="x-component">x</a> &gt; 0 ) {
<a name="l00832"></a>00832               t1 = (xpos[0]-x.<a class="code" href="classEGS__Vector.html#aa67c962f9024c44d15f446c122d25cbf" title="x-component">x</a>)/u.<a class="code" href="classEGS__Vector.html#aa67c962f9024c44d15f446c122d25cbf" title="x-component">x</a>; ix = 0; face = 0;
<a name="l00833"></a>00833           }
<a name="l00834"></a>00834           <span class="keywordflow">else</span> <span class="keywordflow">if</span>( x.<a class="code" href="classEGS__Vector.html#aa67c962f9024c44d15f446c122d25cbf" title="x-component">x</a> &gt;= xpos[nx] &amp;&amp; u.<a class="code" href="classEGS__Vector.html#aa67c962f9024c44d15f446c122d25cbf" title="x-component">x</a> &lt; 0 ) {
<a name="l00835"></a>00835               t1 = (xpos[nx]-x.<a class="code" href="classEGS__Vector.html#aa67c962f9024c44d15f446c122d25cbf" title="x-component">x</a>)/u.<a class="code" href="classEGS__Vector.html#aa67c962f9024c44d15f446c122d25cbf" title="x-component">x</a>; ix = nx-1; face = 1;
<a name="l00836"></a>00836           }
<a name="l00837"></a>00837           <span class="keywordflow">if</span>( ix &gt;= 0 &amp;&amp; t1 &lt;= t ) {
<a name="l00838"></a>00838               <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> tmp(x + u*t1);
<a name="l00839"></a>00839               iy = yp-&gt;isWhere(tmp);
<a name="l00840"></a>00840               <span class="keywordflow">if</span>( iy &gt;= 0 ) {
<a name="l00841"></a>00841                   iz = zp-&gt;isWhere(tmp);
<a name="l00842"></a>00842                   <span class="keywordflow">if</span>( iz &gt;= 0 ) {
<a name="l00843"></a>00843                       <span class="keywordtype">int</span> inew =  ix + iy*nx + iz*nxy;
<a name="l00844"></a>00844                       <span class="keywordflow">if</span> (t1 &lt; epsilon) {
<a name="l00845"></a>00845                           <span class="keywordtype">int</span> itest = <a class="code" href="classEGS__BaseGeometry.html#a42a459b557011291ea2e8978ebee6295" title="Calculate the distance to a boundary from x along the direction u.">howfar</a>(inew, tmp, u, t1);
<a name="l00846"></a>00846                           <span class="keywordflow">if</span> (itest == -1 &amp;&amp; t1 &lt; epsilon) <span class="keywordflow">return</span> -1;
<a name="l00847"></a>00847                       }
<a name="l00848"></a>00848                       <span class="keywordflow">if</span>( normal ) *normal = face == 0 ? <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a>(-1,0,0) :
<a name="l00849"></a>00849                                                          <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a>( 1,0,0);
<a name="l00850"></a>00850                       t = t1;
<a name="l00851"></a>00851                       <span class="keywordflow">return</span> inew;
<a name="l00852"></a>00852                   }
<a name="l00853"></a>00853               }
<a name="l00854"></a>00854           }
<a name="l00855"></a>00855           iy = -1;
<a name="l00856"></a>00856           <span class="keywordflow">if</span>( x.<a class="code" href="classEGS__Vector.html#a156335a0c0cee0f4c6f6e23aac316350" title="y-component">y</a> &lt;= ypos[0] &amp;&amp; u.<a class="code" href="classEGS__Vector.html#a156335a0c0cee0f4c6f6e23aac316350" title="y-component">y</a> &gt; 0 ) {
<a name="l00857"></a>00857               t1 = (ypos[0]-x.<a class="code" href="classEGS__Vector.html#a156335a0c0cee0f4c6f6e23aac316350" title="y-component">y</a>)/u.<a class="code" href="classEGS__Vector.html#a156335a0c0cee0f4c6f6e23aac316350" title="y-component">y</a>; iy = 0; face = 2;
<a name="l00858"></a>00858           }
<a name="l00859"></a>00859           <span class="keywordflow">else</span> <span class="keywordflow">if</span>( x.<a class="code" href="classEGS__Vector.html#a156335a0c0cee0f4c6f6e23aac316350" title="y-component">y</a> &gt;= ypos[ny] &amp;&amp; u.<a class="code" href="classEGS__Vector.html#a156335a0c0cee0f4c6f6e23aac316350" title="y-component">y</a> &lt; 0 ) {
<a name="l00860"></a>00860               t1 = (ypos[ny]-x.<a class="code" href="classEGS__Vector.html#a156335a0c0cee0f4c6f6e23aac316350" title="y-component">y</a>)/u.<a class="code" href="classEGS__Vector.html#a156335a0c0cee0f4c6f6e23aac316350" title="y-component">y</a>; iy = ny-1; face = 3;
<a name="l00861"></a>00861           }
<a name="l00862"></a>00862           <span class="keywordflow">if</span>( iy &gt;= 0 &amp;&amp; t1 &lt;= t ) {
<a name="l00863"></a>00863               <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> tmp(x + u*t1);
<a name="l00864"></a>00864               ix = xp-&gt;isWhere(tmp);
<a name="l00865"></a>00865               <span class="keywordflow">if</span>( ix &gt;= 0 ) {
<a name="l00866"></a>00866                   iz = zp-&gt;isWhere(tmp);
<a name="l00867"></a>00867                   <span class="keywordflow">if</span>( iz &gt;= 0 ) {
<a name="l00868"></a>00868                       <span class="keywordtype">int</span> inew =  ix + iy*nx + iz*nxy;
<a name="l00869"></a>00869                       <span class="keywordflow">if</span> (t1 &lt; epsilon) {
<a name="l00870"></a>00870                           <span class="keywordtype">int</span> itest = <a class="code" href="classEGS__BaseGeometry.html#a42a459b557011291ea2e8978ebee6295" title="Calculate the distance to a boundary from x along the direction u.">howfar</a>(inew, tmp, u, t1);
<a name="l00871"></a>00871                           <span class="keywordflow">if</span> (itest == -1 &amp;&amp; t1 &lt; epsilon) <span class="keywordflow">return</span> -1;
<a name="l00872"></a>00872                       }
<a name="l00873"></a>00873                       <span class="keywordflow">if</span>( normal ) *normal = face == 2 ? <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a>(0,-1,0) :
<a name="l00874"></a>00874                                                          <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a>(0, 1,0);
<a name="l00875"></a>00875                       t = t1;
<a name="l00876"></a>00876                       <span class="keywordflow">return</span> inew;
<a name="l00877"></a>00877                   }
<a name="l00878"></a>00878               }
<a name="l00879"></a>00879           }
<a name="l00880"></a>00880           iz = -1;
<a name="l00881"></a>00881           <span class="keywordflow">if</span>( x.<a class="code" href="classEGS__Vector.html#a4d45f2e6f756337d6b06b006e04bfc87" title="z-component">z</a> &lt;= zpos[0] &amp;&amp; u.<a class="code" href="classEGS__Vector.html#a4d45f2e6f756337d6b06b006e04bfc87" title="z-component">z</a> &gt; 0 ) {
<a name="l00882"></a>00882               t1 = (zpos[0]-x.<a class="code" href="classEGS__Vector.html#a4d45f2e6f756337d6b06b006e04bfc87" title="z-component">z</a>)/u.<a class="code" href="classEGS__Vector.html#a4d45f2e6f756337d6b06b006e04bfc87" title="z-component">z</a>; iz = 0; face = 4;
<a name="l00883"></a>00883           }
<a name="l00884"></a>00884           <span class="keywordflow">else</span> <span class="keywordflow">if</span>( x.<a class="code" href="classEGS__Vector.html#a4d45f2e6f756337d6b06b006e04bfc87" title="z-component">z</a> &gt;= zpos[nz] &amp;&amp; u.<a class="code" href="classEGS__Vector.html#a4d45f2e6f756337d6b06b006e04bfc87" title="z-component">z</a> &lt; 0 ) {
<a name="l00885"></a>00885               t1 = (zpos[nz]-x.<a class="code" href="classEGS__Vector.html#a4d45f2e6f756337d6b06b006e04bfc87" title="z-component">z</a>)/u.<a class="code" href="classEGS__Vector.html#a4d45f2e6f756337d6b06b006e04bfc87" title="z-component">z</a>; iz = nz-1; face = 5;
<a name="l00886"></a>00886           }
<a name="l00887"></a>00887           <span class="keywordflow">if</span>( iz &gt;= 0 &amp;&amp; t1 &lt;= t ) {
<a name="l00888"></a>00888               <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> tmp(x + u*t1);
<a name="l00889"></a>00889               ix = xp-&gt;isWhere(tmp);
<a name="l00890"></a>00890               <span class="keywordflow">if</span>( ix &gt;= 0 ) {
<a name="l00891"></a>00891                   iy = yp-&gt;isWhere(tmp);
<a name="l00892"></a>00892                   <span class="keywordflow">if</span>( iy &gt;= 0 ) {
<a name="l00893"></a>00893                       <span class="keywordtype">int</span> inew =  ix + iy*nx + iz*nxy;
<a name="l00894"></a>00894                       <span class="keywordflow">if</span> (t1 &lt; epsilon) {
<a name="l00895"></a>00895                           <span class="keywordtype">int</span> itest = <a class="code" href="classEGS__BaseGeometry.html#a42a459b557011291ea2e8978ebee6295" title="Calculate the distance to a boundary from x along the direction u.">howfar</a>(inew, tmp, u, t1);
<a name="l00896"></a>00896                           <span class="keywordflow">if</span> (itest == -1 &amp;&amp; t1 &lt; epsilon) <span class="keywordflow">return</span> -1;
<a name="l00897"></a>00897                       }
<a name="l00898"></a>00898                       <span class="keywordflow">if</span>( normal ) *normal = face == 4 ? <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a>(0,0,-1) :
<a name="l00899"></a>00899                                                          <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a>(0,0, 1);
<a name="l00900"></a>00900                       t = t1;
<a name="l00901"></a>00901                       <span class="keywordflow">return</span> inew;
<a name="l00902"></a>00902                   }
<a name="l00903"></a>00903               }
<a name="l00904"></a>00904           }
<a name="l00905"></a>00905           <span class="keywordflow">return</span> -1;
<a name="l00906"></a>00906       };
<a name="l00907"></a>00907 };
<a name="l00908"></a>00908 
<a name="l00923"></a><a class="code" href="classEGS__DeformedXYZ.html">00923</a> <span class="keyword">class </span>EGS_NDG_EXPORT <a class="code" href="classEGS__DeformedXYZ.html" title="A deformed XYZ-geometry.">EGS_DeformedXYZ</a> : <span class="keyword">public</span> <a class="code" href="classEGS__XYZGeometry.html" title="An XYZ-geometry.">EGS_XYZGeometry</a> {
<a name="l00924"></a>00924 
<a name="l00925"></a>00925 <span class="keyword">public</span>:
<a name="l00926"></a>00926 
<a name="l00927"></a>00927     <a class="code" href="classEGS__DeformedXYZ.html" title="A deformed XYZ-geometry.">EGS_DeformedXYZ</a>(<a class="code" href="classEGS__PlanesT.html" title="A set of parallel planes.">EGS_PlanesX</a> *Xp, <a class="code" href="classEGS__PlanesT.html" title="A set of parallel planes.">EGS_PlanesY</a> *Yp, <a class="code" href="classEGS__PlanesT.html" title="A set of parallel planes.">EGS_PlanesZ</a> *Zp,
<a name="l00928"></a>00928               <span class="keyword">const</span> <span class="keywordtype">char</span> *defFile, <span class="keyword">const</span> <span class="keywordtype">string</span> &amp;Name = <span class="stringliteral">&quot;&quot;</span>);
<a name="l00929"></a>00929 
<a name="l00930"></a>00930     ~<a class="code" href="classEGS__DeformedXYZ.html" title="A deformed XYZ-geometry.">EGS_DeformedXYZ</a>();
<a name="l00931"></a>00931 
<a name="l00932"></a>00932     <span class="keywordtype">int</span> isWhere(<span class="keyword">const</span> <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> &amp;x) {
<a name="l00933"></a>00933         <span class="keywordtype">int</span> ireg = EGS_XYZGeometry::isWhere(x);
<a name="l00934"></a>00934         <span class="keywordflow">if</span>( ireg &gt;= 0 ) <a class="code" href="group__egspp__main.html#ga4454fdf3403e87c098cd55f60dedbe56" title="Always use this function for reporting fatal errors.">egsFatal</a>(<span class="stringliteral">&quot;EGS_DeformedXYZ::isWhere(): this geometry &quot;</span>
<a name="l00935"></a>00935            <span class="stringliteral">&quot;does not allow the use of this method with position inside\n&quot;</span>);
<a name="l00936"></a>00936         <span class="keywordflow">return</span> ireg;
<a name="l00937"></a>00937     };
<a name="l00938"></a>00938 
<a name="l00939"></a>00939     <span class="keywordtype">int</span> inside(<span class="keyword">const</span> <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> &amp;x) { <span class="keywordflow">return</span> isWhere(x); };
<a name="l00940"></a>00940 
<a name="l00941"></a>00941     <span class="keywordtype">int</span> <a class="code" href="classEGS__BaseGeometry.html#aeae04119c0fa7a94b41627460878bd24" title="Returns the medium index in region ireg.">medium</a>(<span class="keywordtype">int</span> ireg)<span class="keyword"> const </span>{ <span class="keywordflow">return</span> <a class="code" href="classEGS__BaseGeometry.html#aeae04119c0fa7a94b41627460878bd24" title="Returns the medium index in region ireg.">EGS_XYZGeometry::medium</a>(ireg/6); };
<a name="l00942"></a>00942 
<a name="l00943"></a>00943     <span class="keywordtype">int</span> howfar(<span class="keywordtype">int</span> ireg, <span class="keyword">const</span> <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> &amp;x, <span class="keyword">const</span> <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> &amp;u,
<a name="l00944"></a>00944                EGS_Float &amp;t, <span class="keywordtype">int</span> *newmed=0, <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> *normal=0) {
<a name="l00945"></a>00945         <span class="keywordflow">if</span>( ireg &gt;= 0 ) {
<a name="l00946"></a>00946             <span class="keywordtype">int</span> ir = ireg/6, tetra = ireg - 6*ir, tetra4 = 4*tetra;
<a name="l00947"></a>00947             <span class="keywordtype">int</span> ind[3];
<a name="l00948"></a>00948             ind[2] = ir/nxy; ind[1] = (ir - ind[2]*nxy)/nx;
<a name="l00949"></a>00949             ind[0] = ir - ind[2]*nxy - ind[1]*nx;
<a name="l00950"></a>00950             <span class="keywordtype">int</span> edge = ir + ind[1] + ind[2]*nxyp1;
<a name="l00951"></a>00951             <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> n0(vectors[edge+tnodes[tetra4]]),
<a name="l00952"></a>00952                        n1(vectors[edge+tnodes[tetra4+1]]-n0),
<a name="l00953"></a>00953                        n2(vectors[edge+tnodes[tetra4+2]]-n0),
<a name="l00954"></a>00954                        n3(vectors[edge+tnodes[tetra4+3]]-n0);
<a name="l00955"></a>00955             <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> n0x(n0-x);
<a name="l00956"></a>00956             EGS_Float disti[4],dpi[4]; <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> normvec;
<a name="l00957"></a>00957             normvec = n1%n2; dpi[0]=normvec*u; disti[0]=normvec*n0x;
<a name="l00958"></a>00958             normvec = n3%n1; dpi[2]=normvec*u; disti[2]=normvec*n0x;
<a name="l00959"></a>00959             normvec = n2%n3; dpi[1]=normvec*u; disti[1]=normvec*n0x;
<a name="l00960"></a>00960             normvec = (n3-n1)%(n2-n1);
<a name="l00961"></a>00961             dpi[3] = normvec*u; disti[3] = normvec*(n0x+n1);
<a name="l00962"></a>00962             <span class="keywordtype">int</span> nextplane = 4; EGS_Float mindist = t, mindp=1;
<a name="l00963"></a>00963             <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;4; ++i) {
<a name="l00964"></a>00964                 <span class="keywordflow">if</span>( dpi[i] &gt; 0 &amp;&amp; disti[i]*mindp &lt; mindist*dpi[i] ) {
<a name="l00965"></a>00965                     mindist = disti[i]; mindp=dpi[i]; nextplane=i;
<a name="l00966"></a>00966                 }
<a name="l00967"></a>00967             }
<a name="l00968"></a>00968             <span class="keywordflow">if</span>( nextplane == 4 ) <span class="keywordflow">return</span> ireg;
<a name="l00969"></a>00969             t = mindist/mindp;
<a name="l00970"></a>00970             <span class="keywordtype">int</span> j = 12*tetra + 3*nextplane;
<a name="l00971"></a>00971             <span class="keywordtype">int</span> next = tetra_data[j];
<a name="l00972"></a>00972             <span class="keywordtype">int</span> irnew = ir;
<a name="l00973"></a>00973             <span class="keywordflow">if</span>( next &gt;= 0 ) {
<a name="l00974"></a>00974                 ind[next] += tetra_data[j+1];
<a name="l00975"></a>00975                 <span class="keywordflow">if</span>( ind[next] &lt; 0 || ind[next] &gt;= np[next] ) <span class="keywordflow">return</span> -1;
<a name="l00976"></a>00976                 irnew = ind[0] + ind[1]*nx + ind[2]*nxy;
<a name="l00977"></a>00977             }
<a name="l00978"></a>00978             <span class="keywordflow">if</span>( newmed ) *newmed = <a class="code" href="classEGS__BaseGeometry.html#aeae04119c0fa7a94b41627460878bd24" title="Returns the medium index in region ireg.">EGS_XYZGeometry::medium</a>(irnew);
<a name="l00979"></a>00979             <span class="keywordflow">if</span>( normal ) {
<a name="l00980"></a>00980                 <span class="keywordflow">switch</span>(nextplane) {
<a name="l00981"></a>00981                     <span class="keywordflow">case</span> 0: *normal = n2%n1; <span class="keywordflow">break</span>;
<a name="l00982"></a>00982                     <span class="keywordflow">case</span> 1: *normal = n1%n3; <span class="keywordflow">break</span>;
<a name="l00983"></a>00983                     <span class="keywordflow">case</span> 2: *normal = n3%n2; <span class="keywordflow">break</span>;
<a name="l00984"></a>00984                     <span class="keywordflow">case</span> 3: *normal = (n2-n1)%(n3-n1);
<a name="l00985"></a>00985                 }
<a name="l00986"></a>00986             }
<a name="l00987"></a>00987             <span class="keywordflow">return</span> 6*irnew + tetra_data[j+2];
<a name="l00988"></a>00988         }
<a name="l00989"></a>00989         <span class="keywordtype">int</span> ix,iy,iz,face;
<a name="l00990"></a>00990         <span class="keywordtype">int</span> inew = howfarFromOut(x,u,t,ix,iy,iz,face,normal);
<a name="l00991"></a>00991         <span class="keywordflow">if</span>( inew &lt; 0 ) <span class="keywordflow">return</span> inew;
<a name="l00992"></a>00992         <span class="keywordflow">if</span>( newmed ) *newmed = <a class="code" href="classEGS__BaseGeometry.html#aeae04119c0fa7a94b41627460878bd24" title="Returns the medium index in region ireg.">EGS_XYZGeometry::medium</a>(inew);
<a name="l00993"></a>00993         <span class="comment">// need to determine the tetrahedron we are entering.</span>
<a name="l00994"></a>00994         <span class="keywordtype">int</span> edge = inew + iy + iz*nxyp1;
<a name="l00995"></a>00995         <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> tmp(x + u*t);
<a name="l00996"></a>00996         <span class="keywordtype">int</span> tetra1 = enter_tetra1[face], plane1 = enter_plane1[face];
<a name="l00997"></a>00997         <span class="keywordtype">int</span> node1 = tnodes[4*tetra1 + plane_order[3*plane1]],
<a name="l00998"></a>00998             node2 = tnodes[4*tetra1 + plane_order[3*plane1+1]],
<a name="l00999"></a>00999             node3 = tnodes[4*tetra1 + plane_order[3*plane1+2]];
<a name="l01000"></a>01000         <span class="keywordflow">if</span>( inTriangle(vectors[edge+node1],vectors[edge+node2],
<a name="l01001"></a>01001                        vectors[edge+node3],tmp) ) <span class="keywordflow">return</span> 6*inew + tetra1;
<a name="l01002"></a>01002         <span class="keywordtype">int</span> tetra2 = enter_tetra2[face], plane2 = enter_plane2[face];
<a name="l01003"></a>01003         <span class="keywordtype">int</span> node1a = tnodes[4*tetra2 + plane_order[3*plane2]],
<a name="l01004"></a>01004             node2a = tnodes[4*tetra2 + plane_order[3*plane2+1]],
<a name="l01005"></a>01005             node3a = tnodes[4*tetra2 + plane_order[3*plane2+2]];
<a name="l01006"></a>01006         <span class="keywordflow">if</span>( inTriangle(vectors[edge+node1a],vectors[edge+node2a],
<a name="l01007"></a>01007                        vectors[edge+node3a],tmp) ) <span class="keywordflow">return</span> 6*inew + tetra2;
<a name="l01008"></a>01008         <span class="comment">// roundoff problem</span>
<a name="l01009"></a>01009         <a class="code" href="group__egspp__main.html#gadf4109d942f372e48e1dea86c0ca62cb" title="Always use this function for reporting warnings.">egsWarning</a>(<span class="stringliteral">&quot;deformed geometry: entering from face %d but inTriangle()&quot;</span>
<a name="l01010"></a>01010                 <span class="stringliteral">&quot; fails for both triangles\n&quot;</span>,face);
<a name="l01011"></a>01011         <a class="code" href="group__egspp__main.html#gadf4109d942f372e48e1dea86c0ca62cb" title="Always use this function for reporting warnings.">egsWarning</a>(<span class="stringliteral">&quot;x_enter=(%16.10f,%16.10f,%16.10f)\n&quot;</span>,tmp.<a class="code" href="classEGS__Vector.html#aa67c962f9024c44d15f446c122d25cbf" title="x-component">x</a>,tmp.<a class="code" href="classEGS__Vector.html#a156335a0c0cee0f4c6f6e23aac316350" title="y-component">y</a>,tmp.<a class="code" href="classEGS__Vector.html#a4d45f2e6f756337d6b06b006e04bfc87" title="z-component">z</a>);
<a name="l01012"></a>01012         <span class="keywordflow">return</span> -1;
<a name="l01013"></a>01013     };
<a name="l01014"></a>01014 
<a name="l01015"></a>01015     EGS_Float hownear(<span class="keywordtype">int</span> ireg, <span class="keyword">const</span> <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> &amp;x) {
<a name="l01016"></a>01016         <span class="keywordflow">if</span>( ireg &lt; 0 ) <span class="keywordflow">return</span> EGS_XYZGeometry::hownear(ireg,x);
<a name="l01017"></a>01017         <span class="keywordtype">int</span> ir = ireg/6, tetra = ireg - 6*ir, tetra4 = 4*tetra;
<a name="l01018"></a>01018         <span class="keywordtype">int</span> ind[3];
<a name="l01019"></a>01019         ind[2] = ir/nxy; ind[1] = (ir - ind[2]*nxy)/nx;
<a name="l01020"></a>01020         ind[0] = ir - ind[2]*nxy - ind[1]*nx;
<a name="l01021"></a>01021         <span class="keywordtype">int</span> edge = ir + ind[1] + ind[2]*nxyp1;
<a name="l01022"></a>01022         <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> n0(vectors[edge+tnodes[tetra4]]),
<a name="l01023"></a>01023                    n1(vectors[edge+tnodes[tetra4+1]]-n0),
<a name="l01024"></a>01024                    n2(vectors[edge+tnodes[tetra4+2]]-n0),
<a name="l01025"></a>01025                    n3(vectors[edge+tnodes[tetra4+3]]-n0);
<a name="l01026"></a>01026         <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> n0x(n0-x);
<a name="l01027"></a>01027         EGS_Float disti[4],dpi[4]; <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> normvec;
<a name="l01028"></a>01028         normvec = n1%n2; dpi[0]=normvec.length2(); disti[0]=normvec*n0x;
<a name="l01029"></a>01029         normvec = n3%n1; dpi[2]=normvec.length2(); disti[2]=normvec*n0x;
<a name="l01030"></a>01030         normvec = n2%n3; dpi[1]=normvec.length2(); disti[1]=normvec*n0x;
<a name="l01031"></a>01031         normvec = (n3-n1)%(n2-n1);
<a name="l01032"></a>01032         dpi[3] = normvec.length2(); disti[3] = normvec*(n0x+n1);
<a name="l01033"></a>01033         EGS_Float mindist = 1e30, mindp=1;
<a name="l01034"></a>01034         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0; i&lt;4; ++i) {
<a name="l01035"></a>01035             <span class="keywordflow">if</span>( disti[i]*mindp &lt; mindist*dpi[i] ) {
<a name="l01036"></a>01036                 mindist = disti[i]; mindp=dpi[i];
<a name="l01037"></a>01037             }
<a name="l01038"></a>01038         }
<a name="l01039"></a>01039         <span class="keywordflow">return</span> mindist/mindp;
<a name="l01040"></a>01040     };
<a name="l01041"></a>01041 
<a name="l01042"></a>01042     <span class="keywordtype">int</span> computeIntersections(<span class="keywordtype">int</span> ireg, <span class="keywordtype">int</span> n, <span class="keyword">const</span> <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> &amp;X,
<a name="l01043"></a>01043               <span class="keyword">const</span> <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> &amp;u, <a class="code" href="structEGS__GeometryIntersections.html">EGS_GeometryIntersections</a> *isections) {
<a name="l01044"></a>01044         <span class="keywordflow">return</span> <a class="code" href="classEGS__BaseGeometry.html#a052f3f1f85ef7dc4b3b3c26a43e3ee5b" title="Calculates intersection distances to region boundaries.">EGS_BaseGeometry::computeIntersections</a>(ireg,n,X,u,isections);
<a name="l01045"></a>01045     };
<a name="l01046"></a>01046 
<a name="l01047"></a>01047     EGS_Float howfarToOutside(<span class="keywordtype">int</span> ireg, <span class="keyword">const</span> <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> &amp;x,
<a name="l01048"></a>01048                     <span class="keyword">const</span> <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> &amp;u) {
<a name="l01049"></a>01049         <span class="keywordflow">if</span>( ireg &lt; 0 ) <span class="keywordflow">return</span> 0;
<a name="l01050"></a>01050         <span class="keywordtype">int</span> ir = ireg/6;
<a name="l01051"></a>01051         <span class="keywordtype">int</span> iz = ir/nxy; <span class="keywordtype">int</span> ir1 = ir - iz*nxy;
<a name="l01052"></a>01052         <span class="keywordtype">int</span> iy = ir1/nx; <span class="keywordtype">int</span> ix = ir1 - iy*nx;
<a name="l01053"></a>01053         EGS_Float  d = xp-&gt;howfarToOutside(ix,x,u);
<a name="l01054"></a>01054         EGS_Float ty = yp-&gt;howfarToOutside(iy,x,u); <span class="keywordflow">if</span>( ty &lt; d ) d = ty;
<a name="l01055"></a>01055         EGS_Float tz = zp-&gt;howfarToOutside(iz,x,u); <span class="keywordflow">if</span>( tz &lt; d ) d = tz;
<a name="l01056"></a>01056         <span class="keywordflow">return</span> d;
<a name="l01057"></a>01057     };
<a name="l01058"></a>01058 
<a name="l01059"></a>01059     <span class="keywordtype">int</span> getMaxStep()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> 6*(nx+ny+nz) + 1; };
<a name="l01060"></a>01060 
<a name="l01061"></a>01061     <span class="keyword">const</span> <span class="keywordtype">string</span> &amp;getType()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> def_type; };
<a name="l01062"></a>01062 
<a name="l01063"></a>01063     <span class="keywordtype">void</span> printInfo()<span class="keyword"> const </span>{};
<a name="l01064"></a>01064 
<a name="l01076"></a>01076     <span class="keywordtype">int</span>  setDeformations(<span class="keyword">const</span> <span class="keywordtype">char</span> *defFile);
<a name="l01077"></a>01077 
<a name="l01078"></a>01078     <span class="keywordtype">bool</span> inTriangle(<span class="keyword">const</span> <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> &amp;n0, <span class="keyword">const</span> <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> &amp;n1,
<a name="l01079"></a>01079                     <span class="keyword">const</span> <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> &amp;n2, <span class="keyword">const</span> <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> &amp;x) {
<a name="l01080"></a>01080         <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> u1(n1-n0), u2(n2-n0), xp(x-n0);
<a name="l01081"></a>01081         EGS_Float a=u1.length2(), b=u1*u2, c=u2.length2(), b1=xp*u1, b2=xp*u2;
<a name="l01082"></a>01082         EGS_Float D=a*c-b*b;
<a name="l01083"></a>01083         EGS_Float u=b1*c-b2*b; <span class="keywordflow">if</span>(u&lt;0||u&gt;D) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01084"></a>01084         EGS_Float v=b2*a-b1*b; <span class="keywordflow">if</span>(v&lt;0||u+v&gt;D) <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01085"></a>01085         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01086"></a>01086     };
<a name="l01087"></a>01087 
<a name="l01088"></a>01088 <span class="keyword">protected</span>:
<a name="l01089"></a>01089 
<a name="l01090"></a>01090     <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a>   *vectors;
<a name="l01091"></a>01091 
<a name="l01092"></a>01092     <span class="keywordtype">int</span>          tnodes[24];
<a name="l01093"></a>01093 
<a name="l01094"></a>01094     <span class="keywordtype">int</span>          np[3];
<a name="l01095"></a>01095 
<a name="l01096"></a>01096     <span class="keywordtype">int</span>          nxyp1;
<a name="l01097"></a>01097 
<a name="l01098"></a>01098     <span class="keyword">static</span> <span class="keywordtype">string</span> def_type;
<a name="l01099"></a>01099 
<a name="l01100"></a>01100     <span class="keyword">static</span> <span class="keywordtype">char</span> tetrahedra[];
<a name="l01101"></a>01101 
<a name="l01102"></a>01102     <span class="keyword">static</span> <span class="keywordtype">char</span> plane_order[];
<a name="l01103"></a>01103 
<a name="l01104"></a>01104     <span class="keyword">static</span> <span class="keywordtype">char</span> tetra_data[];
<a name="l01105"></a>01105 
<a name="l01106"></a>01106     <span class="keyword">static</span> <span class="keywordtype">char</span> enter_tetra1[];
<a name="l01107"></a>01107     <span class="keyword">static</span> <span class="keywordtype">char</span> enter_plane1[];
<a name="l01108"></a>01108     <span class="keyword">static</span> <span class="keywordtype">char</span> enter_tetra2[];
<a name="l01109"></a>01109     <span class="keyword">static</span> <span class="keywordtype">char</span> enter_plane2[];
<a name="l01110"></a>01110 
<a name="l01111"></a>01111 
<a name="l01112"></a>01112 };
<a name="l01113"></a>01113 
<a name="l01152"></a><a class="code" href="classEGS__XYZRepeater.html">01152</a> <span class="keyword">class </span>EGS_NDG_EXPORT <a class="code" href="classEGS__XYZRepeater.html" title="A geometry repeated on a regular XYZ grid.">EGS_XYZRepeater</a> : <span class="keyword">public</span> <a class="code" href="classEGS__BaseGeometry.html">EGS_BaseGeometry</a> {
<a name="l01153"></a>01153 
<a name="l01154"></a>01154 <span class="keyword">public</span>:
<a name="l01155"></a>01155 
<a name="l01156"></a>01156     <a class="code" href="classEGS__XYZRepeater.html" title="A geometry repeated on a regular XYZ grid.">EGS_XYZRepeater</a>(EGS_Float Xmin, EGS_Float Xmax,
<a name="l01157"></a>01157                     EGS_Float Ymin, EGS_Float Ymax,
<a name="l01158"></a>01158                     EGS_Float Zmin, EGS_Float Zmax,
<a name="l01159"></a>01159                     <span class="keywordtype">int</span> Nx, <span class="keywordtype">int</span> Ny, <span class="keywordtype">int</span> Nz, <a class="code" href="classEGS__BaseGeometry.html">EGS_BaseGeometry</a> *G,
<a name="l01160"></a>01160                     <span class="keyword">const</span> <span class="keywordtype">string</span> &amp;Name = <span class="stringliteral">&quot;&quot;</span>);
<a name="l01161"></a>01161 
<a name="l01162"></a>01162     ~<a class="code" href="classEGS__XYZRepeater.html" title="A geometry repeated on a regular XYZ grid.">EGS_XYZRepeater</a>();
<a name="l01163"></a>01163 
<a name="l01164"></a>01164     <span class="keywordtype">int</span> <a class="code" href="classEGS__BaseGeometry.html#af1a37ed6f281a2442a7e96d9658894a9" title="In which region is poisition x?">isWhere</a>(<span class="keyword">const</span> <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> &amp;x) {
<a name="l01165"></a>01165         <span class="keywordtype">int</span> cell = xyz-&gt;isWhere(x);
<a name="l01166"></a>01166         <span class="comment">//egsWarning(&quot;isInside(%g,%g,%g): cell=%d\n&quot;,x.x,x.y,x.z,cell);</span>
<a name="l01167"></a>01167         <span class="keywordflow">if</span>( cell &lt; 0 ) <span class="keywordflow">return</span> cell;
<a name="l01168"></a>01168         <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> xp(x - translation[cell]);
<a name="l01169"></a>01169         <span class="keywordtype">int</span> ir = g-&gt;<a class="code" href="classEGS__BaseGeometry.html#af1a37ed6f281a2442a7e96d9658894a9" title="In which region is poisition x?">isWhere</a>(xp);
<a name="l01170"></a>01170         <span class="comment">//egsWarning(&quot;xp=(%g,%g,%g) ir=%d\n&quot;,xp.x,xp.y,xp.z,ir);</span>
<a name="l01171"></a>01171         <span class="keywordflow">return</span> ir &gt;= 0 ? cell*ng + ir : nreg-1;
<a name="l01172"></a>01172     };
<a name="l01173"></a>01173 
<a name="l01174"></a>01174     <span class="keywordtype">bool</span> <a class="code" href="classEGS__BaseGeometry.html#a816bf2d26bdabc3e4ee2f092bd903d92" title="Is the position x inside the geometry?">isInside</a>(<span class="keyword">const</span> <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> &amp;x) { <span class="keywordflow">return</span> xyz-&gt;isInside(x); };
<a name="l01175"></a>01175 
<a name="l01176"></a>01176     <span class="keywordtype">int</span> <a class="code" href="classEGS__BaseGeometry.html#a15008e08ea330694841fc94b64a7e8d5" title="Returns the region index, if inside, or -1 if outside (obsolete)">inside</a>(<span class="keyword">const</span> <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> &amp;x) { <span class="keywordflow">return</span> <a class="code" href="classEGS__BaseGeometry.html#af1a37ed6f281a2442a7e96d9658894a9" title="In which region is poisition x?">isWhere</a>(x); };
<a name="l01177"></a>01177 
<a name="l01178"></a>01178     <span class="keywordtype">int</span> <a class="code" href="classEGS__BaseGeometry.html#aeae04119c0fa7a94b41627460878bd24" title="Returns the medium index in region ireg.">medium</a>(<span class="keywordtype">int</span> ireg)<span class="keyword"> const </span>{
<a name="l01179"></a>01179         <span class="keywordflow">if</span>( ireg == nreg-1 ) <span class="keywordflow">return</span> <a class="code" href="classEGS__BaseGeometry.html#a9e25deca845a02cb0b7fae1eb06c00d9" title="Medium index.">med</a>;
<a name="l01180"></a>01180         <span class="keywordtype">int</span> cell = ireg/ng; <span class="keywordtype">int</span> ilocal = ireg - ng*cell;
<a name="l01181"></a>01181         <span class="keywordflow">return</span> g-&gt;<a class="code" href="classEGS__BaseGeometry.html#aeae04119c0fa7a94b41627460878bd24" title="Returns the medium index in region ireg.">medium</a>(ilocal);
<a name="l01182"></a>01182     };
<a name="l01183"></a>01183 
<a name="l01184"></a>01184     EGS_Float <a class="code" href="classEGS__BaseGeometry.html#a217bc8dd7706a988acaf97165edb6435">howfarToOutside</a>(<span class="keywordtype">int</span> ireg, <span class="keyword">const</span> <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> &amp;x,
<a name="l01185"></a>01185                               <span class="keyword">const</span> <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> &amp;u) {
<a name="l01186"></a>01186         <span class="keywordflow">if</span>( ireg &lt; 0 ) <span class="keywordflow">return</span> 0;
<a name="l01187"></a>01187         <span class="keywordflow">return</span> xyz-&gt;howfarToOutside(0,x,u);
<a name="l01188"></a>01188     };
<a name="l01189"></a>01189 
<a name="l01190"></a>01190     <span class="keywordtype">int</span> <a class="code" href="classEGS__BaseGeometry.html#a42a459b557011291ea2e8978ebee6295" title="Calculate the distance to a boundary from x along the direction u.">howfar</a>(<span class="keywordtype">int</span> ireg, <span class="keyword">const</span> <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> &amp;x, <span class="keyword">const</span> <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> &amp;u,
<a name="l01191"></a>01191                EGS_Float &amp;t, <span class="keywordtype">int</span> *newmed=0, <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> *normal=0) {
<a name="l01192"></a>01192         <span class="comment">//egsWarning(&quot;\n***howfar(reg=%d,x=(%g,%g,%g),u=(%g,%g,%g),t=%g)\n&quot;,</span>
<a name="l01193"></a>01193         <span class="comment">//        ireg,x.x,x.y,x.z,u.x,u.y,u.z,t);</span>
<a name="l01194"></a>01194         <span class="keywordflow">if</span>( ireg &lt; 0 ) {
<a name="l01195"></a>01195             <span class="comment">// outside of the box.</span>
<a name="l01196"></a>01196             <span class="keywordtype">int</span> cell = xyz-&gt;howfar(ireg,x,u,t,0,normal);
<a name="l01197"></a>01197             <span class="comment">//egsWarning(&quot;entering: cell=%d t=%g\n&quot;,cell,t);</span>
<a name="l01198"></a>01198             <span class="keywordflow">if</span>( cell &gt;= 0 ) {
<a name="l01199"></a>01199                 <span class="keywordflow">if</span>( newmed ) *newmed = <a class="code" href="classEGS__BaseGeometry.html#a9e25deca845a02cb0b7fae1eb06c00d9" title="Medium index.">med</a>;
<a name="l01200"></a>01200                 <span class="keywordflow">return</span> nreg-1;
<a name="l01201"></a>01201             }
<a name="l01202"></a>01202             <span class="keywordflow">return</span> -1;
<a name="l01203"></a>01203         }
<a name="l01204"></a>01204         <span class="keywordflow">if</span>( ireg &gt;= 0 ) {
<a name="l01205"></a>01205             <span class="keywordflow">if</span>( ireg &lt; nreg-1 ) { <span class="comment">// in one of the repetitions</span>
<a name="l01206"></a>01206                 <span class="keywordtype">int</span> cell = ireg/ng; <span class="keywordtype">int</span> ilocal = ireg - cell*ng;
<a name="l01207"></a>01207                 <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> xp(x - translation[cell]);
<a name="l01208"></a>01208                 <span class="keywordtype">int</span> inew = g-&gt;<a class="code" href="classEGS__BaseGeometry.html#a42a459b557011291ea2e8978ebee6295" title="Calculate the distance to a boundary from x along the direction u.">howfar</a>(ilocal,xp,u,t,newmed,normal);
<a name="l01209"></a>01209                 <span class="comment">//egsWarning(&quot;cell=%d il=%d inew=%d t=%g xp=(%g,%g,%g)\n&quot;,</span>
<a name="l01210"></a>01210                 <span class="comment">//        cell,ilocal,inew,t,xp.x,xp.y,xp.z);</span>
<a name="l01211"></a>01211                 <span class="keywordflow">if</span>( inew &gt;= 0 ) <span class="keywordflow">return</span> cell*ng + inew;
<a name="l01212"></a>01212                 <span class="keywordflow">if</span>( newmed ) *newmed = <a class="code" href="classEGS__BaseGeometry.html#a9e25deca845a02cb0b7fae1eb06c00d9" title="Medium index.">med</a>;
<a name="l01213"></a>01213                 <span class="keywordflow">return</span> nreg-1;
<a name="l01214"></a>01214             }
<a name="l01215"></a>01215         }
<a name="l01216"></a>01216         <span class="comment">// if here, we are in the box outside of all repetitions</span>
<a name="l01217"></a>01217         <span class="comment">// find the cell we are in</span>
<a name="l01218"></a>01218         <span class="keywordtype">int</span> ix = (int) (x.<a class="code" href="classEGS__Vector.html#aa67c962f9024c44d15f446c122d25cbf" title="x-component">x</a>*dxi + ax); <span class="keywordflow">if</span>( ix &gt;= nx ) ix = nx-1;
<a name="l01219"></a>01219         <span class="keywordtype">int</span> iy = (int) (x.<a class="code" href="classEGS__Vector.html#a156335a0c0cee0f4c6f6e23aac316350" title="y-component">y</a>*dyi + ay); <span class="keywordflow">if</span>( iy &gt;= ny ) iy = ny-1;
<a name="l01220"></a>01220         <span class="keywordtype">int</span> iz = (int) (x.<a class="code" href="classEGS__Vector.html#a4d45f2e6f756337d6b06b006e04bfc87" title="z-component">z</a>*dzi + az); <span class="keywordflow">if</span>( iz &gt;= nz ) iz = nz-1;
<a name="l01221"></a>01221         <span class="keywordtype">int</span> cell = ix + iy*nx + iz*nxy;
<a name="l01222"></a>01222         <span class="comment">//egsWarning(&quot;in box: ix=%d iy=%d iz=%d\n&quot;,ix,iy,iz);</span>
<a name="l01223"></a>01223         EGS_Float t_left = t; <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> xtmp(x);
<a name="l01224"></a>01224         EGS_Float ttot = 0;
<a name="l01225"></a>01225         <span class="keywordflow">while</span>(1) {
<a name="l01226"></a>01226             EGS_Float this_t = t_left;
<a name="l01227"></a>01227             <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> xp(xtmp - translation[cell]);
<a name="l01228"></a>01228             <span class="keywordtype">int</span> inew = g-&gt;<a class="code" href="classEGS__BaseGeometry.html#a42a459b557011291ea2e8978ebee6295" title="Calculate the distance to a boundary from x along the direction u.">howfar</a>(-1,xp,u,this_t,newmed,normal);
<a name="l01229"></a>01229             <span class="comment">//egsWarning(&quot;cell=%d tleft=%g xp=(%g,%g,%g) inew=%d this_t=%g\n&quot;,</span>
<a name="l01230"></a>01230             <span class="comment">//        cell,t_left,xp.x,xp.y,xp.z,inew,this_t);</span>
<a name="l01231"></a>01231             <span class="keywordflow">if</span>( inew &gt;= 0 ) {
<a name="l01232"></a>01232                 t = ttot + this_t; <span class="keywordflow">return</span> cell*ng + inew;
<a name="l01233"></a>01233             }
<a name="l01234"></a>01234             <span class="keywordtype">int</span> next_cell = xyz-&gt;howfar(cell,xtmp,u,this_t,0,normal);
<a name="l01235"></a>01235             <span class="comment">//egsWarning(&quot;next: %d %g\n&quot;,next_cell,this_t);</span>
<a name="l01236"></a>01236             <span class="keywordflow">if</span>( next_cell == cell ) <span class="keywordflow">return</span> ireg;
<a name="l01237"></a>01237             <span class="keywordflow">if</span>( next_cell &lt; 0 ) {
<a name="l01238"></a>01238                 t = ttot + this_t; <span class="keywordflow">return</span> -1;
<a name="l01239"></a>01239             }
<a name="l01240"></a>01240             ttot += this_t; t_left -= this_t; xtmp += u*this_t;
<a name="l01241"></a>01241             cell = next_cell;
<a name="l01242"></a>01242         }
<a name="l01243"></a>01243     };
<a name="l01244"></a>01244 
<a name="l01245"></a>01245     EGS_Float <a class="code" href="classEGS__BaseGeometry.html#a111e6d8ea34e403bebaf3621223950d9" title="Calculate the distance to a boundary for position x in any direction.">hownear</a>(<span class="keywordtype">int</span> ireg, <span class="keyword">const</span> <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> &amp;x) {
<a name="l01246"></a>01246         <span class="keywordflow">if</span>( ireg &lt; 0 ) <span class="keywordflow">return</span> xyz-&gt;hownear(ireg,x);
<a name="l01247"></a>01247         <span class="keywordflow">if</span>( ireg &lt; nreg-1 ) {
<a name="l01248"></a>01248             <span class="keywordtype">int</span> cell = ireg/ng; <span class="keywordtype">int</span> ilocal = ireg - cell*ng;
<a name="l01249"></a>01249             <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> xp(x - translation[cell]);
<a name="l01250"></a>01250             <span class="keywordflow">return</span> g-&gt;<a class="code" href="classEGS__BaseGeometry.html#a111e6d8ea34e403bebaf3621223950d9" title="Calculate the distance to a boundary for position x in any direction.">hownear</a>(ilocal,xp);
<a name="l01251"></a>01251         }
<a name="l01252"></a>01252         <span class="comment">// if here, we are in the box outside of all repetitions</span>
<a name="l01253"></a>01253         <span class="comment">// find the cell we are in</span>
<a name="l01254"></a>01254         <span class="keywordtype">int</span> ix = (int) (x.<a class="code" href="classEGS__Vector.html#aa67c962f9024c44d15f446c122d25cbf" title="x-component">x</a>*dxi + ax); <span class="keywordflow">if</span>( ix &gt;= nx ) ix = nx-1;
<a name="l01255"></a>01255         <span class="keywordtype">int</span> iy = (int) (x.<a class="code" href="classEGS__Vector.html#a156335a0c0cee0f4c6f6e23aac316350" title="y-component">y</a>*dyi + ay); <span class="keywordflow">if</span>( iy &gt;= ny ) iy = ny-1;
<a name="l01256"></a>01256         <span class="keywordtype">int</span> iz = (int) (x.<a class="code" href="classEGS__Vector.html#a4d45f2e6f756337d6b06b006e04bfc87" title="z-component">z</a>*dzi + az); <span class="keywordflow">if</span>( iz &gt;= nz ) iz = nz-1;
<a name="l01257"></a>01257         <span class="keywordtype">int</span> cell = ix + iy*nx + iz*nxy;
<a name="l01258"></a>01258         <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> xp(x - translation[cell]);
<a name="l01259"></a>01259         EGS_Float t = g-&gt;<a class="code" href="classEGS__BaseGeometry.html#a111e6d8ea34e403bebaf3621223950d9" title="Calculate the distance to a boundary for position x in any direction.">hownear</a>(-1,xp);
<a name="l01260"></a>01260         EGS_Float tcell = xyz-&gt;hownear(cell,x);
<a name="l01261"></a>01261         <span class="keywordflow">if</span>( t &lt; tcell ) <span class="keywordflow">return</span> t;
<a name="l01262"></a>01262         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iix=ix-1; iix&lt;=ix+1; ++iix) {
<a name="l01263"></a>01263             <span class="keywordflow">if</span>( iix &gt;= 0 &amp;&amp; iix &lt; nx ) {
<a name="l01264"></a>01264                 <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iiy=iy-1; iiy&lt;=iy+1; ++iiy) {
<a name="l01265"></a>01265                     <span class="keywordflow">if</span>( iiy &gt;= 0 &amp;&amp; iiy &lt; ny ) {
<a name="l01266"></a>01266                         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> iiz=iz-1; iiz&lt;=iz+1; ++iiz) {
<a name="l01267"></a>01267                             <span class="keywordflow">if</span>( iiz &gt;= 0 &amp;&amp; iiz &lt; nz ) {
<a name="l01268"></a>01268                                 <span class="keywordflow">if</span>( iix != ix || iiy != iy || iiz != iz) {
<a name="l01269"></a>01269                                     <span class="keywordtype">int</span> cell1 = iix+iiy*nx+iiz*nz;
<a name="l01270"></a>01270                                     <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a> tmp(x-translation[cell1]);
<a name="l01271"></a>01271                                     EGS_Float t1 = g-&gt;<a class="code" href="classEGS__BaseGeometry.html#a111e6d8ea34e403bebaf3621223950d9" title="Calculate the distance to a boundary for position x in any direction.">hownear</a>(-1,tmp);
<a name="l01272"></a>01272                                     <span class="keywordflow">if</span>( t1 &lt; t ) t = t1;
<a name="l01273"></a>01273                                 }
<a name="l01274"></a>01274                             }
<a name="l01275"></a>01275                         }
<a name="l01276"></a>01276                     }
<a name="l01277"></a>01277                 }
<a name="l01278"></a>01278             }
<a name="l01279"></a>01279         }
<a name="l01280"></a>01280         <span class="keywordflow">return</span> t;
<a name="l01281"></a>01281     };
<a name="l01282"></a>01282 
<a name="l01283"></a>01283     <span class="keywordtype">int</span> <a class="code" href="classEGS__BaseGeometry.html#a8bc9aebe58a23ed3b6d9f2d4c72265fa" title="Returns the maximum number of steps through the geometry.">getMaxStep</a>()<span class="keyword"> const </span>{
<a name="l01284"></a>01284         <span class="keywordflow">return</span> nxyz*(g-&gt;<a class="code" href="classEGS__BaseGeometry.html#a8bc9aebe58a23ed3b6d9f2d4c72265fa" title="Returns the maximum number of steps through the geometry.">getMaxStep</a>() + 1) + 1;
<a name="l01285"></a>01285     };
<a name="l01286"></a>01286 
<a name="l01287"></a>01287     <span class="keyword">const</span> <span class="keywordtype">string</span> &amp;<a class="code" href="classEGS__BaseGeometry.html#a2df5b0631c3bd57250a6a57cad56323c" title="Get the geometry type.">getType</a>()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> type; };
<a name="l01288"></a>01288 
<a name="l01289"></a>01289     <span class="keywordtype">void</span> <a class="code" href="classEGS__BaseGeometry.html#a90b349e45353ab0b7fa32053a9d37085" title="Print information about this geometry.">printInfo</a>() <span class="keyword">const</span>;
<a name="l01290"></a>01290 
<a name="l01291"></a>01291     <span class="keywordtype">void</span> setXYZLabels(<a class="code" href="classEGS__Input.html" title="A class for storing information in a tree-like structure of key-value pairs. This class is used throu...">EGS_Input</a> *input) {xyz-&gt;setXYZLabels(input); }
<a name="l01292"></a>01292 
<a name="l01293"></a>01293     <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classEGS__BaseGeometry.html#a2e938cb893fb564a3cf4e2141a2173c1" title="Get the list of all regions labeled with str.">getLabelRegions</a> (<span class="keyword">const</span> <span class="keywordtype">string</span> &amp;str, vector&lt;int&gt; &amp;regs);
<a name="l01294"></a>01294 
<a name="l01295"></a>01295 <span class="keyword">protected</span>:
<a name="l01296"></a>01296 
<a name="l01297"></a>01297     <a class="code" href="classEGS__XYZGeometry.html" title="An XYZ-geometry.">EGS_XYZGeometry</a>  *xyz;
<a name="l01298"></a>01298     <a class="code" href="classEGS__BaseGeometry.html">EGS_BaseGeometry</a> *g;
<a name="l01299"></a>01299     <a class="code" href="classEGS__Vector.html" title="A class representing 3D vectors.">EGS_Vector</a>       *translation;
<a name="l01300"></a>01300     EGS_Float        dx, dxi, ax;
<a name="l01301"></a>01301     EGS_Float        dy, dyi, ay;
<a name="l01302"></a>01302     EGS_Float        dz, dzi, az;
<a name="l01303"></a>01303     <span class="keywordtype">int</span>              nx, ny, nz, nxy, nxyz, ng;
<a name="l01304"></a>01304 
<a name="l01305"></a>01305     <span class="keyword">static</span> <span class="keywordtype">string</span>    type;
<a name="l01306"></a>01306 
<a name="l01307"></a>01307 };
<a name="l01308"></a>01308 
<a name="l01309"></a>01309 <span class="preprocessor">#endif</span>
<a name="l01310"></a>01310 <span class="preprocessor"></span>
<a name="l01311"></a>01311 <span class="preprocessor">#endif</span>
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.3 </small></address>
</body>
</html>
